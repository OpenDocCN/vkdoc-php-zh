# 1.PHP:设计和管理

2004 年 7 月，PHP 5.0 发布。这个版本引入了一套激进的增强功能。也许其中第一个是对面向对象编程的彻底改进的支持。这激发了 PHP 社区对对象和设计的兴趣。事实上，这是一个过程的强化，这个过程始于第 4 版首次使 PHP 面向对象编程成为现实。

在这一章中，我看了用对象编码可以解决的一些需求。我非常简要地总结了模式演变和相关实践的一些方面。

我还概述了这本书涵盖的主题。我将查看以下内容:

*   *灾难的演变*:一个项目变坏

*   设计和 PHP:面向对象的设计技术如何在 PHP 社区扎根

*   *本书*:对象、模式、实践

## 问题

问题是 PHP 太简单了。它诱惑你去尝试你的想法，并且用好的结果取悦你。您可以将大部分代码直接写入网页，因为 PHP 就是为了支持这一点而设计的。您将实用函数(如数据库访问代码)添加到可以包含在页面之间的文件中，不知不觉中，您就拥有了一个工作的 web 应用程序。

你正在走向毁灭。当然，你没有意识到这一点，因为你的网站看起来棒极了。它表现很好，你的客户很高兴，你的用户在花钱。

当你回到代码开始一个新的阶段时，麻烦就来了。现在你有了一个更大的团队，更多的用户和更大的预算。然而，在没有警告的情况下，事情开始出错。就好像你的项目中毒了。

你的新程序员正在努力理解对你来说是第二天性的代码，尽管可能有些曲折复杂。作为团队成员，她需要的时间比你预期的要长。

一个简单的改变，估计需要一天，当你发现你必须更新 20 个或更多的网页时，需要三天。

您的一位编码人员保存了他的文件版本，覆盖了您之前对同一代码所做的主要更改。三天后才发现丢失，此时您已经修改了自己的本地副本。整理这些乱七八糟的东西花了一天时间，耽误了第三个也在处理这个文件的开发人员。

由于应用程序的流行，您需要将代码转移到新的服务器上。该项目必须手工安装，并且您发现文件路径、数据库名称和密码被硬编码到许多源文件中。您在移动过程中停止工作，因为您不想覆盖迁移所需的配置更改。估计的两个小时变成了八个小时，因为有人在 Apache 模块 ModRewrite 中做了一些聪明的事情，应用程序现在需要这样才能正常运行。

你终于开始了第二阶段。这一天半一切正常。当您即将离开办公室时，第一份错误报告出现了。客户几分钟后打电话投诉。她的报告与第一份报告相似，但是稍微仔细一点就会发现，这是一个不同的错误导致了类似的行为。您还记得在该阶段开始时的简单变更，这使得在项目的其余部分中需要进行大量的修改。

您意识到并非所有需要的修改都已到位。这要么是因为它们从一开始就被忽略了，要么是因为这些文件在合并冲突中被覆盖了。您匆忙地进行必要的修改来修复错误。您太急于测试更改了，但是它们只是简单的复制和粘贴，那么会有什么问题呢？

第二天早上，您到达办公室，发现一个购物篮模块已经关闭了一整夜。您在最后一刻所做的更改省略了一个前导引号，导致代码不可用。当然，当你在睡觉的时候，其他时区的潜在顾客完全醒着，准备在你的店里花钱。您解决了问题，安抚了客户，并召集团队准备下一天的救火工作。

这个编码人员的日常故事可能看起来有点夸张，但是我已经看到所有这些事情一次又一次地发生。许多 PHP 项目开始时都很小，后来演变成了怪物。

因为表示层还包含应用程序逻辑，所以当数据库查询、身份验证检查、表单处理等等从一页复制到另一页时，复制就开始了。每当需要对这些代码块中的一个进行更改时，必须在发现代码的任何地方进行更改，否则错误肯定会随之而来。

缺少文档会使代码难以阅读，缺少测试会使不明显的错误在部署前无法被发现。客户业务不断变化的性质通常意味着代码会偏离其最初的目的，直到它执行根本不适合它的任务。因为这样的代码经常演变成一个沸腾的、混杂的块，很难(如果不是不可能的话)切换并重写它的一部分来适应新的目的。

如果你是一名自由职业的 PHP 顾问，这些都不是坏消息。评估和修复这样一个系统可以资助昂贵的浓缩咖啡饮料和 DVD 盒六个月或更长时间。然而，更严重的是，这类问题可能意味着一家企业的成败。

## PHP 和其他语言

PHP 惊人的受欢迎程度意味着它的边界很早就经过了严格的测试。正如你将在下一章看到的，PHP 最初是作为一组管理个人主页的宏而诞生的。随着 PHP 3 的出现，以及更大程度上 PHP 4 的出现，这种语言迅速成为大型企业网站背后的成功力量。然而，在许多方面，PHP 的早期遗产一直延续到脚本设计和项目管理中。在某些方面，PHP 保留了业余语言的不公平名声，最适合于演示任务。

大约在这个时候(大约在世纪之交)，新的想法在其他编码社区流行开来。对面向对象设计的兴趣刺激了 Java 社区。由于 Java 是面向对象的语言，你可能认为这是多余的。当然，Java 提供了一种更容易使用的粒度，但是使用类和对象本身并不能决定一种特定的设计方法。

作为一种描述问题的方式，设计模式的概念以及其解决方案的本质在 20 世纪 70 年代首次被讨论。也许恰当地说，这个想法起源于建筑领域，而不是计算机科学，是在 Christopher Alexander 的一部开创性著作中:**模式语言*(牛津大学出版社，1977)。到 20 世纪 90 年代早期，面向对象的程序员使用同样的技术来命名和描述软件设计的问题。Erich Gamma、Richard Helm、Ralph Johnson 和 John Vlissides(在本书中以他们亲切的昵称*四人组*)撰写的关于设计模式的开创性著作*Design Patterns:Elements of Reusable Object-Oriented Software*(Addison-Wesley Professional，1995)，今天仍然是不可或缺的。它所包含的模式是任何一个刚开始涉足这个领域的人所必需的第一步，这也是为什么本书中的大多数模式都是从它而来的。*

 *Java 语言本身在其 API 中部署了许多核心模式，但直到 20 世纪 90 年代末，设计模式才渗透到编码社区的意识中。模式很快感染了主要街道书店的电脑部门，第一次火焰战争开始于邮件列表和论坛。

无论你认为模式是交流工艺知识的一种强有力的方式，还是主要是空话(根据这本书的标题，你可能会猜到我在这个问题上的立场)，很难否认他们鼓励的对软件设计的重视本身是有益的。

相关的话题也越来越突出。肯特·贝克倡导的极限编程(XP)就是其中之一。XP 是一种鼓励灵活的、面向设计的、高度集中的计划和执行的项目方法。

XP 原则中突出的一点是坚持测试对项目的成功至关重要。测试应该自动化，经常运行，最好在目标代码编写之前就设计好。

XP 还规定项目应该被分解成小的(非常小的)迭代。代码和需求都应该被仔细检查。架构和设计应该是一个共享和持续的问题，导致代码的频繁修改。

如果说 XP 是设计运动中好战的一翼，那么我读过的关于编程的最好的书之一就很好地代表了这种温和的倾向:安德鲁·亨特和戴维·托马斯写的《实用程序员:从熟练工到大师》(Addison-Wesley Professional，1999)。

XP 被一些人认为是有点狂热，但是它是二十年来最高水平的面向对象实践的产物，它的原则被广泛地移植。特别是，被称为重构的代码修改被认为是模式的一个强大的附属品。重构自 20 世纪 80 年代以来一直在发展，但它是在马丁·福勒的重构目录中编纂的，*重构:改进现有代码的设计* (Addison-Wesley Professional)，该目录于 1999 年出版并定义了该领域。

随着 XP 和模式的兴起，测试也成了一个热门话题。强大的 JUnit 测试平台的发布进一步强调了自动化测试的重要性，JUnit 测试平台成为 Java 程序员武器库中的关键武器。由肯特·贝克和埃里希·伽马( [`http://junit.sourceforge.net/doc/testinfected/testing.htm`](http://junit.sourceforge.net/doc/testinfected/testing.htm) )撰写的关于这个主题的一篇里程碑式的文章“测试感染:程序员喜欢编写测试”，对这个主题进行了出色的介绍，并且仍然具有巨大的影响力。

PHP 4 大约在这个时候发布，带来了效率的提高，更重要的是，增强了对对象的支持。这些增强使得完全面向对象的项目成为可能。程序员们欣然接受了这个特性，这让 Zend 的创始人 Zeev Suraski 和 Andi Gutmans 有些吃惊，他们加入拉斯马斯·勒德尔夫来管理 PHP 开发。正如你将在下一章看到的，PHP 的对象支持绝不是完美的。但是通过训练和小心使用语法，人们可以真正开始同时考虑对象和 PHP。

然而，像本章开头描述的设计灾难仍然很常见。设计文化还很遥远，在关于 PHP 的书籍中几乎不存在。然而，在网上，人们的兴趣很明显。Leon Atkinson 在 2001 年为 Zend 写了一篇关于 PHP 和模式的文章，Harry Fuecks 在 2002 年在 T2(现已不存在)创办了他的杂志。基于模式的框架项目，如 BinaryCloud，以及自动化测试和文档工具开始出现。

2003 年第一个 PHP 5 测试版的发布确保了 PHP 作为面向对象编程语言的未来。Zend Engine 2 提供了大大改进的对象支持。同样重要的是，它发出了一个信号，即对象和面向对象的设计现在是 PHP 项目的核心。

多年来，PHP 5 不断发展和改进，加入了一些重要的新特性，比如名称空间和闭包。在此期间，它获得了作为服务器端 web 编程最佳选择的声誉。

2015 年 12 月发布的 PHP 7 代表了这一趋势的延续。特别是，它提供了对参数和返回类型声明的支持——这两个特性是许多开发人员(以及本书以前的版本)多年来一直渴望的。还有许多其他特性和改进，包括匿名类、改进的内存使用和提高的速度。这些年来，从面向对象的程序员的角度来看，这种语言逐渐变得更健壮、更干净、更有趣。

在 2020 年 12 月，也就是 PHP 7 发布 5 年后，PHP 8 也将发布。虽然一些实现细节可能会发生变化(在撰写本书期间已经发生了一些变化)，但在撰写本书时(2020 年 8 月)，这些功能已经可用。我在这里详细介绍了其中的许多内容。它们包括对类型声明的改进、简化的属性赋值和许多其他新特性。标题添加的可能是对属性的支持(在其他语言中通常称为注释)。

## 关于这本书

这本书并不试图在面向对象设计领域开辟新的天地；在这方面，它岌岌可危地站在巨人的肩膀上。相反，我在 PHP 的上下文中研究了一些成熟的设计原则和一些关键模式(特别是那些在经典的四人组书籍*设计模式*中提到的)。最后，我超越了代码的严格限制，着眼于有助于确保项目成功的工具和技术。除了这个介绍和一个简短的结论，这本书分为三个主要部分:对象、模式和实践。

### 目标

我在第 1 部分开始时快速回顾了 PHP 和对象的历史，绘制了它们从 PHP 3 的事后想法到 PHP 5 的核心特性的转变。

即使你对对象知之甚少或者一无所知，你仍然可以成为一名有经验的成功的 PHP 程序员。出于这个原因，我从基本原则开始解释对象、类和继承。即使在这个早期阶段，我也看到了 PHP 5、PHP 7 和 PHP 8 引入的一些对象增强。

基础知识建立之后，我会更深入地研究我们的主题，研究 PHP 更高级的面向对象特性。我还专门用一章来介绍 PHP 提供的帮助您处理对象和类的工具。

然而，仅仅知道如何声明一个类并使用它来实例化一个对象是不够的。您必须首先为您的系统选择合适的参与者，并决定他们交互的最佳方式。这些选择比关于对象工具和语法的简单事实更难描述和学习。我以对 PHP 面向对象设计的介绍结束了第 1 部分。

### 模式

模式描述了软件设计中的一个问题，并提供了解决方案的核心。这里的“解决方案”不是指你可能在食谱中找到的那种剪切和粘贴代码(尽管食谱对程序员来说是很好的资源)。相反，设计模式描述了一种可以用来解决问题的方法。可能会给出一个示例实现，但它没有它用来说明的概念重要。

第 2 部分从定义设计模式和描述它们的结构开始。我也研究了它们流行背后的一些原因。

模式倾向于促进和遵循某些核心设计原则。理解这些可以帮助分析一个模式的动机，并且可以有效地应用于所有的编程。我讨论其中的一些原则。我还研究了统一建模语言(UML)，这是一种独立于平台的描述类及其交互的方式。

虽然这本书不是一个模式目录，但是我研究了一些最著名和最有用的模式。我描述了每个模式解决的问题，分析了解决方案，并给出了一个 PHP 实现示例。

### 实践

如果管理不当，即使是完美平衡的架构也会失败。在第 3 部分中，我将介绍可用来帮助您创建确保项目成功的框架的工具。如果本书的其余部分是关于设计和编程的实践，那么第 3 部分是关于管理代码的实践。我所研究的工具可以形成一个项目的支持结构，有助于在错误发生时跟踪它们，促进程序员之间的协作，并提供安装的便利性和代码的清晰性。

我已经讨论了自动化测试的力量。我从介绍性的一章开始第 3 部分，概述了这个领域的问题和解决方案。

许多程序员对屈服于自己做所有事情的冲动感到内疚。Composer 和它的主存储库 Packagist 一起，提供了对数千个依赖项管理包的访问，这些包可以轻松地缝合到项目中。我研究了自己实现一个特性和部署一个 Composer 包之间的权衡。

当我在谈论 Composer 时，我会看看安装机制，它使包的部署像一个命令一样简单。

代码是关于协作的。这一事实可能是有益的。这也可能是一场彻底的噩梦。Git 是一个版本控制系统，它使许多程序员能够在同一个代码库上一起工作，而不会覆盖彼此的工作。它可以让您在开发的任何阶段抓取项目的快照，查看谁做了哪些更改，并将项目拆分为可合并的分支。Git 总有一天会拯救你的项目。

当人们和库合作时，他们通常会带来不同的惯例和风格。虽然这是健康的，但它也会破坏互操作性。像*符合*和*符合*这样的词让我不寒而栗，但不可否认的是，互联网的创造力是由标准支撑的。通过遵守某些惯例，我们可以自由地在一个难以想象的大沙盒中玩耍。因此，在新的一章中，我探索 PHP 标准，它们如何帮助我们，以及我们应该如何以及为什么，是的，*遵从*。

两个事实似乎是不可避免的。首先，bug 经常在代码的同一个区域重复出现，使得一些工作日就像是一场似曾相识的练习。第二，改进带来的破坏往往和它们修复的一样多，甚至更多。自动化测试可以解决这两个问题，为代码中的问题提供早期预警系统。我将介绍 PHPUnit，这是一个强大的 xUnit 测试平台实现，最初是为 Smalltalk 设计的，但现在已经移植到许多语言，特别是 Java。我特别关注 PHPUnit 的特性，以及测试的好处和一些成本。

申请很乱。他们可能需要将文件安装在非标准位置，或者想要设置数据库，或者需要修补服务器配置。简而言之，应用程序需要在安装过程中完成*填充*。Phing 是一个名为 Ant 的 Java 工具的忠实端口。Phing 和 Ant 解释一个构建文件，并按照您告诉他们的任何方式处理您的源文件。这通常意味着将它们从源目录复制到系统中的各个目标位置，但是，随着您的需求变得更加复杂，Phing 可以毫不费力地进行扩展来满足它们。

一些公司实施开发平台——但是在许多情况下，团队最终运行一系列不同的操作系统。承包商挥舞着笔记本电脑到达(你好，Paul Tregoing，第五版和当前版本的技术编辑)，一些团队成员没完没了地宣传他们最喜欢的 Linux 发行版(那是我和我的 Fedora)，许多人坚持要另一个性感的 PowerBook(在咖啡馆和会议室使用它根本不会让你看起来像是时髦的 Borg 大军中的另一个节点)。所有这些都可以不同程度地轻松运行灯堆栈。不过，理想情况下，开发人员应该在非常类似于最终产品系统的环境中运行他们的代码。我研究了一个应用程序，它使用了虚拟化技术，这样团队成员可以保留他们特有的开发平台，但在类似生产的系统上运行项目代码。

测试和构建都很好，但是您必须安装并运行您的测试，并且为了获得收益而继续这样做。如果您不自动化您的构建和测试，很容易变得自满和放任自流。我看到了一些被归入“持续集成”类别的工具和技术，它们将帮助您做到这一点。

### 第六版有什么新内容

PHP 是一门活的语言，正因为如此，它处于不断的回顾和发展之中。这个新版本，也已经过审查和彻底更新，以考虑到变化和新的机会。

我将介绍一些新特性，比如属性和对类型声明的许多增强。示例在适当的地方使用了 PHP 8 的特性，所以请注意，您经常需要针对 PHP 8 解释器运行代码——或者准备做一些降级工作。

## 摘要

这是一本关于面向对象设计和编程的书。它也是关于从协作到部署管理 PHP 代码库的工具。

这两个主题从不同但互补的角度论述了同一个问题。主要目标是构建实现其目标的系统，并很好地进行协作开发。

第二个目标在于软件系统的美观。作为程序员，我们建造有形状和动作的机器。我们在工作日投入了很多时间，在生活中投入了很多时间，写出了这些形状。我们希望我们构建的工具，无论是单独的类和对象，软件组件，还是最终产品，都能形成一个优雅的整体。版本控制、测试、文档和构建的过程不仅仅支持这个目标:它是我们想要实现的形状的一部分。就像我们想要干净和聪明的代码一样，我们想要一个为开发者和用户都设计好的代码库。共享、阅读和部署项目的机制应该和代码本身一样重要。*