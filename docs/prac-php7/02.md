# 2.创建与用户互动的网页

本章将演示如何将一个简单的数据库链接到一个网页上，这样网页就可以与用户交互。公众可以访问网站，但不能访问数据库结构或表格中的数据。他们将不被允许查看受保护的页面，例如会员专用页面，因为他们在注册之前没有密码。但是，网站设计者必须为用户提供一种与数据库交互的方式，以便注册成为会员、搜索数据库和更改密码。PHP 语言和 SQL 代码将提供解决方案。

完成本章后，您将能够

*   为网站创建数据库和模板

*   理解和使用 PHP 包含函数

*   了解服务器如何处理 PHP 页面

*   创建交互式模板页面

*   创建 mysqli 代码来连接数据库

*   为组织成员创建注册页面

*   理解并使用 PHP echo()语句

*   创建粘性表单

*   使用简单数组

*   创建显示成员记录的表单

*   创建哈希密码的代码

对于我们的交互式 web 页面，我们将使用 simpledb 数据库和以前项目中的 users 表。请注意，本教程既不实用也不安全。它是后续章节中描述的更安全、更雄心勃勃的项目的垫脚石。实际上，您永远不会允许普通成员查看成员列表。该项目的互动要素如下:

*   用户可以通过在屏幕上显示的表格中插入他们的详细信息来注册成为会员。注册细节将被输入到数据库表中，并可由管理员用来发送定期通讯给成员。

*   注册用户可以更改他们的密码。

*   用户可以查看成员列表(仅限于此项目)。在后面的章节中，这个功能将只对网站管理员和会员秘书开放。

使这个例子不适合真实世界的特征如下:

*   没有规定注册成员随后登录进入一个特殊的部分或页面。这将在第 [3](03.html) 章中讨论。

*   用户应该永远不能访问成员的详细信息表。

*   在这个早期阶段，为了简单起见，提供了对用户信息的有限过滤。因此，该表可能包含错误的数据和伪造的电子邮件地址。

*   仅在本章中，任何知道成员的电子邮件地址和旧密码的用户都可以更改成员的密码。

所有这些安全问题将在后面的章节中讨论。尽管有缺点，该项目将为您提供编码和测试页面的宝贵实践。您还将学习更多的数据库术语和一些基本的 PHP 代码。

## 创建用于保存数据库页面的文件夹

在 XAMPP 的 *htdocs* 文件夹或者 easyPHP 的 *eds-www* 文件夹中，新建一个名为 *simpledb* 的子文件夹。本章中创建的所有页面都将放在 simpledb 文件夹中。您可以选择从提供的清单中手工编码文件，或者将书的代码加载到 simpledb 文件夹中。(你可以从 [Apress 下载代码。com](http://apress.com) 。)我们建议您手工编写本章的程序；这些文件很小，创建时间不会太长。如果您键入并测试代码，您将会学到更多并学得更快，尤其是当您犯了错误并学会纠正它们时。

## 创建临时模板

显然，交互式数据库的某些方面必须是用户可以访问的。这意味着将它整合到现实世界的网页中。我们将把我们的网页命名为*template.php*(如图 [2-1](#Fig1) )。正如您所看到的，有一个主标题、一些正文、左侧的导航侧栏、右侧的信息栏和页面底部的页脚。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig1_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig1_HTML.jpg)

图 2-1

模板

在清单 [2-1](#PC1) 中，head 部分包含 DOCTYPE、页面标题和到 Bootstrap 样式表的链接。页面的主体包含一些 PHP 代码，这将在清单的最后一步一步解释。

因为文件包含 PHP 代码(不管有多少)，所以文件以文件类型*保存。php* 。

```
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Template for an interactive web page</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS File  -->
  <link rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
  integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
  crossorigin="anonymous">
</head>

<body>
<div class="container" style="margin-top:30px">

<!-- Header Section                                                                 #1-->
<header class="jumbotron text-center row"
style="margin-bottom:2px; background:linear-gradient(white, #0073e6);padding:20px;">
  <?php include('header-for-template.php'); ?>
</header>

<!-- Body Section                                                                   #2-->
  <div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
  <nav class="col-sm-2">
      <ul class="nav nav-pills flex-column">
        <?php include('nav.php'); ?>
      </ul>
  </nav>

<!-- Center Column Content Section -->
  <div class="col-sm-8">
     <h2 class="text-center">This is the Home Page</h2>
        <p>The home page content. The home page content. The home page content. The home page content. <br>
        The home page content. The home page content. The home page content. The home page content. <br>
        The home page content. The home page content. <br>
        The home page content. The home page content. The home page content. </p>
  </div>

<!-- Right-side Column Content Section                                              #3-->
   <aside class="col-sm-2">
       <php include('info-col.php'); ?>
   </aside>
 </div>

<!-- Footer Content Section                                                         #4-->
<footer class="jumbotron text-center row"
style="padding-bottom:1px; padding-top:8px;">
  <?php include('footer.php'); ?>
</footer>
</div>
</body>
</html>

Listing 2-1Creating a Template for the Project (template.php)

```

### 注意

标签让服务器知道 PHP 代码在哪里结束。服务器会将这些标签之间的任何代码传递给 PHP 解释器来执行。标签之外的代码，HTML 和 JavaScript 代码，最终将被发送到用户的浏览器，不做任何处理。

清单 [2-1](#PC1) 中显示的 PHP 代码包含 include()函数，现在将对其进行解释。(严格来说，include()函数是一个 PHP 语言构造，但区别很小，为了简单起见，我们将继续称它为函数。)

## PHP include()函数简介

你会注意到清单 [2-1](#PC1) 中似乎没有足够的代码来创建图 [2-1](#Fig1) 中显示的页面。原因如下。

在清单 [2-1](#PC1) 中的标记之间显示的四段 PHP 代码都将一个额外的文件拖入页面。该页面由五个文件组成:一个主文件和四个外部文件。使用 PHP include()函数将四个外部文件拉入模板页面。

对于更新和维护网站来说，include()函数是一个非常好的省时工具。假设您有一个 40 页的客户端网站，每个页面都需要相同的菜单按钮块。如果您的客户要求您添加或删除一个菜单按钮，通常您将不得不修改 40 个页面来添加或删除每个页面上的按钮。使用 include()函数，您可以设计网站，使每个页面都包含这一行 PHP 代码:。这将把菜单按钮块拉进每个网页。你可以在另一个名为*menu.php*的文件中设计按钮块。要向所有 40 个页面添加一个新按钮，只需将新按钮添加到名为*menu.php*的文件中。

### 注意

PHP 函数是一个微小的程序，它将执行特定的任务。include()函数获取括号中的内容，并将其放入页面中 include()函数所在的位置。PHP 有两个类似的函数:include()和 require()。它们都将文件拖入页面，以便该文件包含在显示的页面中。区别在于他们对丢失或有问题的文件的反应方式。如果要包含的文件丢失或损坏，include()不会暂停页面的执行。将出现警告，但页面将继续加载。相反，如果 require()找不到文件或者文件有问题，就会出现错误。在这种情况下，页面将停止执行。使用 include()来处理任何对网页正常处理来说不是绝对必要的内容。在这个例子中，没有合适的标题，页面仍然可以运行。但是使用 require()来加载数据库的详细信息，因为如果数据库无法打开，这个页面就没什么用了。此外，PHP 还有 include_once()和 require_once()函数。这两个函数将确定该文件之前是否已经被包含。如果文件之前已经被包含，include_once()将不会执行，没有抱怨。require_once()不会再次加载已经加载过的文件。

要放入页面的四个元素是标题、菜单按钮块、右侧的信息面板和页脚。包含的文件可以是任何类型——例如，一个. *txt* 文件，一个*。php* 文件，或者一个*。html* 文件。请注意，您选择的文件类型会影响文件中的代码是否可以从外部查看。HTML 文件可以很容易地在浏览器中查看。但是，不要依赖文件结尾的类型来判断文件是否应该受到保护。确保您的代码位于安全的文件夹中。include()语句可以放在 HTML 页面中的任何地方，只要它被 PHP 标记包围；这些以标签<开头？php 并以标签结束？>。下一节将详细介绍四个包含的外部文件。

你可能也想知道为什么我们不使用内容管理系统(CMS ),比如 WordPress，来组装和显示我们的页面。首先，这不是一本 CMS 书，其次，你实际上是在学习 CMS 系统是如何工作的。它们以相似的方式组合页面。一些 CMS 系统是用 PHP 创建的。

### 包含的头文件

图 [2-2](#Fig2) 显示了包含的头文件。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig2_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig2_HTML.jpg)

图 2-2

模板的标题

这个标题是临时的。当我们创建模板的交互式版本时，新的标题将包含一个附加菜单，以便用户可以注册，从而将他们的详细信息插入 simpledb 数据库。

### 警告

现在还不要试图创建四个非交互式页面(*page-2.php*、【page-3.php、*page-4.php*和*page-5.php*)，因为在本章的后面，这些页面将需要一个新版本的页眉。

```
<!-- Header Section                                                                 #1-->
<header class="jumbotron text-center row"
   style="margin-bottom:2px; background:linear-gradient(white, #0073e6); padding:20px;">
   <?php include('header-for-template.php'); ?>
</header>

Listing 2-2aHeader Section of Template File (template.php)

```

清单 [2-2a](#PC2) 中的 PHP 语句将 *header-for-template* 文件的内容导入页面(代码如清单 [2-2b](#PC3) 所示)。此外，引导 CSS 代码被导入到模板文件的 head 部分(参见清单 [2-1](#PC1) 的顶部)。使用 Bootstrap，我们可以减少开发的 CSS 数量，并自动创建适应多种屏幕尺寸(包括智能手机)的页面。Bootstrap jumbotron 类产生一个大盒子，用于显示重要信息(如标题)。我们还将文本居中，并将标题声明为一行。引导行由网格控制。每一行都被分成单元格，以帮助页面布局。这类似于电子表格中的单元格和行。我们将确定清单 [2-2b](#PC3) 中标题的每一列使用的单元格数量。我们对大屏幕的默认设置做了一些调整，减少了下边距(2px)，将背景更改为渐变(白色到蓝色)，并更改了填充(20px)。清单 [2-2b](#PC3) 包含了临时头的代码。

```
<div class="col-sm-2">
<img class="img-fluid float-left" src="logo.jpg" alt="Logo">
</div>
<div class="col-sm-8">
 <h1 class="font-bold">Header Goes Here</h1>
</div>

Listing 2-2bCode for the Temporary Header (header-for-template.php)

```

在清单 [2-2a](#PC2) 中，header 标签中引用了 class 行。这允许我们用列来设计引导行的样式。在清单 [2-2b](#PC3) 中。我们创建两列:一列保存徽标，另一列保存标题文本。徽标列使用两个小单元格(col-sm-2)，标题文本使用八个小单元格(col-sm-8)。img 标签还包括一个 img-fluid 类，以及 float-left 类，它允许引导代码在较小的设备上调整图像的大小。标题文本也被加粗(字体加粗)。

这本书假设你有一些 CSS 和 Bootstrap 编程知识。我们将在每章和附录中提供一些链接，以提供额外的资源。然而，一个很好的学习方法是调整现有的代码，看看它如何影响布局。您可能需要花几分钟时间来调整这个示例和下面的示例，看看它们将如何改变 web 页面的布局。

### 注意

我们选择使用 Bootstrap 来减少我们必须演示的 CSS 代码量。Bootstrap 是一个开源工具包，包括 HTML、CSS 和 JavaScript。这个工具包提供了一个响应式网格系统和预构建的 CSS/JS 组件。使用 Bootstrap，开发人员可以在 HTML、CSS 和 JavaScript 编码上花费更少的时间，而在编程(使用 PHP)上花费更多的时间。

在本书中，我们将使用 Bootstrap 类来提供网页的多平台格式。工具包可以直接在线链接(如我们在示例中所做的那样)或从 Bootstrap 网站下载。您可以使用 CSS 调整许多工具包组件的默认设置。如果您不熟悉 Bootstrap，我们建议您查看并参考以下站点以了解更多信息:

[T2`www.getboostrap.com`](http://www.getboostrap.com)

[T2`https://www.w3schools.com/bootstrap/bootstrap_get_started.asp`](https://www.w3schools.com/bootstrap/bootstrap_get_started.asp)

### 包含的菜单文件

图 [2-3](#Fig3) 显示了包含的菜单按钮块。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig3_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig3_HTML.jpg)

图 2-3

包含的菜单按钮

清单 [2-3a](#PC4) 给出了模板页面中菜单的 HTML 代码。

```
<!-- Body Section                                                                      #2-->
  <div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
  <nav class="col-sm-2">
      <ul class="nav nav-pills flex-column">
       <?php include('nav.php'); ?>
      </ul>
  </nav>

Listing 2-3aNavigation Menu of Template File (template.php)

```

与页眉类似，页面的主体部分定义了一行。一行有三列。左栏(col-sm-2)为导航菜单保留了两个单元格。菜单将以“药丸”格式显示(见图 [2-3](#Fig3) ),并且对于不同的设备尺寸是灵活的。一条 PHP 语句导入 nav.php 的*文件，该文件包含链接的实际代码清单(参见清单 [2-3b](#PC5) )。*

```
  <li class="nav-item">
          <a class="nav-link active" href="index.php">Home</a>
  </li>
  <li class="nav-item">
          <a class="nav-link" href="page-2.php">Page 2</a>
   <li>
   <li class="nav-item">
          <a class="nav-link" href="page-3.php">Page 3</a>
   </li>
   <li class="nav-item">
          <a class="nav-link" href="page-4.php">Page 4</a>
   </li>
   <li class="nav-item">
          <a class="nav-link" href="page-5.php">Page 5</a>
     </li>

Listing 2-3bThe Navigation Menu (nav.php)

```

导航部分(菜单)的代码包括一个无序列表，该列表中有指向网站每个未来页面的链接。这是用无序列表创建菜单的常见做法。每个列表项都定义了一个类 nav-item，Bootstrap 使用它来格式化菜单。每个链接( [2-3](#Fig3) )。还有一个使菜单项变灰的 deactive 类。

### 包含的信息列

包含信息栏位于页面右侧，如图 [2-4](#Fig4) 所示。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig4_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig4_HTML.jpg)

图 2-4

模板中包含的信息列

清单 [2-4a](#PC6) 给出了模板文件中信息列的 HTML 代码。

```
<!-- Right-side Column Content Section                                                 #3-->
   <aside class="col-sm-2">
         <php include('info-col.php'); ?>
   </aside>

Listing 2-4aInformation Column in Template File (template.php)

```

信息栏保留两个小单元格用于显示(col-sm-2)。PHP include 语句从*info-col.php*获取信息列的细节(参见清单 [2-4b](#PC7) )。

```
<div>
<h3>This is the information column</h3>
        <p>Web design by <br>A W West and<br>Steve Prettyman</p>
</div>

Listing 2-4bThe Information Column Details (info-col.css)

```

清单 [2-4b](#PC7) 包括在页面右侧显示信息的 HTML 代码。信息移动到右侧，因为在定义信息列之前，菜单和页面的主要部分(稍后讨论)首先用列和单元格定义。

### 包含的页脚文件

图 [2-5](#Fig5) 显示了包含的页脚。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig5_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig5_HTML.jpg)

图 2-5

模板中包含的页脚

清单 [2-5a](#PC8) 给出了页脚的 HTML 代码。

```
<!-- Footer Content Section                                                            #4-->
<footer class="jumbotron text-center row"
style="padding-bottom:1px; padding-top:8px;">
  <?php include('footer.php'); ?>
</footer>

Listing 2-5aFooter code for Template File (.php)

```

页脚也被声明为一个超大屏幕和一行。文本居中(文本居中)。此外，超大屏幕的默认设置被调整为减小块大小，以更适合页脚。PHP 代码获取要显示的 HTML(参见清单 [2-5b](#PC9) )。

```
<p class="h6 col-sm-12">Copyright &copy; Adrian West & Steve Prettyman 2018  Designed by
<a href="http://www.colycomputerhelp.co.uk/">Adrian West </a> and
<a href=http://www.littleoceanwaves.com>Steve Prettyman </a>  Valid
<a href="http://jigsaw.w3.org/css-validator/">CSS</a> &amp;
<a href="http://validator.w3.org/">HTML5</a></p>

Listing 2-5bThe Footer (footer.php)

```

清单 [2-5b](#PC9) 使用 Bootstrap 类 h6 来确定用于显示文本的字体属性。段落标记还保留了 12 个小列(页面的完整宽度)来显示页脚信息。

#### 服务器如何处理页面？

当 HTML 文件保存为 PHP 文件时，*。php* 扩展提醒服务器像平常一样处理 HTML，但是也寻找任何 php 代码。默认情况下，服务器处于 HTML(复制)模式，任何 HTML 代码都照常发送到浏览器。它什么时候找到了<？php 标签，服务器切换到 PHP(解释)模式。任何 PHP 代码都被解释。执行解释的 PHP 代码的结果被返回到页面，而不是实际的 PHP 代码本身。它继续以这种模式运行，直到遇到 PHP 结束标记？>；然后切换回 HTML(复制)模式。这种循环行为一直持续到代码页的末尾。

## 模板的交互式版本

在这个版本的模板中，我们将通过创建一个带有附加菜单的新头文件来引入交互性。该菜单将允许用户注册并将他们的详细信息输入 simpledb 数据库。它还允许用户更改他们的密码和查看成员表。

图 [2-6](#Fig6) 显示了新的割台。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig6_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig6_HTML.jpg)

图 2-6

标题中会添加一个注册菜单

交互式元素将嵌入标题中；因此，前面的标题现在被修改为包含一个菜单。新的表头将被命名为*header.php*，代码如清单 [2-6](#PC10) 所示。

```
<div class="col-sm-2">
<img class="img-fluid float-left" src="logo.jpg" alt="Logo">
</div>
<div class="col-sm-8">
 <h1 class="blue-text mb-4 font-bold">Header Goes Here</h1>
 </div>
     <nav class="col-sm-2">
         <div class="btn-group-vertical btn-group-sm" role="group" aria-label="Button Group">
  <button type="button" class="btn btn-secondary" onclick="location.href = 'register-page.php'" >
                   Register</button>
  <button type="button" class="btn btn-secondary" onclick="location.href = 'register-view_users-page.php'">
                  View Users</button>
<button type="button" class="btn btn-secondary" onclick="location.href = 'register-password.php'" >
                  New Password</button>
</div>
    </nav>

Listing 2-6Placing a Registration Menu in the New Header (header.php)

```

在本例中，创建了一个引导垂直按钮组(btn-group-vertical ),其中包含一些小按钮(btn-group-sm)。该组中的每个按钮都用 HTML 按钮标签和 Bootstrap btn 和 btn-secondary 类来定义。点击属性用于调用用户请求的页面。在后面的章节中，我们还会看到使用引导导航条在标题下创建水平按钮栏的例子。

在模板文件中，我们需要用新的头替换以前包含的头。新的模板页面将被命名为*index.php*，它现在有两块菜单按钮，如图 [2-7](#Fig7) 所示。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig7_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig7_HTML.jpg)

图 2-7

带有两个菜单的新主页模板

旧模板和新索引文件之间代码的唯一区别是新的头引用。清单 [2-7](#PC11) 中的代码片段显示了这些变化。完整的代码包含在 index.php 的*文件中，可以从[网站下载。com](http://apress.com) 网站。*

```
<!-- Header Section -->
<header class="jumbotron text-center row"
    style="margin-bottom:2px; background:linear-gradient(white, #0073e6); padding:20px;">
    <?php include('header-for-template.php'); ?>
</header>

Listing 2-7Including the New Header in the Home Page (index.php)

```

现在你可以创建四个普通的网页，使用新的模板(*index.php*)；文件保存四份，分别命名为 page-2.php*、**、*、*、*、*。稍微改变一下这些页面的内容，使它们不同于*index.php*，并指出用户正在查看的页面。您可能会考虑将活动的导航项目(按钮)更改为当前正在查看的页面。前面显示的代码将主页导航按钮设置为活动状态。*

## 连接到数据库

在我们可以在数据库中做任何事情之前，我们必须连接到它。这是通过创建一个名为 *mysqli_connect.php* 的连接文件来实现的。下一个代码片段给出了连接文件的代码。

连接到数据库的代码片段清单(mysqli_connect.php)

```
<?php
// This file provides the information for accessing the database.and connecting to MySQL.
// First, we define the constants:                                                     #1
Define ('DB_USER', 'horatio'); // or whatever userid you created
Define ('DB_PASSWORD', 'Hmsv1ct0ry'); // or whatever password you created
Define ('DB_HOST', 'localhost');
Define ('DB_NAME', 'simpledb');

// Next we assign the database connection to a variable that we will call $dbcon:      #2
try
{
      $dbcon = new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);
      mysqli_set_charset($dbcon, 'utf8'); //                                           #4
      // more code will go here later
}
catch(Exception $e) // We finally handle any problems here                             #3
{
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
}
catch(Error $e)
{
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
}
?>

```

将文件另存为 *mysqli_connect.php* ，并将其放在 XAMPP *htdocs* 或 easyPHP *eds-www* 文件夹中。

### 注意

当数据库设置在远程主机上时，为了安全起见，该文件被放置在根文件夹的上一级。不保护该文件会导致 DOS 攻击。将该文件放在 web 服务器的公共区域将允许任何人使用该代码访问数据库。将文件放在程序代码的上一层，放在 web 服务器保护的区域中(或另一个安全文件夹中)。使用类似 require('的 require 语句../MySQL connect . PHP’)；访问您的连接信息。本书中的示例从与代码文件相同的位置访问连接文件。这样做是为了便于测试，但不应该在公开可访问的 web 服务器上的真实环境中进行。

在本书中，catch 消息用于调试。实时网站不应该向用户显示错误消息。应该向用户显示一条通用消息(如前面的清单所示)。比起显示错误信息的网站，用户更愿意回到当前“繁忙”的网站。这些错误消息也可能是一个安全漏洞，因为可能会显示可能导致错误的代码行。

### 代码的解释

*mysqli_connect.php* 文件包含一些您可能不熟悉的代码约定，所以让我们在这里简单地浏览一下。

单行注释以双正斜杠或哈希符号开头，例如:

```
// more code will go here later
# more code will go here later

```

常量是使用关键字`DEFINE`创建的固定定义。

```
DEFINE ('DB_USER', 'horatio');

```

像`$dbcon`这样的变量是用于包含可以改变的信息的记忆存储设备；它们前面有一个美元符号。使用以下格式创建变量:$var = some_information。等号叫做*赋值运算符*；它将等号右边的值赋给左边的变量。该示例将一些信息分配给变量$var。

我们现在将使用行号作为参考来检查代码。

```
// First, we define the constants:                                                     #1
Define ('DB_USER', 'horatio'); // or whatever userid you created
Define ('DB_PASSWORD', 'Hmsv1ct0ry'); // or whatever password you created
Define ('DB_HOST', 'localhost');
Define ('DB_NAME', 'simpledb');

```

作为惯例，而不是规则，程序员创建的常量名称都是大写字母。这有助于识别哪些项是常量(程序运行时不能更改)，哪些项是变量(程序运行时可以更改)。在 PHP 中，如果一个项目的第一个字符是美元符号，我们也可以知道它是一个变量。将定义代码行放在程序代码的顶部附近是一个很好的做法。这使得您很容易找到何时必须更改某个值。例如，如果您需要更改税率。

### 注意

如果没有为 simpledb 数据库创建用户 id 和密码，用户 ID 将是 root，密码将是" "(两个引号，中间没有空格)。

```
// Next we assign the database connection to a variable that we will call $dbcon:      #2
try
{
      $dbcon = new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);
      // more code will go here later
}

```

美元符号后面的文本可以是与存储器中保存的信息相关的任何内容。例如，清单中用于连接数据库的变量名为$dbcon。这被选择来表示到数据库的连接；它可以是$connect_db 或任何其他表示数据库连接的文本。一些程序员喜欢使用 camel case ($dbCon)，其中第一个单词是小写的，后面的任何单词都以大写字母开头。其他人保持所有单词小写，有些人甚至在单词之间使用下划线(_)($ db _ con)。你使用什么风格并不重要。保持一致，用相同的风格命名变量。

我们使用之前定义的主机、用户名、密码和数据库名称来连接数据库。

try 块(在{ }之间的所有内容都被认为是在一个块中)将把任何问题(错误或异常)都“抛出”到 catch 块中，供程序处理。

```
catch(Exception $e) // We finally handle any problems here                             #3
{
      //print "An Exception occurred. Message: " . $e->getMessage();
      print "The system is busy please try later";
}
catch(Error $e)
{
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
}

```

出于测试目的，有时我们会显示可能出现的错误和异常消息。在生产中，我们会将打印语句替换为给用户的通用消息，例如“系统当前不可用，请稍后再试。”允许用户看到错误信息会给他们一种感觉，你的网站设计很差，很脆弱，经常会崩溃。在网站上看到错误信息的用户通常会离开网站，并且不再返回。然而，在今天的环境中，常见的“系统当前繁忙或不可用”类型的消息并不罕见。许多网站现在限制用户数量，以防止黑客试图淹没和破坏网站。

让用户看到任何错误消息也是一个主要的安全漏洞。这些消息可能会泄露提供项目实际位置的代码，例如数据库本身。这些信息以及时间戳应该被传递到一个日志文件中，以帮助系统管理员。

您可能会在互联网或较旧的书籍中看到使用或 die 的 PHP 数据库代码的示例代码。从一开始，这就是 PHP 的标准。然而，随着 PHP 7 的发布，设计者鼓励所有开发人员使用行业标准的 try/catch 格式。此外，当使用或 die 时，您无法捕获所有异常和错误。使用 try/catch，您现在可以这样做。在 PHP 7 中，开发人员被鼓励使用 mysqli(而不是 mysql)方法来连接和访问数据库。这被认为是最安全的访问方法。

我们已经将 HTML 编码的语言从默认的改为 utf-8，如清单 [2-8](#PC19) 所示。到数据库的连接还必须包括指示正确编码语言的代码。HTML 页面上使用的编码语言类型必须与数据库表中使用的编码语言相匹配。不一致的匹配可能会导致问题，包括无效的搜索结果。

```
mysqli_set_charset($dbcon, 'utf8');                                                    #4

```

(请注意，这种格式不同于 HTML 文档中的代码集，因为它不像 utf-8 那样包含连字符。)

接下来，我们需要一些页面来调用标题的新菜单。这些页面将包含互动功能。这些页面将允许用户注册，允许用户查看已注册人员的表格，并允许更改密码。

### 注册页面

### 警告

当您最终将数据库迁移到远程主机时，请确保遵守您所在地区或国家的数据保护法，并在注册页面上明确声明用户的个人详细信息不会被共享或出售给其他组织。保护数据的规则因国家而异，您必须阅读并遵守这些规则。通常，组织内任何可以访问用户详细信息的人都必须签署一份文件，同意永远不共享个人信息。管理数据保护法的政府机构可能需要缴纳年度注册费。这些预防措施不适用于使用本书中描述的虚构数据的实验数据库。

注册页面允许用户将他们的个人信息直接输入到数据库的表格中。图 [2-8](#Fig8) 显示了该界面。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig8_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig8_HTML.jpg)

图 2-8

注册页面

当用户点击新标题上的注册菜单按钮时，显示如图 [2-8](#Fig8) 所示的页面。如果用户正确地填写了表单，然后单击 Register 按钮(在输入字段下面)，用户的输入将被输入到数据库的 users 表中。然后显示“谢谢”页面。

请注意，注册页面上的注册和新密码按钮现在是多余的，因为用户已经访问了注册页面。显然，用户还没有要更改的密码。多余的按钮将留在本章所有示例的位置，以避免使说明复杂化。多余的按钮将在接下来的两章中删除或更改。

现在我们将检查整个注册页面的代码。

```
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Template for an interactive web page</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS File -->
  <link rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
  integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
  crossorigin="anonymous">
<script src="verify.js"></script>
</head>
<body>
    <div class="container" style="margin-top:30px">
    <!-- Header Section -->
    <header class="jumbotron text-center row"
         style="margin-bottom:2px; background:linear-gradient(white, #0073e6); padding:20px;">
         <?php include('header.php'); ?>
    </header>
    <!-- Body Section -->
        <div class="row" style="padding-left: 0px;">
    <!-- Left-side Column Menu Section -->
     <nav class="col-sm-2">
      <ul class="nav nav-pills flex-column">
          <?php include('nav.php'); ?>
      </ul>
    </nav>

    <!-- Validate Input
   <?php
    if ($_SERVER['REQUEST_METHOD'] == 'POST') {                                       //#1
     require('process-register-page.php');
    } // End of the main Submit conditional.
   ?>
   <div class="col-sm-8">
      <h2 class="h2 text-center">Register</h2>

  <form action="register-page.php" method="post" onsubmit="return checked(); >     <!-- #2 -->
     <div class="form-group row">

<label for="first_name" class="col-sm-4 col-form-label">First Name:</label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="first_name" name="first_name"
          placeholder="First Name" maxlength="30" required
          value="<?php if (isset($_POST['first_name'])) echo $_POST['first_name']; ?>" >
    </div>
  </div>

  <div class="form-group row">
    <label for="last_name" class="col-sm-4 col-form-label">Last Name:</label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="last_name" name="last_name"
          placeholder="Last Name" maxlength="40" required
          value="<?php if (isset($_POST['last_name'])) echo $_POST['last_name']; ?>">
    </div>
  </div>

<div class="form-group row">
    <label for="email" class="col-sm-4 col-form-label">E-mail:</label>
    <div class="col-sm-8">
      <input type="email" class="form-control" id="email" name="email"
          placeholder="E-mail" maxlength="60" required
          value="<?php if (isset($_POST['email'])) echo $_POST['email']; ?>">
    </div>
  </div>

<div class="form-group row">
    <label for="password1" class="col-sm-4 col-form-label">Password:</label>
    <div class="col-sm-8">
      <input type="password" class="form-control" id="password1" name="password1"
          placeholder="Password" minlength="8" maxlength="12"
          required value="<?php if (isset($_POST['password1'])) echo $_POST['password1']; ?>">
          <span id="message">Between 8 and 12 characters.</span>
  </div>

<div class="form-group row">
    <label for="password2" class="col-sm-4 col-form-label">Confirm Password:</label>
    <div class="col-sm-8">
      <input type="password" class="form-control" id="password2" name="password2"
          placeholder="Confirm Password" minlength="8" maxlength="12" required
          value="<?php if (isset($_POST['password2'])) echo $_POST['password2']; ?>">
    </div>
  </div>

<div class="form-group row">
    <div class="col-sm-12">
       <input id="submit" class="btn btn-primary" type="submit" name="submit" value="Register">
    </div>
 </div>
</form>
</div>

!-- Right-side Column Content Section                                            #3 -->
<?php
if(!isset($errorstring)) {
        echo '<aside class="col-sm-2">';
        include('info-col.php');
        echo '</aside>';
        echo '</div>';
        echo '<footer class="jumbotron text-center row col-sm-14"
                style="padding-bottom:1px; padding-top:8px;">';
 }
 else
 {
        echo '<footer class="jumbotron text-center col-sm-12"
        style="padding-bottom:1px; padding-top:8px;">';
 }
  include('footer.php');
 ?>
</div>
</body>
</html>

Listing 2-8aCreating

the Registration Page (register-page.php)

```

#### 代码的解释

代码的基本结构与索引文件相同。差异出现在主体中，特别是现在包含供用户注册的表单的中间列。

```
<?php
 if ($_SERVER['REQUEST_METHOD'] == 'POST') {                                     //#1
  require('process-register-page.php');
 } // End of the main Submit conditional.
?>

```

在 PHP 中，可以通过表单提交属性将信息传递给一个单独的 PHP 程序来处理表单，也可以通过在表单所在的文件中包含 PHP 代码来处理表单。在这个例子中，从技术上讲，我们将 PHP 代码包含在同一个文件中，因为我们从 process-register-page 文件中提取代码。我们也知道这一点，因为表单的 action 属性调用的是文件本身(form action="register-page.php ")，而不是另一个文件(参见下面的部分清单)。如果点击了 submit 按钮，就会执行进程寄存器文件中的 PHP 代码。如果用户没有单击 submit 按钮(可能是第一次显示页面)，就会显示表单。让我们来看看表单本身。

```
<form action="register-page.php" method="post" onsubmit="return checked();>     <!-- #2 -->
     <div class="form-group row">

<label for="first_name" class="col-sm-4 col-form-label">First Name:</label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="first_name" name="first_name"
          placeholder="First Name" maxlength="30" required
          value="<?php if (isset($_POST['first_name'])) echo $_POST['first_name']; ?>" >
    </div>
  </div>

```

当用户单击提交按钮时，注册页面会提交给自己。提交时，表单调用 JavaScript 函数 checked()来验证密码。此函数的代码如下所示:

```
function checked() {
  if (document.getElementById('password1').value ==
    document.getElementById('password2').value) {
    document.getElementById('message').style.color = 'green';
    document.getElementById('message').innerHTML = 'Passwords match';
        return true;
  } else {
    document.getElementById('message').style.color = 'red';
    document.getElementById('message').innerHTML = 'Passwords do not match';
        return false;
  }
}

```

这段代码是从 verify.js 程序和引导 CSS 代码一起导入的。如果密码匹配，则提交代码。如果密码不匹配，将显示一条错误消息，允许用户更正问题。

我们接下来将看到的 PHP 代码将验证用户提供的信息，并将其插入数据库。表单的每个元素(比如 first_name textbox)中都会发生很多事情。first_name 文本框附有一个标签，该标签使用了四个小的 Boostrap 网格单元。文本框使用八个小网格单元。Boostrap 使用 form-control 类格式化表单和文本框。用户可以输入的名字的最大长度是 30 个字符。required 属性告诉 HTML，在提交信息之前，用户必须在 textbox 中输入信息。

标记为#2 的一行 PHP 代码创建了一个 sticky 元素，保存用户输入的任何内容。这允许页面在重新加载时保留任何条目。每次用户单击提交按钮，页面都会被重新加载。通常这将清除所有条目，因为 HTML 页面不保留信息(断开的数据)。当用户提交表单时，信息通过 POST 方法传递给服务器。我们可以使用$_POST 方法和元素名称($_POST['first_name'])检索表单传递的任何元素。PHP 代码使用 isset 来确定 first_name 文本框中是否有条目。如果有条目，传递的值将被粘回到文本框中。这允许用户看到他们最初输入的内容，并对任何错误消息做出响应和纠正问题，而不必完全重新输入条目。其他文本框的工作方式类似。

### 注意

将$_POST 中的信息直接显示在网页上可能会带来风险，黑客可以利用它来操纵网页、尝试 CSRF/XSS 攻击以及操纵数据库中的数据。随着章节的进展，数据卫生和安全性将会提高，以减少安全漏洞的机会。本章中的代码不适合在实时网站上使用。

```
!-- Right-side Column Content Section                                                 #3 -->
<?php
if(!isset($errorstring)) {
        echo '<aside class="col-sm-2">';
        include('info-col.php');
        echo '</aside>';
        echo '</div>';
        echo '<footer class="jumbotron text-center row col-sm-14"
                style="padding-bottom:1px; padding-top:8px;">';
 }
 else
 {
        echo '<footer class="jumbotron text-center col-sm-12"
        style="padding-bottom:1px; padding-top:8px;">';
 }
  include('footer.php');

```

如果输入的信息未通过验证，将会产生错误消息。正如您将在即将解释的 PHP 代码中看到的，大多数错误消息都放在变量$errorstring 中。如果此变量存在，则存在一个或多个错误。当这种情况发生时，右列(参见前面代码中的#3)不会显示，以便为错误消息提供空间。页脚的列大小也略有调整。

现在让我们看看验证用户提供的信息的 PHP 代码。

```
<?php
// This script is a query that INSERTs a record in the users table.
// Check that form has been submitted:
        $errors = array(); // Initialize an error array.                                #1
       // Check for a first name:                                                       #2
       $first_name = trim($_POST['first_name']);
       if (empty($first_name)) {
              $errors[] = 'You forgot to enter your first name.';
       }
                // Check for a last name:
       $last_name = trim($_POST['last_name']);
       if (empty($last_name)) {
              $errors[] = 'You forgot to enter your last name.';
       }
       // Check for an email address:
       $email = trim($_POST['email']);
       if (empty($email)) {
              $errors[] = 'You forgot to enter your email address.';
       }
       // Check for a password and match against the confirmed password:               #3
       $password1 = trim($_POST['password1']);
       $password2 = trim($_POST['password2']);
       if (!empty($password1)) {
              if ($password1 !== $password2) {
                       $errors[] = 'Your two passwords did not match.';
               }
        } else {
               $errors[] = 'You forgot to enter your password.';
        }       if (empty($errors)) { // If everything's OK.                            #4
try {
        // Register the user in the database...
        // Hash password current 60 characters but can increase
            $hashed_passcode = password_hash($password1, PASSWORD_DEFAULT);           //#5
             require ('mysqli_connect.php'); // Connect to the db.                    //#6
        // Make the query:                                                              #7
        $query = "INSERT INTO users (userid, first_name, last_name, email, password, registration_date) ";
                $query .="VALUES(' ', ?, ?, ?, ?, NOW() )";                           //#8
        $q = mysqli_stmt_init($dbcon);                                                //#9
        mysqli_stmt_prepare($q, $query);
        // use prepared statement to ensure that only text is inserted
        // bind fields to SQL Statement
        mysqli_stmt_bind_param($q, 'ssss', $first_name, $last_name, $email, $hashed_passcode);
     // execute query
        mysqli_stmt_execute($q);
        if (mysqli_stmt_affected_rows($q) == 1) { // One record inserted               #10
                header ("location: register-thanks.php");
                exit();
                } else { // If it did not run OK.
                // Public message:
                                $errorstring = "<p class='text-center col-sm-8' style='color:red'>";
                        $errorstring .= "System Error<br />You could not be registered due ";
                        $errorstring .= "to a system error. We apologize for any inconvenience.</p>";
                        echo "<p class=' text-center col-sm-2' style='color:red'>$errorstring</p>";
                // Debugging message below do not use in production
                //echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $query . '</p>';
                               mysqli_close($dbcon); // Close the database connection.
                // include footer then close program to stop execution
                        echo '<footer class="jumbotron text-center col-sm-12"
                                       style="padding-bottom:1px; padding-top:8px;">
                                               include("footer.php");
                                              </footer>';
                             exit();
       }
   }
   catch(Exception $e) // We finally handle any problems here                          #11
   {
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
   }
   catch(Error $e)
   {
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
   }
        } else { // Report the errors.                                                 #12
               $errorstring = "Error! The following error(s) occurred:<br>";
               foreach ($errors as $msg) { // Print each error.
                        $errorstring .= " - $msg<br>\n";
               }
               $errorstring .= "Please try again.<br>";
               echo "<p class=' text-center col-sm-2' style='color:red'>$errorstring</p>";
               }// End of if (empty($errors)) IF.
?>

Listing 2-8bValidating

the Registration Page (process-register-page.php)

```

### 注意

在这一点上，初学者可能会感到困惑，因为他们更熟悉从上到下遍历页面的代码。在前面的交互式代码示例中，初学者希望表单字段位于代码页的顶部。事实上，它们在清单中排在最后(在通过 require 方法导入的 PHP 代码之后)。有一个主 if 语句(if($ _ SERVER[' REQUEST _ METHOD ']= ' POST '){)控制着程序的流程。如果用户已经访问了页面并点击了提交按钮，那么 If 语句为真，PHP 代码被执行(从包含的文件；上例中的 process_register_page.php)。如果这是用户第一次访问该页面，则 If 语句为 false。因此，执行语句 else 部分中的 HTML 代码。在提交表单和执行 PHP 代码之前，HTML5 代码还会对用户输入的信息进行一些有限的验证。此外，PHP 代码将验证从 web 页面收到的是“好的”、经过验证的和经过净化的信息。

看起来我们重复核实了两次信息。然而，使用 HTML5(可能还有一些 JavaScript)来首次尝试验证信息可以减少服务器调用并加快验证过程。我们仍然需要在服务器上再次验证信息，因为在信息到达之前，它可能被有意或无意地操纵。

#### 代码的解释

清单中的注释解释了许多 PHP 语句，但是有些项目需要进一步注释。PHP 代码可能看起来非常复杂，但是我们将把它分成更小的部分来帮助你理解它。让我们现在开始吧。

```
$errors = array(); // Initialize an error array.                                       #1

```

数组是一种将多项相似信息存储到一个存储位置的方法。在我们的例子中，我们使用数组来存储任何错误消息。前一行初始化数组，并将其命名为$errors。从技术上讲，$errors 现在指向内存中为数组保留的区域。本章末尾和附录中提供了一些有关数组及其用法的附加信息。

```
// Check for a first name:                                                             #2
$first_name = trim($first_name);
if (empty($first_name)) {
       $errors[] = 'You forgot to enter your first name.';
}

```

像$_POST['first_name']这样的全局变量中的元素总是用方括号括起来。这是超级全局变量的一个特性。从技术上讲，从我们的表单传递到 PHP 代码的所有内容都被传递到一个 post 数组中(这就是我们使用方括号而不是圆括号的原因)。然后，我们使用 POST 超级全局语句从数组中检索我们想要的内容。

以$first_name = trim 开头的代码是一条指令，用于从用户的 first_name 条目的开头和结尾修剪(删除)任何空格或其他空白。输入数据开头和结尾的空格是不需要的字符。然后将修剪后的名字赋给变量$first_name。为了增强安全性，我们应该额外删除无效字符。然而，就目前而言，让我们尽量保持简单。前面显示的格式也用于姓氏和电子邮件。

### 注意

任何采用$_POST[ ]格式的变量，如$_POST['first_name']，都是一个全局变量，可通过网站上的页面访问。普通变量的格式为$first_name，只能通过加载出现它们的页面来访问它们。$_POST 将通过 POST 数组提取从 HTML 表单传递的信息，当用户单击 submit 按钮时，会自动填充该数组。方括号中包含的变量名(first_name)必须与 HTML 输入语句的 name 参数完全匹配。

```
// Check for a password and match against the confirmed password:                      #3
$password1 = trim($_POST['password1']);
$password2 = trim($_POST['password2']);
if (!empty($password1)) {
         if ($password1 !== $password2) {
                  $errors[] = 'Your two password did not match.';
         }
} else {
         $errors[] = 'You forgot to enter your password.';
}

```

两个新密码都去掉了不必要的空格。如果密码 1 不为空。空)，则执行两个新密码的比较。那个！==(一！和两个=)符号确定表单中输入的密码是否相同。这种不等于的格式确保了大写和小写是相同的。它还确保数据类型(字符串与整数相比)是相同的。如果密码不同，将在错误数组中显示一条错误消息。

```
if (empty($errors)) { // If everything's OK.                                           #4

```

这段代码位于成功部分。当所有字段都已正确填写时，该部分开始注册过程——在这种情况下,$errors 数组为空。这一行是说“因为没有错误，我们可以连接到数据库并插入用户的数据。”

```
$hashed_passcode = password_hash($password, PASSWORD_DEFAULT);                       //#5

```

我们必须确保所有密码尽可能安全。前面的代码使用 PHP 密码哈希方法将用户输入的密码转换为安全密码。PASSWORD_DEFAULT 将总是包含最新的 PHP 散列码。在数据库表中，我们将密码字段设置为包含 60 个字符。将来，新的散列技术可能会要求您增加该字段的大小。

```
require ('mysqli_connect.php'); // Connect to the db.                                //#6

```

在这一行中，数据库连接是用 require()而不是 include()建立的，这样，如果建立了连接，脚本就会运行，但是如果没有连接，脚本就不会运行。这是因为如果数据库不可访问(因为无法将数据插入到表中),那么继续操作就没有意义。当需要包含一些重要的东西时，我们使用 require()。我们本可以在这里使用 require_once，因为我们只想将这段代码引入一次，以建立到数据库的连接。

```
// Make the query:                                                                    #7
$query = "INSERT INTO users (userid, first_name, last_name, email, password, registration_date) ";

```

如果成功连接到数据库，这一行就准备将数据输入到名为 *users* 的表中。单词 *query* 有时表示“查询”，但更多时候表示“做点什么”。在这种情况下，它意味着“使用以下数据插入新记录…”这一行是“插入到名为 *users* 的表中，在标有`userid`、`first_name`等的列标题下……”该查询被分配给一个变量`$query`。第 7 行和第 8 行实际上是 SQL 准备的查询。这展示了 HTML、PHP 和 SQL 是如何很好地协同工作的。

```
$query .="VALUES(' ', ?, ?, ?, ?, NOW() )";                                          //#8

```

这段 SQL 代码为要输入的数据提供了一个存放位置。我们使用预准备语句，因为它永远不会执行已经绑定到位置的数据。标记存在)。这使得黑客无法在我们的 SQL 字符串中插入额外的 SQL 语句来破坏我们的数据。请注意，第一个值故意为空(用引号括起来，中间有一个空格)，因为它是由 MySQL 或 MariaDB 数据库管理系统自动递增并输入的字段，而不是由用户输入的。NOW 函数自动将数据和时间放入数据库表的 registration_date 列中。

```
$q = mysqli_stmt_init($dbcon);                                                       //#9
mysqli_stmt_prepare($q, $query);
// use prepared statement to ensure that only text is inserted
// bind fields to SQL Statement
mysqli_stmt_bind_param($q, 'ssss', $first_name, $last_name, $email, $hashed_passcode);
// param must include four variables to match the four s parameters
// execute query
mysqli_stmt_execute($q);

```

来自之前包含的文件( *mysqli_connect.php* )的连接字符串被附加到 mysqli，并且可以用$q 变量引用。然后$query 字符串被声明为一个准备好的语句(表示变量将被插入到代码中)，并与数据库连接字符串相关联。变量($first_name，$last_name，$email，$hashed_passcode)附加到准备好的 SQL 语句中。注意，s 符号表示每个变量都包含一个字符串。要表示数字信息，可以使用 I(整数)或 d(双精度)。b 也可用于 BLOB。然后对数据库表执行该语句。

```
if (mysqli_stmt_affected_rows($q) == 1) { // One record inserted                      #10
       header ("location: register-thanks.php");
       exit();

```

如果操作成功，数据库将被关闭。那么 header 方法会用一个“谢谢”页面替换当前的注册页面。header 方法产生一个请求页面的 HTML Get 消息。exit 命令将关闭当前页面，因为它不再被使用。

```
catch(Exception $e) // We finally handle any problems here                            #11
   {
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
   }
   catch(Error $e)
   {
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
   }

```

如果在执行 SQL 命令时出现错误或其他错误或异常，代码流将跳转到 catch 块来处理问题。如上所述，对于测试，我们可以显示我们的错误，但是当我们切换到生产时，我们将显示一个通用的“系统当前不可用”消息，并将问题记录在错误日志中。

```
} else { // Report the errors.                                                        #12

               $errorstring = "Error! The following error(s) occurred:<br>";
               foreach ($errors as $msg) { // Print each error.
                       $errorstring .= " - $msg<br>\n";
               }
               $errorstring .= "Please try again.<br>";
               echo "<p class='text-center col-sm-2' style='color:red'>$errorstring;</p>";
               }// End of if (empty($errors)) IF.

```

如果有用户错误(无效条目)，消息将存在于$error 数组中。当数组中有条目时，将实现 else 结构。foreach 循环遍历$errors 数组，如果发现任何错误消息，就会显示(回显)在屏幕上(foreach 是一个不带空格的单词)。

在 HTML 代码中检查$errorstring 变量，以确定是否显示右列。如果有错误，右列不会显示，以便为错误消息留出空间。

您可能想知道为什么我们要创建 PHP 代码来进行与所示 HTML5 代码相似的验证。PHP 代码在服务器上被解释和执行。HTML 代码在浏览器中执行。即使代码在浏览器中得到验证，它也可能在到服务器 PHP 程序的路径上被破坏。您应该使用 HTML(和 JavaScript)进行验证，以便更快地验证和响应用户。它还减少了服务器调用。

## PHP 关键字 echo

在前面的代码中，关键字 echo 出现在许多地方。这是 PHP 告诉浏览器“在屏幕上显示一些东西”的方式。一些设计师使用可选的关键字 print，但本书通常会使用 echo，因为我们发现初学者会将它与将东西发送到喷墨或激光打印机的命令混淆；硬拷贝打印是 PHP 做不到的。

### 注意

您想要的任何 HTML 代码都可以放在 echo 语句中。echo 将内容写入 HTML 文档(虚拟地，而不是字面地)，以便可以在浏览器中显示。

当需要换行时，初学者可能会对 echo 的行为感到困惑。例如，以下代码不显示任何行间距:

```
echo "I found that PHP ";
echo "was much easier to learn than Perl";

```

浏览器显示如下:

我发现 PHP 比 Perl 容易学得多

要向下推第二行，必须插入换行符标记
，如下所示:

```
echo "I found that PHP<br>";
echo "was much easier to learn than Perl";

```

浏览器显示如下:

我发现 PHP 比 Perl 容易学得多

## “谢谢”页面

图 [2-9](#Fig9) 显示了“感谢”页面。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig9_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig9_HTML.jpg)

图 2-9

“谢谢”页面

注册页面使用 PHP header 语句调用“谢谢”页面。您可以在注册页面代码的成功部分找到这一点。为方便起见，我们在此重复一遍:

```
$dbcon->close();
header ("location: register-thanks.php");
exit();

```

清单 [2-9](#PC40) 显示了完整的“谢谢”页面代码。

```
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Template for an interactive web page</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS File -->
  <link rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
  integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
  crossorigin="anonymous">
</head>
<body>
<div class="container" style="margin-top:30px">
<!-- Header Section -->
<header class="jumbotron text-center row"
style="margin-bottom:2px; background:linear-gradient(white, #0073e6); padding:20px;">
  <?php include('header.php'); ?>
</header>
<!-- Body Section -->
  <div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
  <nav class="col-sm-2">
      <ul class="nav nav-pills flex-column">
         <?php include('nav.php'); ?>
      </ul>
  </nav>
<!-- Center Column Content Section -->
  <div class="col-sm-8 text-center">
      <h2>Thank you for registering</h2>
      On the Home Page, you will now be able to login and add new quotes to the message board.
<!-- login does not yet work, nut will in the next chapter -->
  </div>
<!-- Right-side Column Content Section -->
      <aside class="col-sm-2">
           <?php include('info-col.php'); ?>
      </aside>
  </div>
<!-- Footer Content Section -->
     <footer class="jumbotron text-center row"
          style="padding-bottom:1px; padding-top:8px;">
          <?php include('footer.php'); ?>
     </footer>
</div>
</body>
</html>

Listing 2-9Creating the “Thank You” Page (register-thanks.php)

```

如您所见，该页面是根据模板创建的，只做了一些更改。这保持了网站应有的一致性。我们现在来看看当服务器收到无效信息时会发生什么。我们将使用一个数组来显示错误消息。

## 显示数组中收集的错误信息

如果服务器上的所有字段都收到无效信息(空值)，将会产生多个错误。相应的错误消息被插入到错误数组中。然后显示这些信息，以便用户了解情况。如果只显示第一个错误，然后在第二次单击 Register 按钮后，又显示第二个错误，以此类推，那就太烦人了。

图 [2-10](#Fig10) 显示了出现这种情况时显示的错误示例。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig10_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig10_HTML.jpg)

图 2-10

用户未能输入任何数据时显示的错误

错误显示在注册页面上。如前所述，当出现用户错误时，右栏被删除，以提供一个显示消息的区域。错误可能表明浏览器和服务器之间的数据以某种方式被破坏。如果用户输入不正确的信息并点击提交按钮，HTML5 和 JavaScript 代码将处理大多数验证情况并显示错误消息。如果您想测试更多的服务器错误消息，请从每个 HTML 文本框中删除必需的属性。

## 散列密码

所有密码都必须经过哈希处理，以防黑客发现。从 PHP 5.5 开始，开发人员创建了一种新的密码散列(编码)方法。这种方法被认为是安全的，是散列密码的最佳方法之一。格式如下:

```
$hashedPassword = password_hash($password1, PASSWORD_DEFAULT);

```

在本例中，$password1 是密码的未哈希版本。PASSWORD_DEFAULT 是一个 PHP 常量。随着安全性的变化，PHP 开发人员计划保持编码格式不变，并改变 PHP 常量来表示任何新的散列方案。password_hash 方法将用户输入的密码转换为安全的散列密码，然后可以保存在数据库表中。我们将在后面发现，我们必须使用 password_verify 方法来确定用户输入的密码是否与存储在数据库中的散列密码相匹配。

## 查看成员记录

当用户注册后，网站管理员可以使用 phpMyAdmin 来查看该表及其条目。我们假设一个用户在 2018 年 4 月 26 日注册，他们输入了以下信息:

名字:史蒂夫姓氏:约翰逊，电子邮件:sjohnson@sjohnson.com，密码:aaaaaaaa

phpMyAdmin 将允许您查看用户表中的每条记录。访问 phpMyAdmin，选择 simpledb 数据库，单击 users 表，然后单击 Browse 选项卡。图 [2-11](#Fig11) 显示了斯蒂夫·约翰森的参赛作品。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig11_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig11_HTML.jpg)

图 2-11

在 phpMyAdmin 中查看记录

请注意，密码 aaaaaaaa 被散列为$ 2y $ 10 $ lEmRKPYfu/nb 6 ect BMP 7 youizezdyucnzkrmebnq 6 nrhdkjhdegmk。

通常，无法访问 phpMyAdmin 的网站设计人员和数据库管理员可能还需要查看由所有注册用户创建的数据库条目表。下一个示例提供了这样做的信息。

## “查看用户”页面

点击查看用户按钮，显示注册用户列表，如图 [2-12](#Fig12) 所示。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig12_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig12_HTML.jpg)

图 2-12

将显示一个用户表

当用户单击右上角菜单上的“查看用户”按钮时，将显示该表。清单 [2-10](#PC42) 显示了显示用户表的代码。

```
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Template for an interactive web page</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS File -->
  <link rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
  integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
  crossorigin="anonymous">
</head>
<body>
<div class="container" style="margin-top:30px">
<!-- Header Section -->
<header class="jumbotron text-center row"
style="margin-bottom:2px; background:linear-gradient(white, #0073e6); padding:20px;">
  <?php include('header.php'); ?>
</header>
<!-- Body Section -->
  <div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
  <nav class="col-sm-2">
      <ul class="nav nav-pills flex-column">
                <?php include('nav.php'); ?>
      </ul>
  </nav>
<!-- Center Column Content Section -->
  <div class="col-sm-8">
  <h2 class="text-center">These are the registered users</h2>
<p>
<?php
try {
// This script retrieves all the records from the users table.
require('mysqli_connect.php'); // Connect to the database.
// Make the query:
// Nothing passed from user safe query                                                 #1
$query = "SELECT CONCAT(last_name, ', ', first_name) AS name, ";
$query .= "DATE_FORMAT(registration_date, '%M %d, %Y') AS ";
$query .= "regdat FROM users ORDER BY registration_date ASC";
$result = mysqli_query ($dbcon, $query); // Run the query.
if ($result) { // If it ran OK, display the records.
// Table header.                                                                       #2
echo '<table class="table table-striped">
<tr><th scope="col">Name</th><th scope="col">Date Registered</th></tr>';
// Fetch and print all the records:                                                    #3
while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {
echo '<tr><td>' . $row['name'] . '</td><td>' . $row['regdat'] . '</td></tr>'; }
    echo '</table>'; // Close the table so that it is ready for displaying.
    mysqli_free_result ($result); // Free up the resources.
} else { // If it did not run OK.
// Error message:
echo '<p class="error">The current users could not be retrieved. We apologize';
echo ' for any inconvenience.</p>';
// Debug message:
// echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $q . '</p>';
exit;
} // End of if ($result)
mysqli_close($dbcon); // Close the database connection.
}
catch(Exception $e) // We finally handle any problems here
   {
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
   }
   catch(Error $e)
   {
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
   }
?>

  </div>
<!-- Right-side Column Content Section -->
        <aside class="col-sm-2">
      <?php include('info-col.php'); ?>
        </aside>
  </div>
<!-- Footer Content Section -->
<footer class="jumbotron text-center row"
style="padding-bottom:1px; padding-top:8px;">
  <?php include('footer.php'); ?>
</footer>
</div>
</body>
</html>

Listing 2-12Displaying a Table of Registered Members on the Screen (register-view-users.php)

```

### 代码的解释

您之前已经看到了大部分代码，但下面是对新项目的解释:

```
// Make the query:
// Nothing passed from user safe query                                                 #1
$query = "SELECT CONCAT(last_name, ', ', first_name) AS name, ";
$query .= "DATE_FORMAT(registration_date, '%M %d, %Y') AS ";
$query .= "regdat FROM users ORDER BY registration_date ASC";
$result = mysqli_query ($dbcon, $query); // Run the query.
if ($result) { // If it ran OK, display the records.

```

SQL 查询选择姓，然后是逗号，然后是名，并将其串在一起(串联)，同时选择注册数据。它将这些文件的临时标题设置为 name 和 regdat。它以月-日-年的格式重新排列注册日期。它使用 select 查询从 users 表中提取信息。最后，它要求每一行信息都按照升序(ASC)日期顺序显示(最早的排在最前面)。要首先显示最新登记的记录(降序)，可以使用 DESC 而不是 ASC。由于查询没有从用户那里收集任何信息，我们不需要创建一个准备好的语句，传递注册页面中显示的变量。这个查询字符串不能被破解。

```
// Table header.                                                                       #2
echo '<table class="table table-striped">
<tr><th scope="col">Name</th><th scope="col">Date Registered</th></tr>';

```

此代码块使用引导类表显示(回显)该表，并剥离表以格式化显示。列标题 Name 和 Date Registered 也被声明为显示的表的第一行。

```
// Fetch and print all the records:                                                    #3
while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {
echo '<tr><td>' . $row['name'] . '</td><td>' . $row['regdat'] . '</td></tr>'; }

```

这段代码循环遍历这些行，并在数据库表中的行数据可用时显示它们。MYSQLI_ASSOC 创建一个关联数组。PHP 关联数组使用关键字(单词)作为索引。例如，$row['name']包含从 users 表中提取的串联的名字和姓氏(参见#1)。

用户有时想要更改他们的密码。下一节将演示如何做到这一点。

## “更改密码”页面

当用户点击标题右上角菜单上的新密码按钮时，出现如图 [2-13](#Fig13) 所示的表单。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig13_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig13_HTML.jpg)

图 2-13

更改密码表单

只有当用户知道他们当前的密码和电子邮件地址时，该表单才适用。如果他们忘记了密码，就需要一种不同的方法，这将在后面的章节中讨论。然而，如果用户不喜欢他们最初选择的密码，这个“新密码”页面是有用的。清单 [2-13a](#PC46) 给出了修改密码表单的 HTML 代码。

```
<!DOCTYPE html>
<html lang="en">
<head>
 <title>Template for an interactive web page</title>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
 <!-- Bootstrap CSS File -->
 <link rel="stylesheet"
 href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
 integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
 crossorigin="anonymous">
<script src="verify.js"></script>
</head>
<body>
<div class="container" style="margin-top:30px">
<!-- Header Section -->
<header class="jumbotron text-center row col-sm-14"
style="margin-bottom:2px; background:linear-gradient(white, #0073e6); padding:20px;">
 <?php include('header.php'); ?>
</header>
<!-- Body Section -->
 <div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
  <nav class="col-sm-2">
     <ul class="nav nav-pills flex-column">
        <?php include('nav.php'); ?>
      </ul>
  </nav>
 <!-- Validate Input -->
   <?php
  if ($_SERVER['REQUEST_METHOD'] == 'POST') {
   require('process-change-password.php');                                           //#1
  } // End of the main Submit conditional.
  ?>
<div class="col-sm-8">
<h2 class="h2 text-center">Change Password</h2>
<form action="change-password.php" method="post" name="regform"
 id="regform" onsubmit="return checked();">
<div class="form-group row">
    <label for="email" class="col-sm-4 col-form-label">E-mail:</label>
        <div class="col-sm-8">
        <input type="email" class="form-control" id="email" name="email"
        placeholder="E-mail" maxlength="60" required
        value="<?php if (isset($_POST['email'])) echo $_POST['email']; ?>">
        </div>
 </div>
 <div class="form-group row">
        <label for="password" class="col-sm-4 col-form-label">Current Password:</label>
        <div class="col-sm-8">
        <input type="password" class="form-control" id="password" name="password"
        placeholder="Password" minlength="8" maxlength="12"
        required value="<?php if (isset($_POST['password'])) echo $_POST['password']; ?>">
        </div>
 </div>
<div class="form-group row">
        <label for="password1" class="col-sm-4 col-form-label">New Password:</label>
        <div class="col-sm-8">
         <input type="password" class="form-control" id="password1" name="password1"
          placeholder="Password" minlength="8" maxlength="12"
          required value="<?php if (isset($_POST['password1'])) echo $_POST['password1']; ?>">
          <span id="message">Between 8 and 12 characters.</span>
</div>
<div class="form-group row">
         <label for="password2" class="col-sm-4 col-form-label">Confirm Password:</label>
         <div class="col-sm-8">
                 <input type="password" class="form-control" id="password2" name="password2"
          placeholder="Confirm Password" minlength="8" maxlength="12" required
          value="<?php if (isset($_POST['password2'])) echo $_POST['password2']; ?>">
        </div>
 </div>
<div class="form-group row">
        <div class="col-sm-12">
        <input id="submit" class="btn btn-primary" type="submit" name="submit"
        value="Change Password">
        </div>
</div>
</form>
</div>
<!-- Right-side Column Content Section -->
<?php
 if(isset($errorstring)) {
         echo '<footer class="jumbotron text-center col-sm-12"
        style="padding-bottom:1px; padding-top:8px;">';
 }
 else
 {
        echo '<aside class="col-sm-2">';
        include('info-col.php');
        echo '</aside>';
        echo '</div>';
        echo '<footer class="jumbotron text-center row col-sm-14"
        style="padding-bottom:1px; padding-top:8px;">';
 }
  include('footer.php');
 ?>
</footer>
</div>
</body>
</html>

Listing 2-13aCreating a Page to Allow Users to Change a Password (change-password.php)

```

### 代码的解释

本节给出了代码的解释。

```
  if ($_SERVER['REQUEST_METHOD'] == 'POST') {
   require('process-change-password.php');                                           //#1
  } // End of the main Submit conditional.

```

更改密码页面的 HTML 类似于注册页面的 HTML。主要区别是 PHP 代码现在是从 process-change-password 文件导入的。让我们看看清单 [2-13b](#PC48) 中这个文件的内容。

```
<?php
// This script is a query that UPDATES the password in the users table.
// Check that form has been submitted:
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
require ('mysqli_connect.php'); // Connect to the db.
$errors = array(); // Initialize an error array.
// Check for an email address:
$email = trim($_POST['email']);
if (empty($email)) {
        $errors[] = 'You forgot to enter your email address.';
}
// Check for a password and match against the confirmed password:
$password = trim($_POST['password']);
if (empty($password)) {
        $errors[] = 'You forgot to enter your old password.';
}
// Prepare and check new password                                                      #1
$new_password = trim($_POST['password1']);
$verify_password = trim($_POST['password2']);
if (!empty($new_password)) {
        if (($new_password != $verify_password) ||
        ( $password == $new_password ))
        {
$errors[] = 'Your new password did not match the confirmed password and/or ';
$errors[] = 'Your old password is the same as your new password.';
        }
} else {
        $errors[] = 'You did not enter a new password.';
}if (empty($errors)) { // If everything's OK.
try {
 // Check that the user has entered the right email address/password combination:      #2
 $query = "SELECT userid, password FROM users WHERE ( email=? )";
$q = mysqli_stmt_init($dbcon);
mysqli_stmt_prepare($q, $query);
 // use prepared statement to ensure that only text is inserted
 // bind fields to SQL Statement
mysqli_stmt_bind_param($q, 's', $email);
 // execute query
 mysqli_stmt_execute($q);
$result = mysqli_stmt_get_result($q);
$row = mysqli_fetch_array($result, MYSQLI_ASSOC);
if ((mysqli_num_rows($result) == 1)                                                  //#3
          && (password_verify($password, $row['password'])))
          {    // Found one record
         // Change the password in the database...
         // Hash password current 60 characters but can increase
         $hashed_passcode = password_hash($new_password, PASSWORD_DEFAULT);
         // Make the query:
         $query = "UPDATE users SET password=? WHERE email=?";
         $q = mysqli_stmt_init($dbcon);
         mysqli_stmt_prepare($q, $query);
         // use prepared statement to ensure that only text is inserted
         // bind fields to SQL Statement
         mysqli_stmt_bind_param($q, 'ss', $hashed_passcode, $email);
         // execute query
         mysqli_stmt_execute($q);
         if (mysqli_stmt_affected_rows($q) == 1) {   // one row updated                #4
                       // Thank you
                      header ("location: password-thanks.php");
                                exit();
        } else { // If it did not run OK.                                               #5
               // Public message:
               $errorstring = "System Error! <br /> You could not change password due ";
               $errorstring .= "to a system error. We apologize for any inconvenience.</p>";
               echo "<p class='text-center col-sm-2' style='color:red'>$errorstring</p>";
               // Debugging message below do not use in production
               //echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $query . '</p>';
               // include footer then close program to stop execution
               echo '<footer class="jumbotron text-center col-sm-12"
                       style="padding-bottom:1px; padding-top:8px;">
                       include("footer.php");
                       </footer>';
               exit();
        }
         } else { // Invalid email address/password combination.
               $errorstring = 'Error! <br /> ';
                       $errorstring .= 'The email address and/or password do not match those on file.';
               $errorstring .= " Please try again.";
               echo "<p class='text-center col-sm-2' style='color:red'>$errorstring</p>";
} }
   catch(Exception $e) // We finally handle any problems here
   {
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
   }
   catch(Error $e)
   {
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
   }
   } else { // Report the errors.                                                      #6
        //header ("location: register-page.php");
        $errorstring = "Error! The following error(s) occurred:<br>";
        foreach ($errors as $msg) { // Print each error.
                $errorstring .= " - $msg<br>\n";
        }
        $errorstring .= "Please try again.<br>";
        echo "<p class=' text-center col-sm-2' style='color:red'>$errorstring</p>";
        }// End of if (empty($errors)) IF.
} // End of the main Submit conditional.
?>

Listing 2-13bProcessing the Changed Password (process-change-password.php)

```

### 代码的解释

本节解释代码。

```
// Prepare and check new password                                                      #1
$new_password = trim($_POST['password1']);
$verify_password = trim($_POST['password2']);
if (!empty($new_password)) {
        if (($new_password != $verify_password) ||
        ( $password == $new_password ))
        {
$errors[] = 'Your new password did not match the confirmed password and/or ';
$errors[] = 'Your old password is the same as your new password.';
       }
} else {
       $errors[] = 'You did not enter a new password.';

```

前两行代码删除字符串中的所有空格。在后面的章节中，我们将验证密码的格式是否正确。但是，目前我们使用的是准备好的语句；因此，用户试图插入文本框的任何代码都不会被执行。如果两个新密码匹配，新密码将放在$password 中。如果它们不匹配，一个错误被发送回网页。

```
(
// Check that the user has entered the right email address/password combination:       #2
 $query = "SELECT userid, password FROM users WHERE ( email=? )";
$q = mysqli_stmt_init($dbcon);
mysqli_stmt_prepare($q, $query);
 // use prepared statement to ensure that only text is inserted
 // bind fields to SQL Statement
mysqli_stmt_bind_param($q, 's', $email);
 // execute query
 mysqli_stmt_execute($q);
$result = mysqli_stmt_get_result($q);
$row = mysqli_fetch_array($result, MYSQLI_ASSOC);

```

如果所有验证都成功，我们必须确保用户提供了现有的电子邮件和密码。前面代码中的第 2 行创建了一个准备好的 select 语句，该语句使用提供的电子邮件从 users 表中提取用户名和密码。如果 SQL 语句返回一个结果，我们就验证了该电子邮件存在于数据库中。

```
if ((mysqli_num_rows($result) == 1)                                                  //#3
          && (password_verify($password, $row['password'])))
          {    // Found one record
        // Change the password in the database...
         // Hash password current 60 characters but can increase
         $hashed_passcode = password_hash($new_password, PASSWORD_DEFAULT);
        // Make the query:
        $query = "UPDATE users SET password=? WHERE email=?";
        $q = mysqli_stmt_init($dbcon);
        mysqli_stmt_prepare($q, $query);
        // use prepared statement to ensure that only text is inserted
        // bind fields to SQL Statement
        mysqli_stmt_bind_param($q, 'ss', $hashed_passcode, $email);
        // execute query
        mysqli_stmt_execute($q);

```

如果我们从数据库表中得到一个结果，我们还需要验证密码是否正确。if 语句使用 password_verify 函数将旧密码与表中的密码进行比较。这是必要的，因为存储在表中的密码是散列的，而用户提供的密码不是散列的。如果匹配，则对新密码进行哈希运算。创建一个准备好的 SQL 更新查询来更改 users 表中的密码。然后执行该查询。

```
if (mysqli_stmt_affected_rows($q) == 1) {    // one row updated                        #4
                       // Thank you
                       header ("location: password-thanks.php");
                                exit();

```

如果 SQL 更新查询成功，将显示“谢谢”页面。header 函数使用 HTML Get 命令调用密码感谢页面。使用 exit 方法关闭当前页面。

```
} else { // If it did not run OK.                                                      #5
               // Public message:
               $errorstring = "System Error! <br /> You could not change password due ";
               $errorstring .= "to a system error. We apologize for any inconvenience.</p>";
               echo "<p class='text-center col-sm-2' style='color:red'>$errorstring</p>";
               // Debugging message below do not use in production
               //echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $query . '</p>';
               // include footer then close program to stop execution
               echo '<footer class="jumbotron text-center col-sm-12"
                       style="padding-bottom:1px; padding-top:8px;">
                       include("footer.php");
                       </footer>';
               exit();

```

如果没有行被更改，则查询不会成功执行。else 语句捕获这种情况，并显示一条系统错误语句。因为这是一个严重的错误，所以为页面提供了一个页脚，并关闭了代码(exit())。这将关闭对数据库的任何访问，并且不会让任何其他代码执行。注释中列出了调试代码，这些代码将提供有关该问题的更多信息。此代码不应在实时代码中激活。提供的错误信息可能会显示代码和数据库连接信息，这将是一个严重的安全违规。

```
} else { // Report the errors.                                                         #6
        //header ("location: register-page.php");
        $errorstring = "Error! The following error(s) occurred:<br>";
        foreach ($errors as $msg) { // Print each error.
                $errorstring .= " - $msg<br>\n";
        }
        $errorstring .= "Please try again.<br>";
        echo "<p class=' text-center col-sm-2' style='color:red'>$errorstring</p>";
        }// End of if (empty($errors)) IF.

```

代码的最后一部分类似于注册页面。它显示用户输入无效信息时导致的任何错误消息。这些错误与表单显示在同一个页面上，以便用户进行更正并重新提交信息。

## 确认密码更改成功

如果密码更改成功，显示如图 [2-14](#Fig14) 所示的页面。

图 [2-14](#Fig14) 所示页面与注册“感谢”页面相似。您可以从本章的下载文件中查看代码。

![../images/314857_2_En_2_Chapter/314857_2_En_2_Fig14_HTML.jpg](../images/314857_2_En_2_Chapter/314857_2_En_2_Fig14_HTML.jpg)

图 2-14

密码已被更改

### 测试教程的页面

要查看交互式页面的工作情况，请双击桌面上的 XAMPP 或 easyPHP 图标。当控制面板出现时，检查 Apache 和 MySQL/MariaDB 是否正在运行。

在浏览器的地址栏中输入`http://localhost/simpledb/index.php`，然后点击注册按钮，这样就可以输入一些用户。

为了节省你的时间和虚构人物的努力，使用表 [2-1](#Tab1) 中提供的建议。

表 2-1

输入成员详细信息的建议

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"></colgroup> 
| 

名字

 | 

电子邮件

 | 

密码

 |
| --- | --- | --- |
| 麦克·罗斯 | 米克尔@myisp.com | W1llgat3s |
| 橄榄枝 | obranch@myisp.com.uk | 第 1 年第 0 季第 3 集 |
| 弗兰克·弗雷泽 | finsin @ my ISP . net | P3 PFM 300 型核潜艇 |
| 周年纪念日 | aversary@myisp.com | B1 港币 3yg1rl |
| 特里·菲德 | tfide @ my ISP . com | 刀疤 3dst1ff |
| 玫瑰（灌木）丛 | rbush@myisp.co.uk | R3 db 100 ms |

现在用户表中有了更多的数据，运行 XAMPP 或 EasyPHP，使用浏览器单击菜单项显示注册用户表。

### 小费

毫无疑问，当您创建代码并测试它时，您会遇到错误消息。如需帮助，请参考第 [12](12.html) 章中的故障排除提示。

在本章的前面，我们承诺了更多关于 PHP 数组使用的信息。下一节将帮助您理解这个最有用的特性的其他方面。

## 关于数组的更多信息

本书通篇都在使用数组，如果你访问论坛寻求 PHP 使用建议，你会遇到许多数组。

数组是内存中存放多个相似项目的地方(比如下面显示的谷物)。这些项目以相同的变量名(谷物)组合在一起。要引用数组中的单个元素，我们必须使用一个键(下标)。在 PHP 中，下标可以是一个数字($谷类[1])或者一个字符串(比如$row['name'])。我们将在整本书中使用这两种格式。

数组可以通过几种方式填充元素。我们创建了一个名为$谷类的数组，如下所示:

```
<?php
$cereals = array();
?>

```

可以将一些元素插入到数组中，如下所示(注意，第一个数组元素通常为零):

```
<?php
$cereals = array[];
$cereals[0] = "oats";
$cereals[1] = "barley";
$cereals[2] = "corn";
$cereals[3] = "wheat";
?>

```

若要显示该数组的元素，请在结束标记前插入以下代码。>:

```
echo "$cereals[0] " . "$cereals[1]  " . "$cereals[2]  " .  "$cereals[3]";?>

```

显示屏将显示以下内容:

燕麦大麦玉米小麦

echo 语句使用连接符号将字符串连接在一起。).但是，在 PHP 中，我们也可以将程序变量(如$name)放在引号内，如下所示:

```
$first_name = "Fred";
$middle_name = "Adam";
$last_name = "Smith";

echo "$first_name $middle_name $last_name";

```

PHP 还允许我们在不提供索引号的情况下将项目插入到一个数字数组中。

```
$error[] = "One error";
$error[] = "Another error";

```

PHP 将自动用 0 索引第一项，用 1 索引第二项。因此，我们可以显示如下值:

```
echo "$error[0] $error[1]";

```

关于数组还有很多需要学习的地方。然而，这些少量的知识应该可以帮助您理解我们在从数据库表中提取信息以及加载和显示错误消息时是如何使用数组的。

### 警告

本章中输入数据库表格的数据没有被完全过滤。它们被有意地去掉了大部分过滤器和清洁剂，因此基本的过程是整洁的，清晰可见的。越来越多的安全和过滤功能将在后面的章节中添加。

## 摘要

在这一章中，你创建了你的第一个交互式页面并测试了它们。您学到了更多关于 PHP 的知识——特别是，您应该已经掌握了在代码中寻找和识别逻辑模式的思想。您学习了如何使用几个 PHP 函数:include()、required()和 echo()。你也学到了很多 mysqli 函数。您发现了 PHP 条件对于创建交互式数据库页面的重要性。您还了解了如何在将数据发送到数据库表之前检查用户是否输入了信息。在下一章，我们将增加一些额外的安全性，并演示用户和管理员如何登录和注销网站上的个人页面。您还将学习如何删除或替换标题菜单中的冗余链接。