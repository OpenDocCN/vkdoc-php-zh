# 一、介绍

函数式编程通常不会与 PHP 联系在一起。然而，很长一段时间以来，PHP 已经具备了使用函数范式创建软件的所有必要特性。在本书中，您将了解什么是函数式编程，如何在 PHP 中实现函数式编程，以及使用函数式编程改进 PHP 软件的不同方法。

## 这本书是给谁的？

这本书本身并不是 PHP 入门；它假设您在 PHP 脚本方面有一些基本的(或者更高级的)经验。你不需要成为一个专家来跟随；我将介绍 PHP 中的所有关键概念，您需要了解这些概念才能在代码中实现功能性设计，并为您指出资源的方向，例如网站和其他书籍，您可以使用它们来学习或研究我没有直接介绍的任何相关概念。

撇开绝对的 PHP 初学者不谈，这本书适合所有程序员。无论您迫切需要学习函数式编程(也许您已经接管了函数式 PHP 代码库)，还是您只是对了解函数式编程的“热点”感兴趣，这本书都有适合您的内容。对于那些怀疑使用函数式编程范式创建软件的人来说，甚至可能有所帮助。我认为大多数程序员会从函数式编程风格中找到有用的经验和代码模式，从而增强他们的面向对象或过程式编程工作。如果所有这些都失败了，函数式编程的知识在你的简历上会很好看！

## 什么是函数式编程？

函数式编程是一种声明式编程范式，它将代码抽象成纯粹的、不可变的、无副作用的函数，允许程序员将这些函数组合在一起，以制作易于推理的程序。

这就是我对函数式编程的定义。让另外五个函数式程序员来定义函数式编程，你会得到四个以上的答案(两个只是从维基百科复制了相同的答案)。没有“标准”的定义；不同的人和不同的编程语言实现函数式编程元素是不同的。这些差异部分是因为所讨论的语言的实用性，有时是因为目标平台、数据和使用场景，但通常它们归结为我所说的“编程信仰”:一种固定的、有时不合理的、但通常是根深蒂固的关于特定范式应该如何的信念。即使在 PHP 函数式程序员的小社区中，你也不会找到一个确切的共识。在 PHP 中，函数式编程不是一个核心概念，但即使在它所在的语言中(例如 Lisp、Scala 等)。)，对于什么构成真正的函数式编程有很多“相关”的理解。虽然这听起来可能有问题，但你仍然会“当你看到它时就知道了”，当它变得模糊不清时，你可以选择以任何你认为合适的方式来定义它！

PHP 不是一门纯粹的函数式编程语言，但是你仍然可以用它来进行函数式编程(这很好；不然这本书也不会很长)。一些纯粹主义者认为基本的函数式编程概念中的一些元素很难用 PHP 的标准语法来实现，所以说可以用 PHP 中的函数式编程“风格”来编程可能更准确一些。

现在让我们更深入地看看函数式编程实际上是什么。函数式编程是一种“声明式”编程风格，这意味着您指定您希望它做什么，而不是您希望它如何做。这是比你可能习惯的面向对象或过程编程更高层次的抽象。然而，当使用 SQL、HTML、正则表达式和类似的语言时，您几乎肯定会在日常生活中使用声明式编程。考虑清单 [1-1](#Par9) 中显示的 SQL 片段。

```php
SELECT forename,

       Surname

FROM   users

WHERE  username = 'rob'

       AND password = 'password1';

Listing 1-1.
declarative.sql

```

这是告诉您的数据库服务器您希望它做什么(根据超级机密的安全凭证选择真实的名称)，但您没有告诉它如何做。你不要告诉它以下内容:

*   在磁盘的什么地方寻找数据
*   如何解析或搜索匹配记录的数据
*   如何确定记录是否符合您的标准
*   如何从记录中提取相关字段

等等。你只需告诉它你希望它为你实现什么。

很明显，在某些时候，你需要告诉计算机如何做某事。对于清单 [1-1](#Par9) 中的 SQL 示例，您可以通过让一些相当聪明的人为您编写数据库管理软件(DBMS)来实现。在函数式编程中，您往往需要自己编写实现代码，但是为了使它成为一项可管理的任务，您可以将其分解成尽可能小的块，然后使用声明性函数调用的层次链来告诉计算机如何处理该代码。如果您使用 Composer 依赖管理系统，您将已经在使用一个类似的范例:有许多代码库可以抽象出您需要做的任务；您只需简单地“组合”一个库列表来做您想做的事情。在函数式编程中，你做的完全一样；你用函数做一些事情(像库 Composer 提供的那样),然后把它们组合成一个程序。

有一个基本上是你想要实现的目标的列表的计划在纸上听起来很好，并且确实使它很容易理解和推理你的计划。为了让这个想法更具体一点，让我们看一个小的函数式程序(清单 [1-2](#Par18) )。

```php
<?php

require_once('image_functions.php');

require_once('stats_functions.php');

require_once('data_functions.php');

$csv_data = file_get_contents('my_data.csv');

$chart = make_chart_image (

                                 generate_stats (

                                         data_to_array (

                                                 $csv_data

                                                 )

                                         )

                                 );

file_put_contents('my_chart.png', $chart);

Listing 1-2.example.php

```

这显然是一些被抽象成一组函数的代码，这些函数规定了它的功能(根据从读入的一些数据中准备的一些统计数据绘制一个图表)。您可能还会看到，how 隐藏在顶部的必需文件中，但是程序做什么还是很清楚的。如果你的需求改变了，你想打印一个表格而不是绘制一个图表，你可以简单地用`print_table()`替换`draw_chart()`，很明显会发生什么。这是一个函数式程序的(非常松散的)例子。

这听起来很棒。但是，即使不考虑隐藏在所需文件中的代码，您的程序员直觉可能会告诉您，将随机函数链接在一起，并用一个替换另一个，是一个危险的提议，尤其是当您看不到它们是如何实现的时候。例如，您如何知道`read_data()`会以正确的格式返回数据供`prepare_stats()`处理？你怎么能确定你可以用`prepare_stats()`替换掉`draw_chart()`,它仍然会像你期望的那样工作？显然，函数式编程涉及的不仅仅是“用一个描述性的名称将它全部放入一个函数中”，在阅读这本书的过程中，您将看到构造函数的各种方法，这样您就可以将它们作为代码的“小黑盒”来使用，可以轻松可靠地将它们串联起来。

顾名思义，函数式编程是围绕函数进行的。然而，函数式编程意义上的函数与 PHP 语法意义上的函数并不完全相同，尽管您将使用 PHP 的函数实现来实现 FP 函数。函数式编程函数通常被称为纯函数，它有几个重要的特征，可以用 PHP 的语法来模仿，但不是强制的。纯函数具有以下特征:

*   是透明的
*   没有副作用
*   没有外部依赖性

我将在接下来的几章中更详细地讨论这些特性的含义，但它们可以归结为一个函数，即一个小型的自包含“黑盒”,它接受明确定义的输入，产生明确定义的输出，给定相同的输入总是产生相同的输出。特别是，函数只作用于给定的输入(它不考虑任何外部状态或数据，只依赖于调用它的参数)，它唯一的作用是返回一些输出(每次你给它相同的输入，输出都是相同的)；因此，它不会改变程序或系统外部的状态。

在清单 [1-2](#Par18) 中的示例程序中，如果您每次都给`read_data()`一个完全相同的 CSV 文件，并且假设您已经正确地使用了函数式编程，那么您可以确定`draw_chart()`每次都会产生完全相同的图表，而不管程序中的其他地方或您的系统上发生了什么。这种确定和推理程序流的能力为函数式编程范式带来了许多好处，随着您对实现函数式编程程序的了解越来越多，您将会发现这些好处。

### 函数式编程是可靠的

如果您来自面向对象编程背景，您可能熟悉编写 OO 代码的坚实原则。虽然是为 OOP 写的，但是扎实的原理实际上很好的体现了函数式编程的原理；事实上，有些是函数式编程定义方式所固有的。理解这些原则将有助于你理解函数式编程的一些关键特征。如果你不熟悉 SOLID，它是一个缩写词，每个字母代表优秀 OO 设计的五个基本原则之一。我将逐一介绍。

#### 单一责任原则

每个功能只负责一项任务。“做一件事，而且要做好。”在函数式编程中，你将程序分解成单任务函数。当任何其他函数需要完成该任务时，它们调用该函数。并且当该任务的规格发生变化时，只有该功能必须改变。

#### o:开放/封闭原则(OCP)

功能应该“对扩展开放，对修改关闭”在函数式编程中，这意味着当您需要扩展一个函数的行为时，您不需要修改现有的函数，而是将它与创建新的扩展功能的其他函数组合在一起(或从其他函数调用它)。

#### 李斯科夫替代原理

在面向对象的程序设计中，这个原则处理用一个对象的子类型的实例替换该对象的能力。在函数式编程中，这最精确地映射到一个叫做函子逆变的概念上，这个概念比你在本书中学到的更高级(理论性更强，实用性更弱)。但是，您将会看到一个类似的相关原则，即引用透明性。这基本上意味着，不管程序中发生了什么，给定的函数(带有给定的输入)可以用它在程序中返回的值来替换，程序将继续按预期运行。

#### I:接口隔离原则(ISP)

这个原则意味着调用一个函数所需要的参数应该仅仅是你正在执行的任务所需要的参数。函数的接口应该尽可能具体地分解，而不是提供包含与调用客户端代码的意图无关的参数的通用接口。由于高效组合所需的结构化接口，函数式编程在分解成单个责任函数时几乎默认实现了这一点。

#### 依赖倒置原则(DIP)

这项原则声明如下:

*   高层模块不应该依赖低层模块。两者都应该依赖于抽象。
*   抽象不应该依赖于细节。细节应该依赖于抽象。

这或多或少就是声明式编程的定义。您的具有实现细节的低级函数形成了一个抽象，您的高级“声明性”函数可以在其上操作。

如果所有这些原则和术语现在都没有意义，不要担心；当你阅读这本书的时候，只要记住它们(或者在需要的时候参考它们)，到最后你应该能够看到这些坚实的原则是如何自然地应用于函数式编程范例的。

#### 进一步阅读

*   维基百科上的坚实原则
    *   [T2`https://en.wikipedia.org/wiki/SOLID_(object-oriented_design)`](https://en.wikipedia.org/wiki/SOLID_(object-oriented_design))

### 函数式编程有什么好处？

我已经谈到了一些好处。但是如果还不清楚的话，这些是大多数程序员从使用函数式编程技术中获得的主要好处:

*   您将创建易于推理的代码。这意味着它不容易出错，更容易更新，更容易理解代码流。
*   您将创建更易于测试的代码。这是函数式编程范式的一些属性的副作用，例如不变性、引用透明性和缺乏外部依赖性。
*   您可以使用延迟评估、并行化和缓存等技术来创建更高性能的代码。

### 谁使用函数式编程，为什么？

大约 20 多年前，当我在大学攻读计算机科学学位时，我第一次学习了函数式编程。当时我真的没有看到它的意义，并且因为我对学习它缺乏兴趣而在那门课上得了一个很差的分数，因为我不明白为什么有人会想在“现实生活”中使用它。当时，除了学术界和某些高度专业化的领域，如工程和金融，它没有被广泛使用。然而，随着时间的推移，这种情况发生了变化，现在使用函数式编程的人比你想象的要多，原因多种多样。

如今，它在主流 It 的许多领域都很突出，而不仅仅是在专门的行业、学术界和由“硅谷潮人”经营的初创公司！网飞、LinkedIn 和 Twitter 等大公司使用函数式编程来大规模交付健壮的服务。有些人用它是因为它很容易推理。有些人使用它是因为它没有“副作用”,易于并行化和扩展。有些人使用它是因为它巧妙地映射到了在工程、数据科学和金融等不同领域中使用的数学结构。它正在一些行业中使用，因为它的声明性允许创建特定于领域的语言(DSL)。DSL 允许不太熟练的用户创建或理解程序，允许更容易地将业务需求和过程映射到软件中，并通过提供特定于任务的抽象来提高程序员的生产率。

在过去的几年里，函数式编程已经获得了越来越多的关注。像 rack、Clojure 和 F#这样的现代函数式语言正在构建 steam，甚至 PHP 也加入了进来，GitHub 和 Composer 上的函数式编程库越来越多。

虽然函数式编程目前是现代计算领域的热门话题，但它在计算领域的历史可以追溯到 20 世纪 50 年代的 Lisp，而 lambda 演算(函数式编程所基于的数学抽象)和更抽象的组合逻辑领域则始于 20 世纪 20 年代和 30 年代。无论是直接在 Lisp 和 Scheme 这样的语言中，还是间接在大多数编程语言中编写的函数式代码中，函数式编程多年来已经对许多计算领域产生了影响。很多公司写函数式编程代码，日复一日的依赖函数式编程软件(不管他们有没有意识到！).

### 函数式编程是“要么全有，要么全无”吗？

当人们开始学习函数式编程时，他们经常会问自己是否需要撕掉旧的 OOP 代码，从头开始。我的答案是否定的(尽管纯粹主义者会说是)。函数式编程可以愉快地与 OOP 或过程式代码共存，或者实际上与任何其他编程范式共存，只要您了解函数式编程代码的开始和结束位置。由于函数式编程的本质，将函数式编程结构放在对象或传统函数/过程代码块中通常更容易，而不是反过来。

可以从函数式编程中受益的特定代码部分(例如业务逻辑流程和高性能算法)通常是将函数式编程引入代码库的良好起点。因为函数式编程不是 PHP 的核心特性，所以它实际上更容易按照你认为合适的方式混合和匹配范例。在其他传统的函数式编程语言中，事情有更多的限制；例如，Haskell 没有任何面向对象的能力，而 F#是围绕特定的 FP-OO 混合范式编写的。函数式编程与 OOP 有许多共同之处；事实上，闭包(与相关程序状态打包在一起的函数)有点类似于流线型对象，许多 OO 编程模式中的程序流控制有点模仿流的函数式编程风格。和往常一样，PHP 很灵活，它说“做你想做的”，这既是一种祝福，也是一种诅咒(如果你做得不对)。不过，这是对 PHP 的一个普遍抱怨，只要始终正确编程就能简单解决！

如果您有兴趣了解人们多年来提出的不同编程范例之间的差异，那么 Wikipedia 已经为您提供了每种范例主要特性的全面比较。请注意，PHP 是一种“图灵完全”语言，这基本上意味着如果某个东西可以计算，那么 PHP 就可以计算它。这也意味着所描述的任何范例都可以在 PHP 中实现(您是否愿意是另一回事，尽管我认为大多数范例至少提供了一些好的程序员可以在适当的时候添加到他们的心理工具箱中使用的东西)。如果这本书激起了你用不同方式做事的欲望，那么也许你可以查看维基百科的列表，找到更多混合代码的方法。

### 进一步阅读

*   维基百科编程范式的比较
    *   [T2`https://en.wikipedia.org/wiki/Comparison_of_programming_paradigms`](https://en.wikipedia.org/wiki/Comparison_of_programming_paradigms)

## 为什么要用 PHP 进行函数式编程？

差不多每个听过这本书书名的人都跟我说过“你不用 PHP 做函数式编程”(除了我老婆，她说“那听起来超级无聊”)。嗯，他们都错了(包括我老婆)。绝对没有理由不使用 PHP(除了“为什么不使用 PHP 进行函数式编程”一节中列出的原因)。而且也不是超级无聊。

说真的，PHP 拥有编写好的函数式编程代码所需的一切。它有一流的函数支持，有帮助抽象样板代码的库，并且有越来越多的可用文档和帮助(包括您现在正在阅读的这本书)。但最重要的是，你已经知道了 PHP。你正在学习一种新的编程范式，那么为什么要同时让自己承担掌握一门新语言的负担呢？事实上，如果您首先在已经熟悉的环境中了解这种范式，您可能会发现以后更容易掌握更专业的函数式编程语言，如 Haskell，其中的语言特性隐含地依赖于您对函数式编程范式的熟悉。

也许如果你对编程一点都不熟悉，而想学习函数式编程，从 Haskell 这样的东西开始可能就可以了。但是你带着熟悉面向对象或过程编程的包袱而来，一种纯粹的函数式编程语言对你来说会感到陌生，直到你对函数式编程这个概念感到舒服为止。你将会浪费大量的时间去尝试实现函数式编程世界中不存在的特性和结构，而不是去写代码。

## 为什么不使用 PHP 进行函数式编程

有一两种情况下，以这种方式使用 PHP 可能不是一个好主意(只是不要告诉任何人我这么说)。

*   您有一个特殊的业务案例/需求，只使用函数式编程。在 PHP 中，没有什么可以阻止你混合编程范式，有时这样做很诱人(或者很实用)。因此，如果你需要确保你坚持使用函数式编程代码，那么最好不要使用 PHP。
*   你需要一流的商业支持。如前所述，PHP 社区中对函数式编程的支持越来越多，质量越来越高。但是“传统的”函数式编程语言有更多，特别是在付费商业支持领域。
*   你认为 PHP 正在消亡，有严重的问题，或者不是一种真正的编程语言。一些人仍然持有这些观点，即使 PHP 越来越强大。然而，如果提到 PHP 就让你感到刺痛，那么在 PHP 中用函数式编程实现你的程序不会神奇地让这种感觉消失。当你在读这本书的时候，更有可能的是你并没有那样的感觉，而是你周围的人(你的老板或者同事？)可能，尽管这本书很精彩，但它不太可能动摇他们对 PHP 本身的看法。在这种情况下，你可能需要做一些务实的事情——辞职，像我一样创办自己的公司。
*   你的同事不懂函数式编程，所以你的代码对他们来说可能更难维护。这很容易解决:给他们买一本这本书！

## PHP 版本

在撰写本文时，PHP 当前的稳定版本是 7.1.2，如果这是每个人都在运行的版本，那就太好了。然而，事实并非如此；事实上，从 5.2 开始的 PHP 版本可以在主机提供商和公司内部的主流应用中找到。人们使用更旧版本的故事在互联网的黑暗角落比比皆是，由于安全更新仅适用于 5.6 及更高版本，这样的故事是噩梦的素材。那么，对于函数式编程，你应该选择哪个版本呢？

本书中的所有代码都是在 PHP 7.1 的当前版本上开发和测试的。然而，从 5.4 开始，大部分代码只需稍加修改就可以在任何版本上运行。早于 5.4 的版本缺乏对匿名函数和闭包的语言支持，这意味着函数式编程不实用。我将在整本书中指出版本支持之间的任何差异，其中最值得注意的是 series 5 版本中缺乏对标量变量的类型声明(也称为类型提示)的支持。请注意，对上一个 5.x 版本(5.6)的“积极支持”现已结束，“仅安全修复”支持将于 2018 年底撤销，因此如果可能，强烈建议使用 7.x 版本。以及 PHP 维护人员的持续支持，您会发现 PHP 7 较低的资源需求将有助于 PHP 函数式编程的某些领域，如递归。也就是说，您可以在 PHP 5 中进行函数式编程，许多工作场所中不可避免的升级延迟可能意味着您没有选择使用 5.x 版本，因此我将尽最大努力来涵盖这些差异。

## 结论

在这一章中，你开始了解什么是函数式编程，以及为什么它在你的 PHP 开发中有用。从这种抽象的讨论中很难理解函数式编程，所以如果您还没有“理解”它，请不要担心。当您阅读接下来的几章时，您会对它有更好的感觉，因为您看到了它背后的编程概念和函数代码的例子。