# 5.扩展和丰富你的网站

本章中的教程假设网站用户正在申请一个需要会费的组织的会员资格，例如，一个政党或一个保护协会。

这些组织的网站数据库需要其成员的地址，可能还需要他们的电话号码。这些表单还可以使用下拉菜单来允许用户选择成员资格类别。

您可能已经亲身经历过，注册表单包含许多字段；有些是必需的，有些是可选的。本章处理的注册表单比前几章大，有两个字段是可选的。

完成本章后，您将能够

*   创建一个包含两个表的数据库

*   理解文档的重要性

*   创建一个带有下拉菜单的扩展注册表

*   添加 PayPal 和借记卡/信用卡信息

*   创建可变定价显示

*   对记录的显示应用分页

*   创建编辑记录的代码

第一步是创建一个新的数据库。

## 创建一个新的数据库、一个有 15 列的表和一个价格表

按照以下步骤创建一个新数据库和两个表:

1.  打开 XAMPP *htdocs* 或 easyPHP *eds-www* 文件夹，新建一个名为*邮政*的文件夹。

2.  从本书的网站 [`www.apress.com`](http://www.apress.com) 下载第 [5 章](05.html)的文件，并将文件放在新的*邮政*文件夹下的 *htdocs* 或 *eds-www* 中。如果你想手工编码你的文件，从章节 [4](04.html) 中复制文件并粘贴到你的新*邮政*文件夹中。然后修改代码以匹配本章中列出的修订后的代码。还要将 *mysqli_connect.php* 中的数据库改为 postaldb。

    ### 注意

    如前几章所述，如果从电子书中复制代码，将代码粘贴到基本编辑器(如记事本)中，以确保所有引用都是标准引用。保存代码，然后在 PHP 编辑器(如 Notepad++)中重新打开代码。

3.  使用浏览器访问 phpMyAdmin，单击 Databases 选项卡，创建一个名为 *postaldb* 的新数据库。从编码选项中选择 utf8-通用-ci。

4.  在下一个屏幕中，创建一个名为 *users* 的表，输入 **15** 作为列数，然后单击 Go(在 phpMyAdmin 的某些版本中单击 Submit)。输入表 [5-1](#Tab1) 所示的信息。创建了 users 表之后，单击左列中数据库名称 *postaldb* 下面的新列表。这将显示新表格页面。创建另一个名为 *prices* 的表，输入 **10** 作为列数，然后单击 Go。输入表 [5-2](#Tab2) 中显示的信息。同样输入表 [5-2](#Tab2) 中所示的数值。

5.  单击检查权限，然后向下滚动并单击添加用户帐户。现在添加一个新的用户和密码，如下所示:

    *   *用户名*:詹纳

    *   *主机*:本地主机

    *   *密码* : Vacc1nat10n

    向下滚动并单击“全局权限”旁边的“全部选中”。

1.  滚动到底部，然后单击开始。

### 创建用于连接到数据库的文件

将以下文件命名为 *mysqli_connect.php* (或从 [`www.apress.com`](http://www.apress.com) 下载)，并添加到 *htdocs* 文件夹中的*邮政*文件夹中:

```php
<?php
// Create a connection to the postaldb database
// Set the encoding to utf-8
// Set the database access details as constants
Define ('DB_USER', 'jenner');
Define ('DB_PASSWORD', 'Vacc1nat10n');
Define ('DB_HOST', 'localhost');
Define ('DB_NAME', 'postaldb');
// Make the connection
$dbcon = new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);
mysqli_set_charset($dbcon, 'utf8'); // Set the encoding...

```

测试您的连接(*http://localhost/postal/mysqli _ connect . PHP*)。请记住，如果您在屏幕上看不到任何内容，则您的连接是成功的。

接下来，如果您还没有这样做，请按照下一节中的描述创建包含列和属性的表。当您成功输入表 [5-1](#Tab1) 中的信息后，向下滚动到 phpMyAdmin 页面的底部，然后单击 Go(或 Submit)。

### 创建表

我们现在将创建一个适用于需要地址和电话号码的会员数据库的表。数据库表还将包括额外的项目，以方便管理员。这些是会员的类别和一个指示会员是否已支付订阅费的字段。该表将包含标题和属性如表 [5-1](#Tab1) 所示的列。

表 5-1

用户表的标题和属性

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"> <col class="tcol5 align-left"> <col class="tcol6 align-left"> <col class="tcol7 align-left"> <col class="tcol8 align-left"></colgroup> 
| 

列名

 | 

类型

 | 

长度/值

 | 

默认

 | 

属性

 | 

空

 | 

索引

 | 

阿奇

 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 使用者辩证码 | 中位 | six | 没有人 | 无符号的 | -是吗 | 主要的 | ·······················。 |
| 名字 | 可变长字符串 | Thirty | 没有人 |   | -是吗 |   | -是吗 |
| 姓氏 | 可变长字符串 | Forty | 没有人 |   | -是吗 |   | -是吗 |
| 电子邮件 | 可变长字符串 | Fifty | 没有人 |   | -是吗 |   | -是吗 |
| 密码 | 茶 | Sixty | 没有人 |   | -是吗 |   | -是吗 |
| 注册日期 | DATETIME |   | 没有人 |   | -是吗 |   | -是吗 |
| 用户级别 | 蒂尼因特 | one | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| 班级 | 茶 | Twenty | 没有人 |   | -是吗 |   | -是吗 |
| 地址 1 | 可变长字符串 | Fifty | 没有人 |   | -是吗 |   | -是吗 |
| 地址 2 | 可变长字符串 | Fifty | 没有人 |   | ·······················。 |   | -是吗 |
| 城市 | 可变长字符串 | Fifty | 没有人 |   | -是吗 |   | -是吗 |
| 州 _ 国家 | 茶 | Twenty-five | 没有人 |   | -是吗 |   | -是吗 |
| S7-1200 可编程控制器 | 茶 | Ten | 没有人 |   | -是吗 |   | -是吗 |
| 电话 | 茶 | Fifteen | 没有人 |   | ·······················。 |   | -是吗 |
| 有报酬的 | ENUM | “是”，“不是” | 没有人 |   | -是吗 |   | -是吗 |

请注意，address2(第二个地址)和 phone 列选择了它们的空索引框。它们是可选字段。NULL 仅仅意味着用户可以将一个字段留空。许多用户可能没有额外的地址(例如大城市的一个区或一个公寓号码)。一些用户不想公开他们的电话号码，以减少陌生来电者带来的麻烦。

虽然邮政编码与该人居住的城市直接相关，但最好包括城市和州或国家信息，以验证是否输入了正确的代码。

想注册成为会员的人需要付费。然而，费用会随着时间而变化。为了避免每次有价格调整时都要求开发人员进行更改，我们将把价格存储在一个表中，并在需要时检索它们。这将允许网站管理员在数据库中进行价格更改，价格将立即出现在页面上。我们也可以为管理员创建一个价格变化页面，但我们会留给你去开发。

表 5-2

价格表的标题和属性

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"> <col class="tcol5 align-left"> <col class="tcol6 align-left"> <col class="tcol7 align-left"> <col class="tcol8 align-left"></colgroup> 
| 

列名

 | 

类型

 | 

长度/值

 | 

默认

 | 

属性

 | 

空

 | 

索引

 | 

阿奇

 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 一年 b | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| 一岁 | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| 五年 b | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| 五年 | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| 军队 | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| 美国军方 | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| u21gb | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| u21us | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| 最低价格 b | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |
| minpriceus | 小数 | six | 没有人 | 无符号的 | -是吗 |   | -是吗 |

表 [5-2](#Tab2) 显示了价格表的详细信息

创建价格表后，单击 phpMyAdmin 中的 Insert 选项卡，并在每个单元格的值文本框中输入数字，如下所示。然后单击 Go 按钮将值保存到表中。

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"> <col class="tcol5 align-left"> <col class="tcol6 align-left"></colgroup> 
| 

**one year GB**30:00

 |   | 

**one year**40:00

 |   | 

**fife year GB**125.00

 |   |
| --- | --- | --- | --- | --- | --- |
| **fife year GB**140.00 | **军用 gb** 5.00 |   | **军事人员**上午 8 点 |   |   |
| **u21gb** 2.00 |   | **u21us** 3.00 |   |   | 最低价格 gb 15.00 |
|   |   |   | **矿山精度** 20 点 |   |   |

### 使用枚举

ENUM(枚举)提供了列出要输入到数据库中的有效选项的能力。它确保只有您指定的值才能存储在表中的该单元格中。在我们的教程中，只能输入否或是。选项必须用逗号分隔，并且每个选项必须用单引号或双引号括起来。您可以在框中键入值，或者单击框下方的链接。如果您单击编辑枚举/设置值链接，您可以键入一个值列表，系统将为您添加引号和逗号。如果为“已付”列选择 NOT NULL，则第一个值(否)将是默认值。如果为枚举列选择空框，则空字段将是有效值。

## 文件的重要性

因为数据库变得越来越复杂，所以您必须继续记录您所做的一切。如果你不这样做，你会花很多不愉快的时间去想你做了什么，为什么某些改变不起作用。对于许多页面来说尤其如此，就像在当前项目中一样。记住，数据库管理员负责许多数据库。数据库或表的调整可能需要几个月或几年的时间。即使站长创建了原始数据库，也不太可能记得原始设计。通过创建设计文档，它将帮助网站管理员快速记住或理解逻辑，并做出任何必要的更改。

我们建议在笔记本(物理或电子)中仔细记录。创建显示数据库和程序之间逻辑关系的流程图；事实上，没有流程图是很难工作的。图表通常会延伸几页。您可能想要打印图表并将它们粘贴在一起。当团队重新设计应用程序及其数据库的逻辑时，在会议室的墙上放置图表并不罕见。许多人还把图表放在一个共享系统中，比如微软的 SharePoint。通过使用这种类型的系统，设计团队可以很容易地跟踪不同的版本。

下面的示例图表显示了所有页面、页面标题、页眉以及页面之间的链接。随着工作的进展，通过纠正错误、添加页面和添加客户要求的任何新功能来修改流程图。在开发数据库驱动的网站时，修改图表是至关重要的。作为一个练习，您可以修改这个例子来包含价格表。

图 [5-1](#Fig1) 显示了示例流程图的一小部分。

![../images/314857_2_En_5_Chapter/314857_2_En_5_Fig1_HTML.jpg](../images/314857_2_En_5_Chapter/314857_2_En_5_Fig1_HTML.jpg)

图 5-1

流程图的一小部分

商业程序可用于创建流程图，但您可以使用 Microsoft Word 中的绘图工具栏和文本框。菱形文本框表示决策结构(开关)。图 [5-1](#Fig1) 所示流程图中的结构决定了成员的 user_level，并将代码逻辑切换到成员或管理员页面。互联网上有许多免费教程和视频可以演示如何创建流程图。Visio 是具有许多附加功能的付费替代产品；要获得优秀的免费程序，请尝试使用以下网站的图表设计器:

[http:// meesoft。逻辑学家。dk/](http://meesoft.logicnet.dk/)

更多免费流程图程序可在 [`www.download.com`](http://www.download.com) 找到。

现在让我们根据前面教程中使用的代码创建一个注册页面。我们将调整代码，在新表中包含额外的字段。代码还将提供一个下拉选择菜单。注册页面将显示 12 个字段；其他字段将对用户隐藏。

## 扩展注册表单并添加下拉菜单

图 [5-2](#Fig2) 显示了扩展注册页面。

![../images/314857_2_En_5_Chapter/314857_2_En_5_Fig2_HTML.jpg](../images/314857_2_En_5_Chapter/314857_2_En_5_Fig2_HTML.jpg)

图 5-2

扩展注册页面

必填字段标有星号。当正确填写字段并单击注册按钮时，用户将被带到一个包含 PayPal 支付按钮和徽标的“谢谢”页面。然后，用户将通过 PayPal 或借记卡/信用卡支付适当的注册费。

### 总是提前宣布价格和费用支付

始终预先声明全部费用和可用的付款方式。这现在是英国的一项法律要求。在世界上的其他地方，这可能不是法律要求，但你应该总是提前申报所有费用。如果在交易结束时突然宣布额外费用，用户会变得不耐烦。他们通常会不付钱就关闭你的网站。除了说明费用，我们还会添加一张 PayPal 提供的图片，显示各种可接受的信用卡。但是，用户只有在提交注册表格并出现“谢谢”页面后才能付款。

### 注意

如前所述，网站必须符合所在国的规定。这可能需要不同国家的不同网站。

注册页面现在包含 12 个可见字段和隐藏字段。隐藏字段是注册日期和已支付。隐藏字段在用户屏幕上显示的页面上不可见，因为它们只与管理员相关。清单 [5-1a](#PC3) 显示了新字段。

```php
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Register Page</title>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS File -->
  <link rel="stylesheet"
  href=
"https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
  integrity=
"sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
  crossorigin="anonymous">
   <script src="verify.js"></script>
</head>
<body>
<div class="container" style="margin-top:30px">
<!-- Header Section -->
<header class="jumbotron text-center row col-sm-14"
style="margin-bottom:2px; background:linear-gradient(white, #0073e6);
       padding:20px;">
       <?php include('register-header.php'); ?>
</header>
<!-- Body Section -->
  <div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
  <nav class="col-sm-2">
      <ul class="nav nav-pills flex-column">
               <?php include('nav.php'); ?>
      </ul>
  </nav>
<!-- Validate Input -->
<?php
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
 require('process-register-page.php');
} // End of the main Submit conditional.
?>
<div class="col-sm-8">
<h2 class="h2 text-center">Register</h2>
<h3 class="text-center">Items marked with an asterisk * are required</h3>
<?php
try {
        require_once ("mysqli_connect.php");$query = "SELECT * FROM prices";          //#1
        $result = mysqli_query ($dbcon, $query); // Run the query.
        if ($result) { // If it ran OK, display the records.
               $row = mysqli_fetch_array($result, MYSQLI_NUM);
               $yearsarray = array(
               "Standard one year:", "Standard five year:",
               "Military one year:", "Under 21 one year:",
               "Other - Give what you can. Maybe:" );
echo '<h6 class="text-center text-danger">Membership classes:</h6>' ;
echo '<h6 class="text-center text-danger small"> ';
for ($j = 0, $i = 0; $j < 5; $j++, $i = $i + 2) {
        echo $yearsarray[$j] . " &pound; " .
               htmlspecialchars($row[$i], ENT_QUOTES)  .
               " GB, &dollar; " .
               htmlspecialchars($row[$i + 1], ENT_QUOTES) .
               " US";
        if ($j != 4) {
        if ($j % 2 == 0) {
               echo "</h6><h6 class='text-center text-danger small'>"; }
        else {
               echo " , "; }
        }
}
echo "</h6>";
}
?>
<form action="register-page.php" method="post" onsubmit="return checked();"
        name="regform" id="regform">
<div class="form-group row">
    <label for="first_name" class="col-sm-4 col-form-label">
        *First Name:</label>
<div class="col-sm-8">
      <input type="text" class="form-control" id="first_name"
        name="first_name"
        placeholder="First Name" maxlength="30" required
        value=
               "<?php if (isset($_POST['first_name']))
               echo htmlspecialchars($_POST['first_name'], ENT_QUOTES); ?>" >
</div>
  </div>
  <div class="form-group row">
  <label for="last_name" class="col-sm-4 col-form-label">*Last Name:</label>
  <div class="col-sm-8">
      <input type="text" class="form-control" id="last_name" name="last_name"
               placeholder="Last Name" maxlength="40" required
               value=
                              "<?php if (isset($_POST['last_name']))
               echo htmlspecialchars($_POST['last_name'], ENT_QUOTES); ?>" >
  </div>
  </div>
  <div class="form-group row">
       <label for="email" class="col-sm-4 col-form-label">*E-mail:</label>
  <div class="col-sm-8">
       <input type="email" class="form-control" id="email" name="email"
               placeholder="E-mail" maxlength="60" required
               value=
                       "<?php if (isset($_POST['email']))
               echo htmlspecialchars($_POST['email'], ENT_QUOTES); ?>" >
  </div>
  </div>
  <div class="form-group row">
       <label for="password1"
                class="col-sm-4 col-form-label">*Password:</label>
  <div class="col-sm-8">
      <input type="password" class="form-control" id="password1"
        name="password1"
        placeholder="Password" minlength="8" maxlength="12" required
               value=
                       "<?php if (isset($_POST['password1']))
               echo htmlspecialchars($_POST['password1'], ENT_QUOTES); ?>" >
        <span id="message">Between 8 and 12 characters.</span>
  </div>
  </div>
  <div class="form-group row">
        <label for="password2" class="col-sm-4 col-form-label">
               *Confirm Password:</label>
  <div class="col-sm-8">
      <input type="password" class="form-control" id="password2"
        name="password2"
        placeholder="Confirm Password" minlength="8" maxlength="12" required
               value=
                       "<?php if (isset($_POST['password2']))
               echo htmlspecialchars($_POST['password2'], ENT_QUOTES); ?>" >
  </div>
  </div>
  <div class="form-group row">
        <label for="level" class="col-sm-4 col-form-label">
               *Membership Class</label>
  <div class="col-sm-8">                                                       <!--#2-->
               <select id="level" name="level" class="form-control" required>
               <option value="0" >-Select-</option>
<?php
        for ($j = 0, $i = 0; $j < 5; $j++, $i = $i + 2) {
               echo '<option value="' .
               htmlspecialchars($row[$i], ENT_QUOTES) . '" ';
        if ((isset($_POST['level'])) && ( $_POST['level'] == $row[$i]))
               {
        ?>
               selected
        <?php }
        echo ">" . $yearsarray[$j] . " " .
            htmlspecialchars($row[$i], ENT_QUOTES) .
               " &pound; GB, " .
                htmlspecialchars($row[$i + 1], ENT_QUOTES) .
                "&dollar; US</option>";
}
?>
</select>
</div>
</div>
<div class="form-group row">                                                   <!--#3-->
    <label for="address1" class="col-sm-4 col-form-label">*Address:</label>
<div class="col-sm-8">
      <input type="text" class="form-control" id="address1" name="address1"
          placeholder="Address" maxlength="30" required
               value=
                       "<?php if (isset($_POST['address1']))
               echo htmlspecialchars($_POST['address1'], ENT_QUOTES); ?>" >
</div>
</div>
<div class="form-group row">
    <label for="address2" class="col-sm-4 col-form-label">Address:</label>
<div class="col-sm-8">
      <input type="text" class="form-control" id="address2" name="address2"
          placeholder="Address" maxlength="30"
               value=
                       "<?php if (isset($_POST['address2']))
               echo htmlspecialchars($_POST['address2'], ENT_QUOTES); ?>" >
</div>
</div>
<div class="form-group row">
    <label for="city" class="col-sm-4 col-form-label">*City:</label>
<div class="col-sm-8">
      <input type="text" class="form-control" id="city" name="city"
          placeholder="City" maxlength="30" required
               value=
                       "<?php if (isset($_POST['city']))
               echo htmlspecialchars($_POST['city'], ENT_QUOTES); ?>" >
  </div>
  </div>
  <div class="form-group row">
    <label for="state_country"
        class="col-sm-4 col-form-label">*State/Country:</label>
  <div class="col-sm-8">
      <input type="text" class="form-control"
               id="state_country" name="state_country"
               placeholder="State or Country" maxlength="30" required
               value=
                       "<?php if (isset($_POST['state_country']))
               echo htmlspecialchars($_POST['state_country'], ENT_QUOTES); ?>" >
  </div>
  </div>
  <div class="form-group row">
    <label for="zcode_pcode" class="col-sm-4 col-form-label">
               *Zip Code/Post Code:</label>
    <div class="col-sm-8">
               <input type="text" class="form-control" id="zcode_pcode"
                       name="zcode_pcode"
               placeholder="Zip Code or Postal Code" maxlength="15" required
               value=
                       "<?php if (isset($_POST['zcode_pcode']))
               echo htmlspecialchars($_POST['zcode_pcode'], ENT_QUOTES); ?>" >
  </div>
  </div>
  <div class="form-group row">
        <label for="phone" class="col-sm-4 col-form-label">
               Phone Number:</label>
  <div class="col-sm-8">
      <input type="tel" class="form-control" id="phone" name="phone"
               placeholder="Phone Number" maxlength="30"
               value=
                       "<?php if (isset($_POST['phone']))
               echo htmlspecialchars($_POST['phone'], ENT_QUOTES); ?>" >
  </div>
  </div>
  <div class="form-group row">
        <label for="" class="col-sm-4 col-form-label"></label>
  <div class="col-sm-8">
        <input id="submit" class="btn btn-primary" type="submit"
               name="submit" value="Register">
  </div>
  </div>
</form>
</div>
<!-- Right-side Column Content Section -->
<?php

 if(!isset($errorstring)) {
        echo '<aside class="col-sm-2">';
        include('info-col-cards.php');
        echo '</aside>';
        echo '</div>';
        echo '<footer class="jumbotron text-center row col-sm-14"
                style="padding-bottom:1px; padding-top:8px;">';
 }
 else
 {
        echo '<footer class="jumbotron text-center col-sm-12"
        style="padding-bottom:1px; padding-top:8px;">';
 }
        include('footer.php');
        echo "</footer>";
        echo "</div>";
  }
catch(Exception $e) // We finally handle any problems here
   {
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
   }
catch(Error $e)
   {
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
   }
 ?>
</body>
</html>

Listing 5-1aCreating the New

Registration Page with 12 Visible Fields (register-page.php)

```

### 代码的解释

本节解释代码。

```php
$query = "SELECT * FROM prices";                                              //#1
$result = mysqli_query ($dbcon, $query); // Run the query.
if ($result) { // If it ran OK, display the records.
        $row = mysqli_fetch_array($result, MYSQLI_NUM);

```

所有的价格都从 prices 表中提取出来，创建一个名为 *$row* 的数字索引数组。

```php
$yearsarray = array(
"Standard one year:", "Standard five year:",
"Military one year:", "Under 21 one year:",
"Other - Give what you can. Maybe:" );

```

创建一个数组$yearsarray 来保存不同类的文本。在大多数编程语言中，不能更改用这种格式创建的数组的内容。然而，在 PHP 中你可以。

```php
echo '<h6 class="text-center text-danger">Membership classes:</h6>' ;
echo '<h6 class="text-center text-danger small"> ';
for ($j = 0, $i = 0; $j < 5; $j++, $i = $i + 2) {

```

在 PHP 中，一个 for 循环可以有多个索引，每个索引可以单独递增或递减。在这个例子中，$j 每次增加 1，而$i 每次增加 2。每个单一描述(标准一年)有两个值(GB 和 US)。因此，当描述一次改变一个时，价格跳升两个位置。

```php
       echo $yearsarray[$j] . " &pound; " .
               htmlspecialchars($row[$i], ENT_QUOTES)  .
               " GB, &dollar; " .
               htmlspecialchars($row[$i + 1], ENT_QUOTES) .
               " US";
$j is controlling the description. $i is controlling the two prices to be displayed.
        if ($j != 4) {
        if ($j % 2 == 0) {
               echo "</h6><h6 class='text-center text-danger small'>"; }
        else {
               echo " , "; }
        }

```

对于$J 的每两次跳转(这样我们可以在一行上有两个描述)，我们关闭行()并为下一个描述打开一个新行，除非$j 是 4。这将表明没有另一个描述，所以我们不需要开始一个新的行。

```php
}
echo "</h6>";
}
At the end we close the line of the last description.
<div class="col-sm-8">                                                          <!--#2-->
               <select id="level" name="level" class="form-control" required>
               <option value="0" >-Select-</option>
<?php
        for ($j = 0, $i = 0; $j < 5; $j++, $i = $i + 2) {
               echo '<option value="' .
               htmlspecialchars($row[$i], ENT_QUOTES) . '" ';
        if ((isset($_POST['level'])) && ( $_POST['level'] == $row[$i]))
               {
        ?>
               selected
        <?php }
        echo ">" . $yearsarray[$j] . " " .
           htmlspecialchars($row[$i], ENT_QUOTES) .
               " &pound; GB, " .
                htmlspecialchars($row[$i + 1], ENT_QUOTES) .
                "&dollar; US</option>";
}
?>
</select>

```

本例的信息循环和控制与上例相似。但是，我们正在为表单创建一个 select 语句。请注意，代码会检查用户之前是否选择了一个级别。如果是，它会将“selected”放在为该级别创建的选项语句中(如标准的一年)。注意，要使 selected 在表单上正确工作，它不能在 PHP 代码的 echo 语句中。

```php
<div class="form-group row">                                                  <!--#3-->
    <label for="address1" class="col-sm-4 col-form-label">*Address:</label>
<div class="col-sm-8">
      <input type="text" class="form-control" id="address1" name="address1"
         placeholder="Address" maxlength="30" required
               value=
                       "<?php if (isset($_POST['address1']))
               echo htmlspecialchars($_POST['address1'], ENT_QUOTES); ?>" >
</div>
</div>

```

表单中附加字段的 HTML 代码与我们之前看到的格式相同。在使用 PHP 对输入标签进行消毒之后，输入标签会将用户输入的任何内容粘回到表单中。

```php
<?php
// This script is a query that INSERTs a record in the users table.
// Check that form has been submitted:
try {
        $errors = array(); // Initialize an error array.
        // Check for a first name:
        $first_name =
        filter_var( $_POST['first_name'], FILTER_SANITIZE_STRING);
        if (empty($first_name)) {
                $errors[] = 'You forgot to enter your first name.';
        }
        // Check for a last name:
           $last_name =
        filter_var( $_POST['last_name'], FILTER_SANITIZE_STRING);
        if (empty($last_name)) {
                $errors[] = 'You forgot to enter your last name.';
        }
        // Check for an email address:
           $email = filter_var( $_POST['email'], FILTER_SANITIZE_EMAIL);
        if  ((empty($email)) || (!filter_var($email, FILTER_VALIDATE_EMAIL))) {
                $errors[] = 'You forgot to enter your email address';
                $errors[] = ' or the e-mail format is incorrect.';
        }
        // Check for a password and match against the confirmed password:
                       $password1 =
        filter_var( $_POST['password1'], FILTER_SANITIZE_STRING);
                       $password2 = f
        ilter_var( $_POST['password2'], FILTER_SANITIZE_STRING);
        if (!empty($password1)) {
               if ($password1 !== $password2) {
                       $errors[] = 'Your two password did not match.';
               }
        } else {
               $errors[] = 'You forgot to enter your password(s).';
        }
        // Check for an membership class
        if(isset($_POST['level'])) {
               $class =
               filter_var( $_POST['level'], FILTER_SANITIZE_STRING); }
        if (empty($class)) {
               $errors[] = 'Please choose your membership class.';
        }
        // Check for address:
               $address1 =
                       filter_var( $_POST['address1'], FILTER_SANITIZE_STRING);
        if (empty($address1)) {
               $errors[] = 'You forgot to enter your address.';
        }
        // Check for address2:                                                        #1
               $address2 =
               filter_var( $_POST['address2'], FILTER_SANITIZE_STRING);
        if (empty($address2)) {
               $address2 = NULL;
        }
        // Check for city:
               $city =
                       filter_var( $_POST['city'], FILTER_SANITIZE_STRING);
        if (empty($city)) {
               $errors[] = 'You forgot to enter your City.';
        }
// Check for the county:
               $state_country =
               filter_var( $_POST['state_country'], FILTER_SANITIZE_STRING);
        if (empty($state_country)) {
               $errors[] = 'You forgot to enter your country.';
        }
        // Check for the post code:
               $zcode_pcode =
               filter_var( $_POST['zcode_pcode'], FILTER_SANITIZE_STRING);
        if (empty($zcode_pcode)) {
               $errors[] = 'You forgot to enter your post code.';
        }
        // Check for the phone number:
               $phone =
               filter_var( $_POST['phone'], FILTER_SANITIZE_STRING);
               if (empty($phone)) {
                       $phone = NULL;
        }
        if (empty($errors)) { // If everything's OK.
        //Determine whether the email address has already been registered             #2
               require ('mysqli_connect.php'); // Connect to the db.
               $query = "SELECT userid FROM users WHERE email = ? ";
               $q = mysqli_stmt_init($dbcon);
               mysqli_stmt_prepare($q, $query);
               mysqli_stmt_bind_param($q, 's', $email);
               mysqli_stmt_execute($q);
               $result = mysqli_stmt_get_result($q);

               if (mysqli_num_rows($result) == 0){
               //The email address has not been registered
        // Register the user in the database...
        // Hash password current 60 characters but can increase
            $hashed_passcode = password_hash($password1, PASSWORD_DEFAULT);
               require ('mysqli_connect.php'); // Connect to the db.
               // Make the query:
               $query =
"INSERT INTO users (userid, first_name, last_name, email, password, ";
               $query .=
"class, address1, address2, city, state_country, zcode_pcode, phone, ";
               $query .= "registration_date ) ";
               $query .=
        "VALUES(' ', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW() )";
        $q = mysqli_stmt_init($dbcon);
        mysqli_stmt_prepare($q, $query);
        // use prepared statement to ensure that only text is inserted
        // bind fields to SQL Statement
        mysqli_stmt_bind_param($q, 'sssssssssss',
                       $first_name, $last_name, $email, $hashed_passcode,
                       $class, $address1, $address2, $city, $state_country,
                       $zcode_pcode, $phone);
     // execute query
        mysqli_stmt_execute($q);
        if (mysqli_stmt_affected_rows($q) == 1) { // One record inserted
               header ("location: register-thanks.php?class=" . $class);
               exit();
               } else { // If it did not run OK.
               // Public message:
                  $errorstring =
               "<p class='text-center col-sm-8' style='color:red'>";
               $errorstring .=
                       "System Error<br />You could not be registered due ";
               $errorstring .=
               "to a system error. We apologize for any inconvenience.</p>";
               echo "<p class=' text-center col-sm-2'
                        style='color:red'>$errorstring</p>";
               // Debugging message below do not use in production
               //echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $query . '</p>';
               mysqli_close($dbcon); // Close the database connection.
               // include footer then close program to stop execution
               echo '<footer class="jumbotron text-center col-sm-12"
                       style="padding-bottom:1px; padding-top:8px;">
            include("footer.php");
            </footer>';
        exit();
               }else{//The email address is already registered                     #3
               $errorstring = 'The email address is already registered.';
                       echo "<p class=' text-center col-sm-2' style='color:red'>$errorstring</p>";
        }
        } else { // Report the errors.
               $errorstring =
               "Error! <br /> The following error(s) occurred:<br>";
               foreach ($errors as $msg) { // Print each error.
                       $errorstring .= " - $msg<br>\n";
               }
               $errorstring .= "Please try again.<br>";
               echo "<p class=' text-center col-sm-2'
                       style='color:red'>$errorstring</p>";
               }// End of if (empty($errors)) IF.
        }
   catch(Exception $e) // We finally handle any problems here
   {
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
   }
   catch(Error $e)
   {
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
   }
?>

Listing 5-2bCode for the New Registration Page with 12 Visible Fields (process-register-page.php)

```

### 代码的解释

本节解释代码。

```php
// Check for address2:                                                                #1
               $address2 =
               filter_var( $_POST['address2'], FILTER_SANITIZE_STRING);
        if (empty($address2)) {
               $address2 = NULL;
        }

```

第二个地址字段(地址 2)不是必填字段。该字段没有必需的属性，因为用户可以故意将其留空。如果该字段为空，将执行 else 语句。没有错误消息。相反，关键字 NULL 被赋给变量$adress2。NULL 表示没有值。如果 address2 的注册表单字段为空，则数据库表中的 address2 单元格也将被设置为 NULL。检查代码的其余部分，看看是否可以找到用于另一个可选字段的相同模式。

```php
//Determine whether the email address has already been registered                     #2
       require ('mysqli_connect.php'); // Connect to the db.
       $query = "SELECT userid FROM users WHERE email = ? ";
       $q = mysqli_stmt_init($dbcon);
       mysqli_stmt_prepare($q, $query);
       mysqli_stmt_bind_param($q, 's', $email);
       mysqli_stmt_execute($q);
       $result = mysqli_stmt_get_result($q);

       if (mysqli_num_rows($result) == 0){

```

现在进行检查以确定电子邮件是否已经在数据库中。如果不是，则插入信息。

```php
}else{//The email address is already registered                                       #3
               $errorstring = 'The email address is already registered.';
                       echo "<p class=' text-center col-sm-2'
                       style='color:red'>$errorstring</p>";
       }
If the email already exists, display an error message.

```

扩展注册页面通知用户可以使用 PayPal 或借记卡/信用卡支付会员费。这是通过使用右侧信息栏中的 PayPal 图片实现的，如下一节所示。

## 添加 PayPal 借记卡/信用卡图片

这张图片是从 PayPal 网站下载的，并被添加到新版本的信息栏中。结果如图 [5-3](#Fig3) 所示。

![../images/314857_2_En_5_Chapter/314857_2_En_5_Fig3_HTML.jpg](../images/314857_2_En_5_Chapter/314857_2_En_5_Fig3_HTML.jpg)

图 5-3

修订信息栏

新的*info-col-cards.php*文件仅包含在注册页面和“感谢”页面中。所有其他页面都不需要这些信息；因此，他们将包括原来的 info-col.php*。*

 *## 包括 PayPal 的“谢谢”页面

“谢谢”页面现在将添加一种支付方式。如图 [5-4](#Fig4) 所示。

![../images/314857_2_En_5_Chapter/314857_2_En_5_Fig4_HTML.jpg](../images/314857_2_En_5_Chapter/314857_2_En_5_Fig4_HTML.jpg)

图 5-4

“谢谢”页面上添加了一个 PayPal 链接

前一章中的“谢谢”页构成了新页面的基础。用户的成员资格申请将被记录在数据库中，但是付费单元将包含默认值 No。这是因为付费项目是对用户隐藏的 ENUM。管理员是唯一被允许在该字段中输入数据的人。当管理员收到 PayPal 确认付款的电子邮件时(或当信用卡付款到达时)，管理员会将“已付款”单元格更改为“是”。PayPal 电子邮件还提供了新成员的地址和电子邮件。如果管理员对详细信息与用户在数据库中输入的信息相匹配感到满意，则数据库中成员的已付字段将被设置为是。管理员需要比较用户最初选择的会员类别和用户支付的类别，以确保它们匹配。如果有差异，管理员还需要调整数据库中的付费类。

我们在“谢谢”页面中使用 PayPal，因为它是一种流行的支付系统。网站所有者可以在 paypal 注册。com 页面(或 paypal.co.uk 页面)。他们将获得一个商家 ID，并选择生成和复制代码片段，以嵌入任何页面中的支付链接。如果所有者已经有一个 PayPal 帐户，他们可以登录并进入我的个人资料和我的商业信息，在那里他们可以找到商家帐户 ID。该 ID 将使他们能够访问适当的生成代码以嵌入到页面中。

注:*register-thanks.php*的 PayPal 代码仅用于演示。提供的代码将不起作用，因为您必须有一个商家帐户 ID。PayPal 提供测试支付交易的能力，而无需处理 PayPal 或借记卡/信用卡账户。一旦您有了帐户，PayPal 将提供代码，您可以复制并粘贴这些代码来替换本演示中的示例代码。您可以在此找到有关设置测试环境的更多信息:

```php
https://developer.paypal.com/docs/classic/paypal-payments-standard/ht_test-pps-buttons/

```

清单 [5-4](#PC27) 展示了“谢谢”页面的代码。

```php
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Register Thanks</title>
  <meta charset="utf-8">
  <meta name="viewport"
       content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS File -->
  <link rel="stylesheet"
  href=
"https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
  integrity=
"sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
  crossorigin="anonymous">
</head>
<body>
<div class="container" style="margin-top:30px">
<!-- Header Section -->
<header class="jumbotron text-center row"
style="margin-bottom:2px;
background:linear-gradient(white, #0073e6); padding:20px;">
  <?php include('thanks-header.php'); ?>
</header>
<!-- Body Section -->
  <div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
  <nav class="col-sm-2">
      <ul class="nav nav-pills flex-column">
               <?php include('nav.php'); ?>
      </ul>
  </nav>
<!-- Center Column Content Section -->
<div class="col-sm-8">
<h3 class="h2 text-center" >Thank you for registering</h2>
<h6 class="text-center">
To confirm your registration please verify membership class and pay the membership fee now.</h6>
<h6 class="text-center">
You can use PayPal or a credit/debit card.</h6>
<p class="text-center" >
When you have completed your registration you will be able to login
to the member's only pages.</p>
<?php
try {
        require ("mysqli_connect.php");
        $query = "SELECT * FROM prices";
        $result = mysqli_query ($dbcon, $query); // Run the query.
        if ($result) { // If it ran OK, display the records.
        $row = mysqli_fetch_array($result, MYSQLI_NUM);
        $yearsarray = array(
"Standard one year:", "Standard five year:", "Military one year:",
"Under 21 one year:", "Other - Give what you can. Maybe:" );
echo '<h6 class="text-center text-danger">Membership classes:</h6>' ;
echo '<h6 class="text-center text-danger small"> ';
for ($j = 0, $i = 0; $j < 5; $j++, $i = $i + 2) {

        echo $yearsarray[$j] . " &pound; " .
               htmlspecialchars($row[$i], ENT_QUOTES)  .
               " GB, &dollar; " .
               htmlspecialchars($row[$i + 1], ENT_QUOTES) .
               " US";

        if ($j != 4) {
        if ($j % 2 == 0) { echo "</h6><h6 class='text-center text-danger small'>"; }
        else { echo " , "; }
        }
}
echo "</h6>";
}
?>
<p></p>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="XXXXXXXXXXXXX">
<div class="form-group row">
    <label for="level" class="col-sm-4 col-form-label">
        *Membership Class</label>
<div class="col-sm-8">
        <select id="level" name="level" class="form-control" required>
        <option value="0" >-Select-</option>
<?php                                                                             //#1
$class = htmlspecialchars($_GET['class'], ENT_QUOTES);
for ($j = 0, $i = 0; $j < 5; $j++, $i = $i + 2) {

        echo '<option value="' .
                htmlspecialchars($row[$i], ENT_QUOTES) . '" ';
        if ((isset($class)) && ( $class == $row[$i]))
               {
                       echo ' selected ';
         }
        echo ">" . $yearsarray[$j] . " " .
            htmlspecialchars($row[$i], ENT_QUOTES) .
               " &pound; GB, " .
               htmlspecialchars($row[$i + 1], ENT_QUOTES) .
               "&dollar; US</option>";
}
?>
</select>
</div>
</div>
<div class="form-group row">
    <label for="" class="col-sm-4 col-form-label"></label>
    <div class="col-sm-8">
<!--                                                                              #2-->
<!-- Replace the code below with code provided by PayPal once you obtain a Merchant ID -->
<input type="hidden" name="currency_code" value="GBP">
<input style="margin:10px 0 0 40px" type="image" src="https://www.paypalobjects.com/en_US/GB/i/btn/btn_buynowCC_LG.gif" name="submit" alt="PayPal  The safer, easier way to pay online.">
<img alt="" src="https://www.paypalobjects.com/en_GB/i/scr/pixel.gif" width="1" height="1">
<!-- Replace code above with PayPal provided code -->
</div>
</div>
</form>
</div>
<!-- Right-side Column Content Section -->
        <aside class="col-sm-2">
               <?php include('info-col-cards.php'); ?>
        </aside>
  </div>
<!-- Footer Content Section -->
<footer class="jumbotron text-center row"
style="padding-bottom:1px; padding-top:8px;">
        <?php include('footer.php'); ?>
</footer>
<?php
} // end try
catch(Exception $e) // We finally handle any problems here
 {
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
 }
catch(Error $e)
{
     //print "An Error occurred. Message: " . $e->getMessage();
     print "The system is busy please try again later.";
}
?>
</body>
</html>

Listing 5-4Creating a Combined “Thank You” and PayPal Payment Page (register-thanks.php)

```

### 代码的解释

本节描述代码。

```php
<?php                                                                                //#1
$class = htmlspecialchars($_GET['class'], ENT_QUOTES);
for ($j = 0, $i = 0; $j < 5; $j++, $i = $i + 2) {

        echo '<option value="' .
               htmlspecialchars($row[$i], ENT_QUOTES) . '" ';
        if ((isset($class)) && ( $class == $row[$i]))
               {
                       echo ' selected ';
         }
        echo ">" . $yearsarray[$j] . " " .
            htmlspecialchars($row[$i], ENT_QUOTES) .
               " &pound; GB, " .
               htmlspecialchars($row[$i + 1], ENT_QUOTES) .
               "&dollar; US</option>";
}

```

为类创建下拉列表的代码类似于 *register_page.php* 文件中的代码。但是，决定将哪个类设置为选中状态是由$class 中的值决定的，该值是从 register 页面传递到页面中的。

```php
<!--                                                                                 #2-->
<!-- Replace the code below with code provided by PayPal once you obtain a Merchant ID -->
<input type="hidden" name="currency_code" value="GBP">
<input style="margin:10px 0 0 40px" type="image" src="https://www.paypalobjects.com/en_US/GB/i/btn/btn_buynowCC_LG.gif" name="submit" alt="PayPal  The safer, easier way to pay online.">
<img alt="" src="https://www.paypalobjects.com/en_GB/i/scr/pixel.gif" width="1" height="1">
<!-- Replace code above with PayPal provided code -->

```

这是 PayPal 生成的一小部分代码。为了安全起见，我们在本教程中为 PayPal ID 使用了一个虚拟值。PayPal 提供 13 个字符的 ID 代码。标题现在没有菜单按钮；在收到注册人的付款之前，注册人只能访问主页。主页可以从主菜单访问。

在我们继续之前，你需要注册一些额外的成员。

## 注册一些成员

### 小费

输入数据可能很繁琐。为了减少本教程的繁琐，每个条目的地址和电话号码可以是相同的。接下来建议一组合适的数据。

实验时，每个记录都使用以下数据。这是可以接受的，因为没有使用地址和电话号码进行搜索。

*   *会员类别*:对于每个条目的会员类别，选择任何下拉选项。

*   *地址 1* : 2 街。

*   *地址 2* :村庄(为了演示数据库中 NULL 设置的效果，将其中一些字段留空，并用村庄填充一些字段)。

*   *城市*:汤斯维尔。

*   *国家或州*:英国(如果是美国的一个州，则为 CA)。

*   *邮政编码* : EX7 9PP(或美国邮政编码 33040)。

*   *电话* : 01234 777 888(或美国电话号码，3055551111。这个字段是可选的，你应该在一些记录中省略电话。

注册表 [5-3](#Tab3) 中列出的成员。

表 5-3

一些成员姓名

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

西方人名的第一个字

 | 

姓

 | 

电子邮件

 | 

密码

 |
| --- | --- | --- | --- |
| 詹姆斯 | 锻工 | 斯科史密斯@myisp.com | Bl3cksmith |
| 插口 | 锻工 | jsmith@outcook.com | 那就好 |
| 迈克 | 这是什么 | 米克尔@myisp.com | 威尔盖特 3 公司 |
| 橄榄 | 树枝 | obranch@myisp.co.uk | S7-1200 可编程控制器 |
| 弗兰克 | 香 | fincense@myisp.net | P3 RFM 3s |
| 安妮 | 周年纪念 | aversary@myisp.com | 页:1 |
| 泰丽 | Fide | tfide @ my ISP . com | S7-1200 可编程控制器 |
| 玫瑰 | 矮树丛 | rbush@myisp.co.uk | R3db100ms |
| 安妮 | 苔藓 | amositty@myisp.org.uk | S7-1200 可编程控制器 |
| 皮尔斯！皮尔斯 | 转向 | pver @ my ISP . com | K33pg01ng |
| 戴劳 | 豆儿 | ddoo@myisp.co.uk | 星期六 f1ed |
| 斯坦 | 达尔德族人 | sdad @ my ISP . net | b@ttl3fl@g |
| Honora | 骨 | nbone@myisp.com | L1k3t3rr13r |
| 巴里 | 凯德 | bcade@myisp.co.uk | Bl0ckth3m |

如果您以后需要更多的数据来处理，表 [5-4](#Tab4) 中给出了一些建议。

表 5-4

注册的一些附加建议

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

西方人名的第一个字

 | 

姓

 | 

电子邮件

 | 

密码

 |
| --- | --- | --- | --- |
| 迪伊 | 被拒绝 | djected@myisp.org.uk | 总帐 00mnd00m |
| 林恩 | 种子 | lseed@myisp.com | 第一季第 3 集 |
| 巴里 | 音调 | btone@myisp.net | 尼奇 3v01c3 |
| 海伦 | 背部 | hback@myisp.net | Agr1ms0rt1e |
| 帕特里克(男子名) | 欧哈拉 | pohara@myisp.org.uk | shame0ck |
| 黎明 | 合唱 | dchorus@myisp.com | Tr1ll1ng(消歧义) |
| 康妮 | 冷杉 | cfirst@myisp.com | P1n3tr33s |
| 伊娃 | 内桑特 | enessant@outlook.com | 反 13nt |
| -艾尔 | 壁画 | sfeirco @ my ISP . net | Fr3sha1rf00d |

### 重要的

杰克·史密斯将再次担任管理人。进入 phpMyAdmin，将杰克·史密斯的 user_level 从 0 改为 1。另外，一定要使用 phpMyAdmin 将管理员的 paid 列更改为 Yes。将一些其他成员的付费列更改为是。

要将 payed 字段更改为 Yes，在输入所有成员后，打开 phpMyAdmin，在左侧面板中单击 postaldb 旁边的+号，然后单击带下划线的单词 *users* 。用户的记录将以水平格式显示。要更改成员的已付字段，请单击每个成员记录左侧的编辑项目。然后，记录将以更方便的垂直格式显示。向下滚动到付费枚举单选按钮，然后单击是按钮。然后单击开始。

### 注意

记住，如果你不能登录一个会员的账户，很可能是因为他的付费栏没有设置为是。这是应该的。

### 对登录页面的一个小修改

登录页面(包含在下载的文件中)与前一章中的页面几乎相同，除了我们必须防止申请人在管理员收到会员费之前访问会员专用页面。以下代码片段显示了对查询的修改:

```php
// Retrieve the user_id, psword, first_name and user_level for that
// email/password combination
 $query = "SELECT user_id, psword, fname, user_level FROM users ";
 $query .= "WHERE paid="Yes" AND email=?";

```

错误消息也修改如下:

```php
echo '<p class="error">our E-mail/Password does not match our records.';
echo ' Perhaps your fee has not yet been processed from PayPal or the credit card.';
echo '<br>Perhaps you need to register, just click the Register' ;
echo 'button on the header menu</p>';

```

我们现在必须改变管理员的页面以匹配额外的列。例如，会员秘书(管理员)想要更新哪些会员已经支付了费用或请求了其他更改。例如，伊娃·内桑特可能会搬家或改名。在第 [6](06.html) 章中，我们还会加入包含一个头衔的能力(先生小姐夫人，Mx。博士)发给每个成员。在第 [7](07.html) 章中，我们将减轻管理员的工作量，允许成员在自己的记录中更新这些字段。

我们现在将对管理页面的标题进行更改，以包含一个新按钮。

## 修改管理员的标题

为了避免一英里宽的表格显示，大量的列将被分成两个单独的显示:一个显示成员的详细信息，另一个显示成员的地址和电话号码。需要一个新的搜索工具，以便成员的地址可以显示在表中。这将通过标题菜单上标记为*地址*的新按钮启动。

我们已经修改了标题以包含 Addresses 按钮，如图 [5-5](#Fig5) 所示。因为标题是启动板，我们将从列出新标题开始。

![../images/314857_2_En_5_Chapter/314857_2_En_5_Fig5_HTML.jpg](../images/314857_2_En_5_Chapter/314857_2_En_5_Fig5_HTML.jpg)

图 5-5

包含“新地址”按钮的新标题

新地址按钮如清单 [5-5](#PC20) 所示。

```php
<div class="col-sm-2">
<img class="img-fluid float-left" src="logo.jpg" alt="Logo">
</div>
<div class="col-sm-8">
        <h1 class="blue-text mb-4 font-bold">Header Goes Here</h1>
</div>
        <nav class="col-sm-2">
        <div class="btn-group-vertical btn-group-sm" role="group"
               aria-label="Button Group">
               <button type="button" class="btn btn-secondary"
                       onclick="location.href = 'logout.php'" >
                       Logout</button>
               <button type="button" class="btn btn-secondary"
                       onclick="location.href = 'admin_view_users.php'">
                       View Members</button>
               <button type="button" class="btn btn-secondary"
                       onclick="location.href = 'search.php'">
                       Search</button>
               <button type="button" class="btn btn-secondary"
                       onclick="location.href = '#'">
                       Addresses</button>
               <button type="button" class="btn btn-secondary"
                       onclick="location.href = 'register-password.php'">
                       New Password</button>
        </div>
</nav>

Listing 5-5Installing a New Addresses Button in the Header (header-admin.php)

```

### 注意

链接搜索地址将不会工作，直到我们产生了 *search_address.php* 页面。我们将在下一章做这件事。

由 *admin_view_users.php* 文件显示的表格需要两个额外的列，称为*类*和*付费*。

## 向 admin_view_users 表添加 Class 和 Paid

从管理员的角度来看，需要修改 admin_view_users 表以显示一些新列。分页后的表格需要显示如图 [5-6](#Fig6) 所示的列。

![../images/314857_2_En_5_Chapter/314857_2_En_5_Fig6_HTML.jpg](../images/314857_2_En_5_Chapter/314857_2_En_5_Fig6_HTML.jpg)

图 5-6

新表格显示。请注意新的 Class 和 Paid 列

为了节省您输入大量注册的繁琐任务，每个表再次被限制为四个记录。在实际情况下，每页显示大约 20 到 25 行。图 [5-6](#Fig6) 显示了带有两个额外列的表格显示。

清单 [5-6](#PC21) 显示了对代码的修改。请注意，右侧的 info 列已被删除，以便为表格提供更多空间。在下一节中，我们将展示实现这一点的代码更改。

```php
<?php
try {
        // This script retrieves all the records from the users table.
        require('mysqli_connect.php'); // Connect to the database.
        //set the number of rows per display page
        $pagerows = 4;
        // Has the total number of pages already been calculated?
        if ((isset($_GET['p']) && is_numeric($_GET['p']))) {
               //already been calculated
               $pages = htmlspecialchars($_GET['p'], ENT_QUOTES);
               // make sure it is not executable XSS
        }else{//use the next block of code to calculate the number of pages
               //First, check for the total number of records
               $query = "SELECT COUNT(userid) FROM users";
               $result = mysqli_query ($dbcon, $query);
               $row = mysqli_fetch_array ($result, MYSQLI_NUM);
               $records = htmlspecialchars($row[0], ENT_QUOTES);
               // make sure it is not executable XSS
               //Now calculate the number of pages
               if ($records > $pagerows){
                       //if the number of records will fill more than one page
                       //Calculate the number of pages and round the result up
                       // to the nearest integer
                       $pages = ceil ($records/$pagerows);
               }else{
                       $pages = 1;
               }
        }//page check finished
        //Declare which record to start with
        if ((isset($_GET['s'])) &&( is_numeric($_GET['s'])))
        {
               $start = htmlspecialchars($_GET['s'], ENT_QUOTES);
               // make sure it is not executable XSS
        }else{
               $start = 0;
        }
               $query = "SELECT last_name, first_name, email, ";                       //#1
               $query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
               $query .=" AS regdat, class, paid, userid FROM users ORDER BY ";
               $query .="registration_date DESC";
               $query .=" LIMIT ?, ?";

               $q = mysqli_stmt_init($dbcon);
               mysqli_stmt_prepare($q, $query);

               // bind $id to SQL Statement
               mysqli_stmt_bind_param($q, "ii", $start, $pagerows);

               // execute query
               mysqli_stmt_execute($q);
               $result = mysqli_stmt_get_result($q);

               if ($result) { //                                                       #2
               // If it ran OK (records were returned), display the records.
               // Table header
               echo '<table class="table table-striped">
               <tr>
               <th scope="col">Edit</th>
               <th scope="col">Delete</th>
               <th scope="col">Last Name</th>
               <th scope="col">First Name</th>
               <th scope="col">Email</th>
               <th scope="col">Date Registered</th>
               <th scope="col">Class</th>
               <th scope="col">Paid</th>
               </tr>';
               // Fetch and print all the records:
               while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {
        // Remove special characters that might already be in table to
               // reduce the chance of XSS exploits                                   #3
               $user_id = htmlspecialchars($row['userid'], ENT_QUOTES);
               $last_name = htmlspecialchars($row['last_name'], ENT_QUOTES);
               $first_name = htmlspecialchars($row['first_name'], ENT_QUOTES);
               $email = htmlspecialchars($row['email'], ENT_QUOTES);
               $registration_date =
               htmlspecialchars($row['regdat'], ENT_QUOTES);
               $class = htmlspecialchars($row['class'], ENT_QUOTES);
               $paid = htmlspecialchars($row['paid'], ENT_QUOTES);
               echo '<tr>
               <td><a href="edit_user.php?id=' . $user_id . '">Edit</a></td>
               <td><a href="delete_user.php?id=' . $user_id . '">Delete</a></td>
               <td>' . $last_name . '</td>
               <td>' . $first_name . '</td>
               <td>' . $email . '</td>
               <td>' . $registration_date . '</td>
               <td>' . $class . '</td>
               <td>' . $paid . '</td>
               </tr>';
        }
               echo '</table>'; // Close the table.
               mysqli_free_result ($result); // Free up the resources.
}
else { // If it did not run OK.
// Error message:
        echo '<p class="text-center">The current users could not be ';
        echo 'retrieved We apologize for any inconvenience.</p>';
// Debug message:
// echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $q . '</p>';
// exit;
} // End of else ($result)
// Now display the total number of records/members.
$q = "SELECT COUNT(userid) FROM users";
$result = mysqli_query ($dbcon, $q);
$row = mysqli_fetch_array ($result, MYSQLI_NUM);
$members = htmlspecialchars($row[0], ENT_QUOTES);
mysqli_close($dbcon); // Close the database connection.
$echostring = "<p class='text-center'>Total membership: $members </p>";
$echostring .= "<p class='text-center'>";
if ($pages > 1) {//
        //What number is the current page?
        $current_page = ($start/$pagerows) + 1;
        //If the page is not the first page then create a Previous link
        if ($current_page != 1) {
        $echostring .= '<a href="admin_view_users.php?s=' .
               ($start - $pagerows) . '&p=' . $pages . '">
               Previous</a> ';
}
//Create a Next link
if ($current_page != $pages) {
        $echostring .= ' <a href="admin_view_users.php?s=' .
        ($start + $pagerows) . '&p=' . $pages . '">Next</a> ';
}
$echostring .= '</p>';
echo $echostring;
}
} //end of try
catch(Exception $e) // We finally handle any problems here
{
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
}
catch(Error $e)
{
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
}
?>

Listing 5-6Code for Creating the Paginated Table

to Display Two Extra Columns (process_admin_view_users.php)

```

### 代码的解释

本节解释代码。

```php
$query = "SELECT last_name, first_name, email, ";                                    //#1
$query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
$query .=" AS regdat, class, paid, userid FROM users ORDER BY ";
$query .="registration_date DESC";
$query .=" LIMIT ?, ?";

$q = mysqli_stmt_init($dbcon);
mysqli_stmt_prepare($q, $query);

// bind $id to SQL Statement
mysqli_stmt_bind_param($q, "ii", $start, $pagerows);

// execute query
mysqli_stmt_execute($q);
$result = mysqli_stmt_get_result($q);

if ($result) {

```

名为 *class* 和*payed*的两列被添加到选择查询中。这些行再次按注册日期排序，但现在它们将按降序排列(DESC)，因为我们假想的管理员更喜欢在表的顶部查看最新的注册。

```php
if ($result) { //                                                                    #2
// If it ran OK (records were returned), display the records.
// Table header
echo '<table class="table table-striped">
<tr>
<th scope="col">Edit</th>
<th scope="col">Delete</th>
<th scope="col">Last Name</th>
<th scope="col">First Name</th>
<th scope="col">Email</th>
<th scope="col">Date Registered</th>
<th scope="col">Class</th>
<th scope="col">Paid</th>
</tr>';

```

如果没有遇到问题，则显示包括额外两项的表标题。

```php
// reduce the chance of XSS exploits                                                      #3
               $user_id = htmlspecialchars($row['userid'], ENT_QUOTES);
               $last_name = htmlspecialchars($row['last_name'], ENT_QUOTES);
               $first_name = htmlspecialchars($row['first_name'], ENT_QUOTES);
               $email = htmlspecialchars($row['email'], ENT_QUOTES);
               $registration_date =
                       htmlspecialchars($row['regdat'], ENT_QUOTES);
               $class = htmlspecialchars($row['class'], ENT_QUOTES);
               $paid = htmlspecialchars($row['paid'], ENT_QUOTES);
               echo '<tr>
               <td><a href="edit_user.php?id=' . $user_id . '">Edit</a></td>
               <td><a href="delete_user.php?id=' . $user_id . '">Delete</a></td>
               <td>' . $last_name . '</td>
               <td>' . $first_name . '</td>
               <td>' . $email . '</td>
               <td>' . $registration_date . '</td>
               <td>' . $class . '</td>
               <td>' . $paid . '</td>
               </tr>';
        }
               echo '</table>'; // Close the table.

```

我们清理了两个新列，并将结果放入表的最后两列。

现在让我们更新搜索和编辑记录的能力。

## 搜索和编辑记录

搜索表单及其代码与第 [4 章](04.html)中的相同；因此，这里不再赘述。但是，当使用标题菜单上的 Search 按钮显示一条记录时，我们需要将 Class 和 Paid 列添加到屏幕上显示的表中。

图 [5-7](#Fig7) 显示了带有两个新列的搜索结果。

![../images/314857_2_En_5_Chapter/314857_2_En_5_Fig7_HTML.jpg](../images/314857_2_En_5_Chapter/314857_2_En_5_Fig7_HTML.jpg)

图 5-7

搜索结果现在显示一条记录，其中有两个额外的列，Class 和 Paid

为了给长的电子邮件地址、姓氏和两个新列腾出空间，我们删除了显示中的信息列。这里显示了 *view_found_record.php* 文件最后几行的部分清单:

```php
<div class="col-sm-10">
  <h2 class="text-center">These are users found</h2>
<p>
<?php
    require ("process_view_found_record.php");
?>
</div>
</div>
<!-- Footer Content Section -->
<footer class="jumbotron text-center row"
    style="padding-bottom:1px; padding-top:8px;">
  <?php include('footer.php'); ?>
</footer>
</div>
</body>
</html>

```

显示表格的引导列数从 8 增加到 10 (col-sm-10)。信息栏代码已被删除。

清单 [5-7](#PC26) 展示了为表添加两个额外列的 PHP 代码的变化。

```php
<?php
try
{
       // This script retrieves records from the users table.
       require ('./mysqli_connect.php'); // Connect to the db.
       echo '<p class="text-center">If no record is shown, ';
       echo 'this is because you had an incorrect ';
       echo ' or missing entry in the search form.';
       echo '<br>Click the back button on the browser and try again</p>';
       $first_name = htmlspecialchars($_POST['first_name'], ENT_QUOTES);
       $last_name = htmlspecialchars($_POST['last_name'], ENT_QUOTES);
       // Since it's a prepared statement below this sanitizing is not needed
       // However, to consistently retrieve than sanitize is a good habit

       $query = "SELECT last_name, first_name, email, ";
       $query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
       $query .=" AS regdat, class, paid, userid FROM users WHERE ";
       $query .= "last_name=? AND first_name=? ";
       $query .="ORDER BY registration_date ASC ";

       $q = mysqli_stmt_init($dbcon);
       mysqli_stmt_prepare($q, $query);

       // bind values to SQL Statement
       mysqli_stmt_bind_param($q, 'ss', $last_name, $first_name);

       // execute query
       mysqli_stmt_execute($q);

       $result = mysqli_stmt_get_result($q);

       if ($result) { // If it ran, display the records.
       // Table header.
       echo '<table class="table table-striped">
       <tr>
       <th scope="col">Edit</th>
       <th scope="col">Delete</th>
       <th scope="col">Last Name</th>
       <th scope="col">First Name</th>
       <th scope="col">Email</th>
       <th scope="col">Date Registered</th>
       <th scope="col">Class</th>
       <th scope="col">Paid</th>
       </tr>';
       // Fetch and display the records:
       while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {
       // Remove special characters that might already be in table to
       // reduce the chance of XSS exploits
               $user_id = htmlspecialchars($row['userid'], ENT_QUOTES);
               $last_name = htmlspecialchars($row['last_name'], ENT_QUOTES);
               $first_name = htmlspecialchars($row['first_name'], ENT_QUOTES);
               $email = htmlspecialchars($row['email'], ENT_QUOTES);
               $registration_date =
                       htmlspecialchars($row['regdat'], ENT_QUOTES);
               $class = htmlspecialchars($row['class'], ENT_QUOTES);
               $paid = htmlspecialchars($row['paid'], ENT_QUOTES);
               echo '<tr>
               <td><a href="edit_user.php?id=' . $user_id . '">Edit</a></td>
               <td><a href="delete_user.php?id=' . $user_id . '">Delete</a></td>
               <td>' . $last_name . '</td>
               <td>' . $first_name . '</td>
               <td>' . $email . '</td>
               <td>' . $registration_date . '</td>
               <td>' . $class . '</td>
               <td>' . $paid . '</td>
               </tr>';
       }
       echo '</table>'; // Close the table.
       //
       mysqli_free_result ($result); // Free up the resources.
} else { // If it did not run OK.
       // Public message:
       echo '<p class="center-text">The current users could not ';
       echo 'be retrieved.';
       echo 'We apologize for any inconvenience.</p>';
       // Debugging message:
       //echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $q . '</p>';
       //Show $q is debug mode only
} // End of if ($result). Now display the total number of records/members.
mysqli_close($dbcon); // Close the database connection.
}
catch(Exception $e)
{
       print "The system is currently busy. Please try later.";
       //print "An Exception occurred.Message: " . $e->getMessage();
}catch(Error $e)
{
       print "The system us busy. Please try later.";
       //print "An Error occurred. Message: " . $e->getMessage();
}
?>
</html>

Listing 5-7Creating Two Extra Columns

in the Table Display (process_view_found_record.php)

```

### 代码的解释

对代码的修改与我们之前讨论过的清单中的相同，所以我们在这里不再解释。

### 修改表单以编辑记录

用于编辑记录的表单现在将包含两个额外的字段，Membership Class 和 Paid。这使会员秘书能够查看会员选择的会员类别。在处理会员的 PayPal 付款时，他们也可以在“已付款”字段中输入“是”。这些字段如图 [5-8](#Fig8) 所示。

![../images/314857_2_En_5_Chapter/314857_2_En_5_Fig8_HTML.jpg](../images/314857_2_En_5_Chapter/314857_2_En_5_Fig8_HTML.jpg)

图 5-8

编辑记录的屏幕

所有五个字段都可以编辑。单击 Edit 按钮时，将显示修改后的数据，同时显示一条消息，说明记录已成功编辑。编辑地址或电话号码将在第 [6](06.html) 章中介绍。清单 [5-8](#PC271) 显示了编辑记录的代码。

```php
<?php
try
{
// After clicking the Edit link in the found_record.php page. This code is executed
// The code looks for a valid user ID, either through GET or POST:
if ( (isset($_GET['id'])) && (is_numeric($_GET['id'])) ) {
// From view_users.php
    $id = htmlspecialchars($_GET['id'], ENT_QUOTES);
} elseif ( (isset($_POST['id'])) && (is_numeric($_POST['id'])) ) {
// Form submission.
       $id = htmlspecialchars($_POST['id'], ENT_QUOTES);
} else { // No valid ID, kill the script.
       echo '<p class="text-center">
               This page has been accessed in error.</p>';
       include ('footer.php');
       exit();
}

require ('./mysqli_connect.php');
// Has the form been submitted?
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
       $errors = array();
       // Look for the first name:
       $first_name =
               filter_var( $_POST['first_name'], FILTER_SANITIZE_STRING);
       if (empty($first_name)) {
               $errors[] = 'You forgot to enter your first name.';
       }
       // Look for the last name:
       $last_name = filter_var( $_POST['last_name'], FILTER_SANITIZE_STRING);
       if (empty($last_name)) {
               $errors[] = 'You forgot to enter your last name.';
       }
       // Look for the email address:
       $email = filter_var( $_POST['email'], FILTER_SANITIZE_EMAIL);
       if  ((empty($email)) || (!filter_var($email, FILTER_VALIDATE_EMAIL))) {
               $errors[] = 'You forgot to enter your email address';
               $errors[] = ' or the e-mail format is incorrect.';
       }
       // Look for the class:                                                           #1
       $class = filter_var( $_POST['class'], FILTER_SANITIZE_NUMBER_INT);
       if (empty($class)) {
               $errors[] = 'You forgot to the class or it is not numeric.';
       }
       // Look for the Paid Status:                                                     #2
       $paid = filter_var( $_POST['paid'], FILTER_SANITIZE_STRING);
       if (empty($paid)) {
               $errors[] = 'You forgot to enter the paid status.';
       }
       if (!(($paid == "No") || ($paid == "Yes"))) {
               $errors[] = "Paid must be No or Yes.";
       }
       if (empty($errors)) { // If everything's OK.
               $q = mysqli_stmt_init($dbcon);
               $query = 'SELECT userid FROM users WHERE email=? AND userid !=?';
               mysqli_stmt_prepare($q, $query);

               // bind $id to SQL Statement
               mysqli_stmt_bind_param($q, 'si', $email, $id);

       // execute query
       mysqli_stmt_execute($q);
               $result = mysqli_stmt_get_result($q);

               if (mysqli_num_rows($result) == 0) {
               // e-mail does not exist in another record
               $query = 'UPDATE users SET first_name=?, last_name=?, email=?,';
               $query .= ' class=?, paid=?';
               $query .= ' WHERE userid=? LIMIT 1';
               $q = mysqli_stmt_init($dbcon);
               mysqli_stmt_prepare($q, $query);

               // bind values to SQL Statement
mysqli_stmt_bind_param($q, 'sssssi', $first_name, $last_name, $email, $class, $paid, $id);
       // execute query
       mysqli_stmt_execute($q);

               if (mysqli_stmt_affected_rows($q) == 1) { // Update OK
               // Echo a message if the edit was satisfactory:
                       echo '<h3 class="text-center">
                              The user has been edited.</h3>';
               } else { // Echo a message if the query failed.
                       echo '<p class="text-center">
                       The user could not be edited due to a system error.';
                       echo ' We apologize for any inconvenience.</p>';
                       // Public message.
       //echo '<p>' . mysqli_error($dbcon) . '<br />Query: ' . $q . '</p>';
       // Debugging message.
       // Message above is only for debug and should not in live mode
               }
       } else { // Already registered.
               echo '<p class="text-center">
                       The email address has already been registered.</p>';
               }
       } else { // Display the errors.
               echo '<p class="text-center">
                       The following error(s) occurred:<br />';
               foreach ($errors as $msg) { // Echo each error.
                       echo " - $msg<br />\n";
               }
               echo '</p><p>Please try again.</p>';
 } // End of if (empty($errors))section.
} // End of the conditionals
// Select the user's information to display in textboxes:

       $q = mysqli_stmt_init($dbcon);
       $query =
"SELECT first_name, last_name, email, class, paid FROM users WHERE userid=?";
       mysqli_stmt_prepare($q, $query);
       // bind $id to SQL Statement
       mysqli_stmt_bind_param($q, 'i', $id);
       // execute query
       mysqli_stmt_execute($q);
       $result = mysqli_stmt_get_result($q);
       $row = mysqli_fetch_array($result, MYSQLI_NUM);
       if (mysqli_num_rows($result) == 1) {
       // Valid user ID, display the form.
       // Get the user's information:
       // Create the form:
?>
<h2 class="h2 text-center">Edit a Record</h2>
<form action="edit_user.php" method="post"
       name="editform" id="editform">
<div class="form-group row">
       <label for="first_name" class="col-sm-4 col-form-label">
              First Name:</label>
<div class="col-sm-8">
       <input type="text" class="form-control" id="first_name"
       name="first_name" placeholder="First Name" maxlength="30" required
       value="<?php echo htmlspecialchars($row[0], ENT_QUOTES); ?>" >
</div>
</div>
<div class="form-group row">
       <label for="last_name" class="col-sm-4 col-form-label">
              Last Name:</label>
<div class="col-sm-8">
      <input type="text" class="form-control" id="last_name"
       name="last_name" placeholder="Last Name" maxlength="40" required
       value="<?php echo htmlspecialchars($row[1], ENT_QUOTES); ?>">
</div>
</div>
<div class="form-group row">
        <label for="email" class="col-sm-4 col-form-label">
        E-mail:</label>
<div class="col-sm-8">
      <input type="email" class="form-control" id="email"
        name="email" placeholder="E-mail" maxlength="60" required
        value="<?php echo htmlspecialchars($row[2], ENT_QUOTES); ?>">
</div>
</div>
<div class="form-group row">
    <label for="class" class="col-sm-4 col-form-label">
        Membership Class:</label>
<div class="col-sm-8">
      <input type="text" class="form-control" id="class"
        name="class" placeholder="Membership Class" maxlength="60" required
        value="<?php echo htmlspecialchars($row[3], ENT_QUOTES); ?>">
</div>
</div>
<div class="form-group row">
        <label for="paid" class="col-sm-4 col-form-label">Paid:</label>
<div class="col-sm-8">
        <input type="text" class="form-control" id="paid"
        name="paid" placeholder="Paid" maxlength="60" required
        value="<?php echo htmlspecialchars($row[4], ENT_QUOTES); ?>">
</div>
</div>
<input type="hidden" name="id" value="<?php echo $id ?>" />
<div class="form-group row">
        <label for="" class="col-sm-4 col-form-label"></label>
<div class="col-sm-8">
        <input id="submit" class="btn btn-primary" type="submit"
        name="submit" value="Register">
</div>
</div>
</form>
<?php
} else { // The user could not be validated
        echo '<p class="text-center">
               This page has been accessed in error.</p>';
}
mysqli_stmt_free_result($q);
mysqli_close($dbcon);
}
catch(Exception $e)
{
        print "The system is busy. Please try later";
        //print "An Exception occurred.Message: " . $e->getMessage();
}catch(Error $e)
{
        print "The system is currently busy. Please try again later";
        //print "An Error occurred. Message: " . $e->getMessage();
}
?>
// Look for the class:                                                                    #1
        $class = filter_var( $_POST['class'], FILTER_SANITIZE_NUMBER_INT);
        if (empty($class)) {
               $errors[] = 'You forgot to the class or it is not numeric.';
        }
The integer parameter of the filter_var method is used to make sure the class is numeric.

        // Look for the Paid Status:                                                                                   #2
        $paid = filter_var( $_POST['paid'], FILTER_SANITIZE_STRING);
        if (empty($paid)) {
               $errors[] = 'You forgot to enter the paid status.';
        }
        if (!(($paid == "No") || ($paid == "Yes"))){
               $errors[] = "Paid must be No or Yes.";
        }

Listing 5-8The Code for Creating an Editing Screen

to Include the Two Additional Fields (process_edit_record.php)

```

一个额外的检查是用来确保支付是否或是。其他值会导致错误，因为我们将数据库中的列设置为只接受这两个值。

剩下的代码前面都已经看到解释过了；因此，无需进一步解释。在插入新内容的地方，清单中的注释给出了完整的解释。

注意删除记录的屏幕与第 [4](04.html) 章相同，为节省空间，此处不再重复。然而，文件 *delete_record.php* 包含在章节 [5](05.html) 的下载中。

我们需要限制向管理员显示的信息量。要显示成员的全部详细信息，需要一个非常宽且混乱的表。因此，成员的详细信息将被分割并使用两个单独的页面显示。通过*search-address.php*页面，管理员可以独立于其他成员信息查看地址。新地址按钮被添加到菜单中以访问此页面。然而，我们将在下一章为这个页面创建代码。

### 注意

第[章第 5](05.html) 章下载的文件包含了这些演示所需的所有文件，包括第[章第 4](04.html) 章未更改的文件。

## 摘要

在这一章中，我们创建了一个数据库，它包含了比前面章节更多的字段。为了安全起见，我们在所有管理页面中添加了会话。我们在管理员的页面标题中添加了一个新的地址按钮。我们学习了如何在页面上添加 PayPal 标志和按钮。我们讨论了如何获得必要的代码链接到贝宝系统接受付款。成员的表格显示演示了分页。修改了编辑记录的表单，以包含额外的数据。创建了第二个表来保存会员资格的当前价格信息。此信息显示在课程定价和下拉列表中，供用户选择课程。

在下一章中，您将了解管理员如何查看和编辑地址和电话号码。此外，在下一章，我们将添加数据库的收尾工作。通过将包含的文件放在包含文件夹中来整理归档系统。为了增加安全性，将引入额外的用户输入过滤器。标题列将被添加到表格显示中，用于编辑和删除记录，标题列也将被添加到表格显示中，用于编辑地址和电话号码。*