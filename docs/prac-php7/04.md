# 4.创建管理界面

在本章中，我们将为具有中等计算机技能的管理员呈现一组用户友好的页面。我们假设管理员不会使用 phpMyAdmin，但是他们知道足够多的知识，能够登录、访问易于使用的显示和使用简单的编辑工具。我们将使成员表具有交互性，以便管理员可以搜索、编辑、删除和重新排序记录。只有管理员才被允许访问这些设施来删除和修改记录。

完成本章后，您将能够创建具有以下功能的网页:

*   管理数据库

*   删除和编辑记录

*   对记录的显示分页

*   搜索单个记录

### 警告

当我们讨论本书中的表格时，尽量不要将屏幕上显示的表格与数据库表格混淆。这些类型的表是两个不同的实体。例如，表 [4-1](#Tab1) 是一个数据库表，对用户不可见。图 [4-2](#Fig2) 是显示在用户屏幕上的表格。

## 管理数据库

本章中的教程基于前面章节中使用的模板。我们将通过使用数据库及其文件夹的新名称来保持与之前教程的不同。但是，如果表位于不同的数据库中，则该表可以与早期教程同名。因此，该表将继续被称为*用户*。

让我们从创建数据库和访问它的能力开始。

创建一个新文件夹和一个新数据库，如下所示:

1.  在 XAMPP *htdocs* 文件夹或者 easyPHP *eds-www* 文件夹中，新建一个名为 *admintable* 的文件夹。

2.  要么从本书的网页 [`www.apress.com`](http://www.apress.com) (推荐)下载 PHP 文件，要么键入本章和上一章所示的代码，并将其放在新的 *admintable* 文件夹中。

    **注意**如果您从电子书中复制粘贴代码，某些引用可能无法正确复制。首先将代码复制到一个基本的文本编辑器(如 Microsoft Notepad)中，可以很容易地避免问题。编辑器会自动将任何不正确的报价转换为标准报价。然后保存文件并在 PHP 编辑器中打开它(比如 Notepad++)。

如果你正在创建你自己的文件，从第 [3](03.html) 章复制所有文件并粘贴到你的新文件夹 *admintable* 中。在新文件夹中，修改文件 *mysqli_connect.php* ，如下页所列。将文件*admin-header.php*重命名为 *header-admin。*

1.  现在打开 phpMyAdmin。

2.  创建一个名为 *admintable* 的新数据库。

3.  选中 *admintable* 旁边的复选框，然后单击 Check Privileges。

4.  单击添加用户按钮。

5.  输入新用户和密码，如下所示:

    *用户*:站长

    *密码* : C0ffeep0t

    *主机*:本地主机

6.  请务必在笔记本上记录新用户和密码的详细信息。

7.  向下滚动到全局权限(全部选中/全部取消选中)，然后单击全部选中。

8.  向下滚动到表单的底部，然后单击“添加用户”按钮(或者在某些版本中单击“执行”按钮)。

要连接到管理数据库，可以使用清单 [4-1](#PC1) 中所示的代码。

```php
<?php
// Create a connection to the admintable database and set the encoding
Define ('DB_USER', 'webmaster');
Define ('DB_PASSWORD', 'C0ffeep0t');
Define ('DB_HOST', 'localhost');
Define ('DB_NAME', 'admintable');
// Make the connection:
$dbcon = new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);
mysqli_set_charset($dbcon, 'utf8'); // Set the encoding...

Listing 4-1Creating the Code for Connecting to the admintable Database (mysqli_connect.php)

```

在尝试运行任何其他程序之前，请确保测试您对数据库的访问权限。一旦您确定您的用户 ID 和密码正确地访问了数据库，那么继续下面几节中显示的过程。要测试连接，请在浏览器中键入**http://localhost/admin table/mysqi _ connect . PHP**。如果您没有收到任何错误，并且看到一个空白页，则测试成功。

### 用户表

在 phpMyAdmin 中，确保单击新的数据库 admintable，然后创建这个包含七列的 users 表。将编码设置为 utf8-general-ci。给这些列赋予表 [4-1](#Tab1) 中所示的标题和属性。

记住，当在 phpMyAdmin 中选择 A_I 复选框时，一个弹出窗口可能会要求您验证 *userid* 是否是主索引，并将再次请求大小。*不要*在弹出窗口中放一个尺寸。如果你这样做，你会得到一个错误。

表 4-1

用户表的属性

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"> <col class="tcol5 align-left"> <col class="tcol6 align-left"> <col class="tcol7 align-left"> <col class="tcol8 align-left"></colgroup> 
| 

列名

 | 

类型

 | 

长度/值

 | 

默认

 | 

属性

 | 

空

 | 

索引

 | 

A_I

 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 使用者辩证码 | 中位 | six | 没有人 | 无符号的 | -是吗 | 主要的 | ·······················。 |
| 名字 | 可变长字符串 | Thirty | 没有人 |   | -是吗 |   | -是吗 |
| 姓氏 | 可变长字符串 | Forty | 没有人 |   | -是吗 |   | -是吗 |
| 电子邮件 | 可变长字符串 | Fifty | 没有人 |   | -是吗 |   | -是吗 |
| 密码 | 茶 | Sixty | 没有人 |   | -是吗 |   | -是吗 |
| 注册日期 | DATETIME |   | 没有人 |   | -是吗 |   | -是吗 |
| 用户级别 | 蒂尼因特 | one | 没有人 | 无符号的 | -是吗 |   | -是吗 |

密码列的大小将由 PHP 最新的哈希标准决定。请访问 [`www.php.net`](http://www.php.net) 并根据需要调整尺寸。

使用*register-page.php*文件(包含在从[出版社下载的第](http://apress.com) [4](04.html) 章的文件中)。com )使用以下数据将管理员注册为普通会员:

*   名字:詹姆斯

*   *姓氏*:史密斯

*   电子邮件:jsmith@myisp.co.uk

*   *密码*:blacks m1

注册会员詹姆斯·史密斯将以笔名*杰克·史密斯*被任命为会员秘书。我们可以有把握地假设，詹姆斯·史密斯(别名杰克·史密斯)除了查看管理页面之外，偶尔也会查看成员页面。他将使用他的会员电子邮件和密码来查看会员页面，但是他需要不同的电子邮件和密码来访问管理部分。现在用他的假名和新密码第二次注册会员秘书，如下所示:

*   *名字*:杰克

*   *姓氏*:史密斯

*   电子邮件:jsmith@outcook.com

*   *密码* : D0gsb0dy

### 重要的

使用 phpMyAdmin 将杰克·史密斯的用户级别更改为 1。

### 注意

要更改 user_level，请在 phpMyAdmin 中单击数据库名称(在列列表中)，然后单击数据库名称下面列出的 users 表。单击杰克·史密斯左侧的编辑图标。将级别更改为 1，然后单击“开始”(或“保存”)。

现在注册这些成员，这样我们就有东西玩了。使用表 [4-2](#Tab2) 中的细节。

表 4-2

向成员建议的详细信息

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

西方人名的第一个字

 | 

姓

 | 

电子邮件

 | 

密码

 |
| --- | --- | --- | --- |
| 迈克 | 这是什么 | 米克尔@myisp.com | w1 llg @ T3 |
| 橄榄 | 树枝 | obranch@myisp.co.uk | An01yon@ |
| 弗兰克 | 香 | fincense@myisp.net | p @ RFM 3 |
| 泰丽 | Fide | tfide @ my ISP . com | 刀疤@dst1ff |
| 玫瑰 | 矮树丛 | rbush@myisp.co.uk | R@dbl00ms |
| 安妮 | 周年纪念 | aversary@myisp.com | h8 PPy # D8 和 |

您现在总共有八条记录。

### 注意

现在，我们将会话与成员的 user_level 一起使用，如果不首先以管理员身份登录(user_level = 1)，您将无法访问任何管理页面。如果您试图直接访问这些页面，它们会将您重定向到登录页面。

我们将使用第 [3](03.html) 章的管理员页面(图 [4-1](#Fig1) )来访问本章中的新功能。下一节将解释这些变化。

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig1_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig1_HTML.jpg)

图 4-1

管理页面

我们将使用名为 *view_users.php* 的修订页面显示一个扩展的数据表。下一节将演示这个概念。

## 修改“查看用户”页面以包括编辑和删除

显示表需要两个额外的链接列，以便管理员能够编辑和删除记录。在第 [3](03.html) 章中，我们将名字和姓氏连接在一起，这样它们就出现在一列中。为了能够对记录重新排序，名字和姓氏显示在不同的列中。密码必须始终受到保护，决不能显示在表格中。管理员通常能够重置密码，但不能查看当前密码。修改后的管理员显示将有六列，如表 [4-3](#Tab3) 所示。请记住，这不是*用户的*数据库表，而是将在屏幕上显示给管理员的表；这两张桌子完全不同。

表 4-3

仅为管理员显示的新表格的格式

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"> <col class="tcol5 align-left"> <col class="tcol6 align-left"></colgroup> 
| 

编辑

 | 

删除

 | 

姓

 | 

西方人名的第一个字

 | 

电子邮件

 | 

注册日期

 |
| --- | --- | --- | --- | --- | --- |
| 编辑 | 删除 | 这是什么 | 迈克 | 米克尔@myisp.com | 2018 年 10 月 30 日 |

两个新列现在有链接，使管理员能够与记录进行交互。最重要的是，这个页面只对管理员开放；所以它需要一个安全卫士，换句话说就是一个*会话*。

图 [4-2](#Fig2) 显示了该交互桌的外观

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig2_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig2_HTML.jpg)

图 4-2

用于管理员的交互式表格

### 注意

您可以使用 XAMPP 或 easyPHP 和浏览器来查看该表，但是在我们创建用于删除和编辑记录的页面之前，编辑和删除链接将不起作用。本章稍后将介绍这些页面。

清单 [4-2](#PC2) 显示了创建新视图用户页面的修改。

出于安全考虑，管理员页面以会话代码开头。

```php
<?php                                                                                //#1
session_start();
if (!isset($_SESSION['user_level']) || ($_SESSION['user_level'] != 1))
{
 header("Location: login.php");
exit();
}
?>
 <!DOCTYPE html>
<html lang="en">
<head>
 <title>Template for an interactive web page</title>
 <meta charset="utf-8">
 <meta name="viewport"
content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS File -->
  <link rel="stylesheet"
        href=
"https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
        integrity=
"sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
        crossorigin="anonymous">
</head>
<body>
<div class="container" style="margin-top:30px">
<!-- Header Section -->
<header class="jumbotron text-center row"
style="margin-bottom:2px; background: linear-gradient(white, #0073e6); padding:20px;">
               <?php include('header.php'); ?>
</header>
<!-- Body Section -->
<div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
 <nav class="col-sm-2">
        <ul class="nav nav-pills flex-column">
<?php include('nav.php'); ?>
        </ul>
  </nav>
<!-- Center Column Content Section -->
<div class="col-sm-8">
<h2 class="text-center">These are the registered users</h2>
<p>
<?php
try {
// This script retrieves all the records from the users table.                  #2
require('mysqli_connect.php'); // Connect to the database.
// Make the query:
// Nothing passed from user safe query
$query = "SELECT last_name, first_name, email, ";
$query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
$query .=
        " AS regdat, userid FROM users ORDER BY registration_date ASC";
// Prepared statement not needed since hardcoded
$result = mysqli_query ($dbcon, $query); // Run the query.
if ($result) { // If it ran OK, display the records.
// Table header.                                                                #3
echo '<table class="table table-striped">
<tr>
<th scope="col">Edit</th>
<th scope="col">Delete</th>
<th scope="col">Last Name</th>
<th scope="col">First Name</th>
<th scope="col">Email</th>
<th scope="col">Date Registered</th>
</tr>';
// Fetch and print all the records:                                             #4
while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {
               // Remove special characters that might already be in table to   #5
               // reduce the chance of XSS exploits
               $user_id = htmlspecialchars($row['userid'], ENT_QUOTES);
               $last_name = htmlspecialchars($row['last_name'], ENT_QUOTES);
               $first_name = htmlspecialchars($row['first_name'], ENT_QUOTES);
               $email = htmlspecialchars($row['email'], ENT_QUOTES);
               $registration_date =
htmlspecialchars($row['regdat'], ENT_QUOTES);                                 //#6
               echo '<tr>
                       <td><a href="edit_user.php?id=' . $user_id .
'">Edit</a></td>
                       <td><a href="delete_user.php?id=' . $user_id .
                              '">Delete</a></td>’;                            //#7
               echo '<td>' . $last_name . '</td>
                       <td>' . $first_name . '</td>
                       <td>' . $email . '</td>
                       <td>' . $registration_date . '</td>
               </tr>';
        }
        echo '</table>'; // Close the table.                                    #8
        mysqli_free_result ($result); // Free up the resources.
}
else { // If it did not run OK.
// Error message:
echo
'<p class="text-center">The current users could not be retrieved. ';
echo 'We apologize for any inconvenience.</p>';
// Debug message:
// echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $q . '</p>';
exit;
} // End of if ($result)
mysqli_close($dbcon); // Close the database connection.
}
catch(Exception $e) // We finally handle any problems here
{
     // print "An Exception occurred. Message: " . $e->getMessage();
     print "The system is busy please try later";
}
catch(Error $e)
{
      //print "An Error occurred. Message: " . $e->getMessage();
      print "The system is busy please try again later.";
         }
?>
</div>
<!-- Right-side Column Content Section -->
<aside class="col-sm-2">
      <?php include('info-col.php'); ?>
</aside>
</div>
<!-- Footer Content Section -->
<footer class="jumbotron text-center row"
style="padding-bottom:1px; padding-top:8px;">
  <?php include('footer.php'); ?>
</footer>
</div>
</body>
</html>

Listing 4-2Amending the Table View to Include Two Links (admin-view-users.php)

```

### 代码的解释

本节解释代码。

```php
<?php
session_start();
//                                                                                    #1
if (!isset($_SESSION['user_level']) or ($_SESSION['user_level'] != 1))
{
        header("Location: login.php");
        exit();
}
?>

```

此会话代码保护页面，并将任何未经授权的用户返回到登录页面。除非是管理员(user_level = 1)，否则任何人都不能访问该页面。

```php
<?php
try {
// This script retrieves all the records from the users table.                        #2

require('mysqli_connect.php'); // Connect to the database.

// Make the query:
// Nothing passed from user safe query

$query =
"SELECT last_name, first_name, email, DATE_FORMAT(registration_date, '%M %d, %Y')";

$query .=
        " AS regdat, userid FROM users ORDER BY registration_date ASC";

// Prepared statement not needed since hardcoded
$result = mysqli_query ($dbcon, $query); // Run the query.

if ($result) { // If it ran OK, display the records.

```

前面的代码从 users 表中选择项目，这些项目将填充所显示的表中的列。DATE_FORMAT 函数将以月、日、年的格式格式化从表中检索的 registration_date。AS 语句将允许我们使用 regdat 名称检索这个格式化的日期。如果我们使用 registration_date 名称检索日期，它仍然是表中存在的任何格式。表格记录按注册日期的升序(ASC)显示。要按降序显示记录，请使用 DESC。

```php
// Table header.                                                                       #3
echo '<table class="table table-striped">
<tr>
<th scope="col">Edit</th>
<th scope="col">Delete</th>
<th scope="col">Last Name</th>
<th scope="col">First Name</th>
<th scope="col">Email</th>
<th scope="col">Date Registered</th>
</tr>';

```

这段代码显示了一个 HTML 表格，在标题行中有六个标题。每一行都有交替的颜色。

```php
// Fetch and print all the records:                                                    #4
while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {

```

代码遍历用户表的数据(包含在$result 中)，直到所有数据都显示出来。这是通过 while()函数实现的。数据被放入一个名为$row 的关联数组中。关联数组使用键(如 user_id)而不是索引(数字)来确定使用哪一列。例如，在下面的代码中，associate array $row 包含一个键为 *userid* 的列。这些键是使用数据库表中的列名自动创建的。

```php
       // Remove special characters that might already be in table to                  #5
               // reduce the chance of XSS exploits
               $user_id = htmlspecialchars($row['userid'], ENT_QUOTES);
               $last_name = htmlspecialchars($row['last_name'], ENT_QUOTES);
               $first_name = htmlspecialchars($row['first_name'], ENT_QUOTES);
               $email = htmlspecialchars($row['email'], ENT_QUOTES);
               $registration_date =
htmlspecialchars($row['regdat'], ENT_QUOTES);

```

我们正在尽一切努力在数据库表中插入好的有效数据。那么，我们不能假设我们只是从数据库中提取了好的数据吗？不要。原因有二；第一个是表中的数据可能包含可被执行的有害代码，第二个是我们的程序可能被欺骗，以为数据来自表，而实际上它来自其他地方。所以，我们必须确保我们的代码是不可执行的。最简单的方法是将所有可执行字符(如引号、逗号、括号)转换成转义字符("-->/")。这不会清除数据，但会使数据无法执行。ENT_QUOTES 参数坚持单引号和双引号都要转义。本章和其余章节中的所有代码都将使用这种格式来确保显示的任何数据都是不可执行的。

```php
//                                                                                  #6
               echo '<tr>
<td><a href="edit_user.php?id=' . $user_id . '">Edit</a></td>
<td><a href="delete_user.php?id=' . $user_id . '">Delete</a></td>’;

```

前面的代码在每行的前两个单元格中创建了一个链接。这些链接连接到页面 *edit_user.php* 和 *delete_user.php* 。创建的 URL 链接包含一个 id 参数，该参数的值在$user_id 变量中给出(来自表)。当代码遍历 users 表中的数据时，它为每一行存储相应的 user_id。

该行的 user_id 通过 PHP 程序的 URL 地址“传递”给处理删除或编辑的页面。这里有一个例子:

```php
<td><a href="delete_user.php?id=1">Delete</a></td>

```

ID (user_id)是数据库表中的实际行号。PHP 程序将使用这个数字来决定编辑或删除哪一行。整行代码都是一个链接，单击它将编辑或删除所标识的行。为了清楚起见，图 [4-3](#Fig3) 显示了交互表和两个链接的片段。

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig3_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig3_HTML.jpg)

图 4-3

在前两个单元格中显示一条记录和两个链接

```php
//                                                                                  #7
              echo '<td>' . $last_name . '</td>
               <td>' . $first_name . '</td>
               <td>' . $email . '</td>
               <td>' . $registration_date . '</td>
               </tr>';

```

在前面的代码块中，$last_name，$first_name，$email 和$registration_date 中包含的值显示在表的相关列中。

```php
echo '</table>'; // Close the table.                                                #8
mysqli_free_result ($result); // Free up the resources.

```

表的结束标记完成了表的显示，并且释放了内存资源。程序本身会在停止时释放资源，但我们也可以在语句显示时这样做。剩下的代码处理错误消息，并将页脚添加到显示的页面中。在我们创建用于搜索、编辑和删除的页面之前，我们需要停下来做一个有用的转换。

下一节描述一次显示一页表格的方法。

## 显示记录页面(分页)

由文件 *view_users.php* 创建的表格显示最多可以显示 30 条记录。更多的记录会导致表格超出大多数监视器的显示大小。这将迫使管理员向下滚动页面以查看更多记录。想象一下，如果数据库包含 1，000 条或更多记录，会发生什么。创建一次在一个屏幕上查看表格数据的能力将提供一个解决方案；然而，即使这样，对于大型数据库来说也是不方便的。在本章的后面，我们将研究一种在大型数据库中选择和查看特定记录的更巧妙的方法；同时，我们将学习如何显示表格，以便管理员可以一次看到一页。这个过程被称为*分页*。

20 到 25 行的页面长度是明智的选择；然而，出于本教程的目的，让我们测试一下这种能力，而不必在数据库中输入大量记录。我们将把每个显示页面的行数设置为 4，因此我们只需要再输入几个成员来进行演示。这将为我们提供四个页面来显示。

表 [4-4](#Tab4) 建议另外十个成员注册。

表 4-4

注册会员的详细信息

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

西方人名的第一个字

 | 

姓

 | 

电子邮件

 | 

密码

 |
| --- | --- | --- | --- |
| Ⅳ．　珀西 | 转向 | pver @ my ISP . com | K @ @ pg0ing |
| 斯坦 | 达尔德族人 | sdad @ my ISP . net | B@tt13fl@g |
| Honora | 骨 | nbone@myisp.com | L1k@t@rr1@r |
| 巴里 | 凯德 | bcade@myisp.co.uk | Bl0ckth@m |
| 迪伊 | 被拒绝 | djected@myisp.ork.uk | Gl00mnd00m# |
| 林恩 | 马 | lseed@myisp.com | Pa1nt@rs01 |
| 巴里 | 音调 | btone@myisp.net | N1c@v01c3 |
| 海伦 | 背部 | hback@myisp.net | Agr1ms0rt1@ |
| 贾斯廷 | 情况 | jcase@myisp.co.uk | 我正在寻找 10u@ |
| 尿壶 | 设置文件属性 | jattrik@myisp.com | 火@rlyman |

数据库现在将有 18 条记录。当我们将它除以 4(每页的行数)时，我们将得到 4 . 5 页。根据这一解释，在清单 [4-3a](#PC13) 中，对于 *admin_view_users.php* ，您将看到每页的行数由变量 pagerows 设置，如下所示:

```php
$pagerows = 4;

```

通过给变量赋值(比如 9 或 15)来试验这个值，以查看在网页中显示的效果。

图 [4-4](#Fig4) 显示了每页四条记录的显示以及通过前后移动显示表格内容的链接。该页面还显示成员总数。

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig4_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig4_HTML.jpg)

图 4-4

显示屏现在每页显示四条记录，并显示会员总数

名为 process _*admin _ view _ users . PHP*的页面包含分页代码。

在图 [4-4](#Fig4) 中，显示在工作台*、*下方的链接“上一个”和“下一个”使工作台移动。除了这些链接，我们还可以使用可点击的页码或按钮。然而，如果你不知道每一页上有什么，一个页码是没有多大用处的。浏览页面并显示所有成员的能力对管理员很有用。分页也将使管理员能够打印每一页。这将在第 7 章[中描述。为了显示特定成员的记录，我们将使用本章后面显示的新的搜索菜单按钮。](07.html)

清单 [4-3a](#PC13) 包含了支持分页的代码。在文件 *admin_view_users.php* 中放置了一个必需的语句，以将 php 代码与其他代码分开。 *admin_view_users.php* 文件没有列出，因为它与已经显示的其他文件相似。您可以在本章的下载文件中查看它。

```php
<?php
try {
        // This script retrieves all the records from the users table.
        require('mysqli_connect.php'); // Connect to the database.
        //set the number of rows per display page
        $pagerows = 4; //                                                           #1
        // Has the total number of pages already been calculated?
        if ((isset($_GET['p']) && is_numeric($_GET['p']))) {
        //already been calculated
               $pages = htmlspecialchars($_GET['p'], ENT_QUOTES);
               // make sure it is not executable XSS
        }else{//use the next block of code to calculate the number of pages         #2
               //First, check for the total number of records
               $q = "SELECT COUNT(userid) FROM users";
               $result = mysqli_query ($dbcon, $q);
               $row = mysqli_fetch_array ($result, MYSQLI_NUM);
               $records = htmlspecialchars($row[0], ENT_QUOTES);
               // make sure it is not executable XSS
               //Now calculate the number of pages
               if ($records > $pagerows){ //                                        #3
                //if the number of records will fill more than one page
               //Calculate the number of pages and round the result up to the
               //  nearest integer
                       $pages = ceil ($records/$pagerows); //
               }else{
                       $pages = 1;
               }
        }//page check finished
        //Declare which record to start with                                        #4
        if ((isset($_GET['s'])) &&( is_numeric($_GET['s'])))
        {
               $start = htmlspecialchars($_GET['s'], ENT_QUOTES);
               // make sure it is not executable XSS
        }else{
               $start = 0;
        }
        $query = "SELECT last_name, first_name, email, "; //                        #5
        $query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
        $query .=
        " AS regdat, userid FROM users ORDER BY registration_date ASC";
        $query .=" LIMIT ?, ?";
        $q = mysqli_stmt_init($dbcon);
        mysqli_stmt_prepare($q, $query);
        // bind start and pagerows to SQL Statement
        mysqli_stmt_bind_param($q, "ii", $start, $pagerows);
        // execute query
        mysqli_stmt_execute($q);
        $result = mysqli_stmt_get_result($q);
        if ($result) {
        // If it ran OK (records were returned), display the records.
               // Table header.
               echo '<table class="table table-striped">
               <tr>
               <th scope="col">Edit</th>
               <th scope="col">Delete</th>
               <th scope="col">Last Name</th>
               <th scope="col">First Name</th>
               <th scope="col">Email</th>
               <th scope="col">Date Registered</th>
               </tr>';
                       // Fetch and print all the records:
               while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {
               // Remove special characters that might already be in table to
                       // reduce the chance of XSS exploits
                       $user_id = htmlspecialchars($row['userid'], ENT_QUOTES);
                       $last_name =
                              htmlspecialchars($row['last_name'], ENT_QUOTES);
                       $first_name =
                              htmlspecialchars($row['first_name'], ENT_QUOTES);
                       $email = htmlspecialchars($row['email'], ENT_QUOTES);
                       $registration_date =
                              htmlspecialchars($row['regdat'], ENT_QUOTES);
                       echo '<tr>
                       <td><a href="edit_user.php?id=' . $user_id .
                              '">Edit</a></td>
                       <td><a href="delete_user.php?id=' . $user_id .
                              '">Delete</a></td>
                       <td>' . $last_name . '</td>
                       <td>' . $first_name . '</td>
                       <td>' . $email . '</td>
                       <td>' . $registration_date . '</td>
                       </tr>';
               }
               echo '</table>'; // Close the table.
               mysqli_free_result ($result); // Free up the resources.
        }
        else { // If it did not run OK.
               // Error message:
        echo '<p class="text-center">The current users could not be ';
        echo 'retrieved. We apologize for any inconvenience.</p>';
               // Debug message:
        // echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $q . '</p>';
               exit;
        } // End of else ($result)
        // Now display the total number of records/members.                             #6
        $q = "SELECT COUNT(userid) FROM users";
        $result = mysqli_query ($dbcon, $q);
        $row = mysqli_fetch_array ($result, MYSQLI_NUM);
        $members = htmlspecialchars($row[0], ENT_QUOTES);
        mysqli_close($dbcon); // Close the database connection.
        $echostring = "<p class='text-center'>Total membership: $members </p>";
        $echostring .= "<p class='text-center'>";
        if ($pages > 1) {   //                                                          #7
               //What number is the current page?
               $current_page = ($start/$pagerows) + 1;
               //If the page is not the first page then create a Previous link
               if ($current_page != 1) {
                       $echostring .=
               '<a href="admin_view_users.php?s=' . ($start - $pagerows) .
                              '&p=' . $pages . '">Previous</a> ';
               }
               //Create a Next link                                                     #8
               if ($current_page != $pages) {
                       $echostring .=
               ' <a href="admin_view_users.php?s=' . ($start + $pagerows) .
                              '&p=' . $pages . '">Next</a> ';
               }
               $echostring .= '</p>';
        echo $echostring;
        }
} //end of try
catch(Exception $e) // We finally handle any problems here
{
        // print "An Exception occurred. Message: " . $e->getMessage();
        print "The system is busy please try later";
}
catch(Error $e)
{
        //print "An Error occurred. Message: " . $e->getMessage();
        print "The system is busy please try again later.";
}
?>

Listing 4-3aCreating a Table Display

That Will Paginate (process_admin_view_users.php)

```

### 代码的解释

本节解释代码。

```php
$pagerows = 4;                                                                    // #1

```

$pagerows 控制每页显示的行数。显示设置为每页四条记录。(在真实的页面中，您可以将这个值设置为 20 左右。)

```php
}else{//use the next block of code to calculate the number of pages                  #2
      //First, check for the total number of records
      $q = "SELECT COUNT(userid) FROM users";
      $result = mysqli_query ($dbcon, $q);
      $row = mysqli_fetch_array ($result, MYSQLI_NUM);
      $records = htmlspecialchars($row[0], ENT_QUOTES);
      // make sure it is not executable XSS
      //Now calculate the number of pages

```

前面的代码将计算数据库的 users 表中的记录数(COUNT(user_id))。创建一个数值数组(由 MYSQLI_NUM 的用户指示)$row，并将行数放入其中。这个数组的唯一内容是记录的数量。这个值是从 array 的零位置复制的，经过清理后放入变量$records 中。

下面的代码检查记录数是否大于每页显示的记录数($pagerows)。

```php
               if ($records > $pagerows){ //                                         #3
                //if the number of records will fill more than one page
//Calculate the number of pages and round the result up to the nearest integer
                       $pages = ceil ($records/$pagerows); //
               }else{
                       $pages = 1;
               }

```

如果记录数大于每页显示的记录数，PHP 函数 ceil()将向上舍入所需的页数(由记录数除以每页记录数确定)。在教程中，我们有 18 条记录，结果是 4.5 页(18 除以 4)。这是四舍五入到五页。第五页将只显示两条记录。如果记录数不大于每次显示的行数，则只有一页。函数 ceil()表示*将上限*或*设置为高于实际计数*的整数；在这种情况下，4.5 变成了 *5* 。

```php
//Declare which record to start with                                                   #4
if ((isset($_GET['s'])) &&( is_numeric($_GET['s'])))
{
        $start = htmlspecialchars($_GET['s'], ENT_QUOTES);
        // make sure it is not executable XSS
}else{
        $start = 0;
}

```

当用户单击网页上的上一个或下一个链接时，s 中的值被传递(稍后将解释该代码)。如果用户确实单击了这些链接中的一个，那么它将包含一个要显示的记录的起点(比如记录号 5 ),并且该值将放在$start 中。如果没有传递任何值(没有设置 s)，则假定将显示第一组记录，并将$start 的值设置为 0。如果 s 中以某种方式存在一个非数值，那么$start 也将被设置为 0。

```php
$query = "SELECT last_name, first_name, email, "; //                                   #5
$query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
$query .=
" AS regdat, userid FROM users ORDER BY registration_date ASC";
$query .=" LIMIT ?, ?";
$q = mysqli_stmt_init($dbcon);
mysqli_stmt_prepare($q, $query);
// bind start abd pagerows to SQL Statement
mysqli_stmt_bind_param($q, "ii", $start, $pagerows);
// execute query
mysqli_stmt_execute($q);
$result = mysqli_stmt_get_result($q);

```

该查询从用户表中选择要显示的列(姓氏、名字、电子邮件、注册日期)。从表中检索的信息仅限于需要在当前页面上显示的记录。例如，在第一页上，$start 将被设置为 0，$pagerows 将被设置为 4。将只检索从 0 到 4 的行。检索到的记录也将按升序排序。尽管我们之前清理了$start 和$pagerows，但是为了更加安全，我们将使用一个准备好的语句。

一些程序员可能选择一次从数据库中检索所有记录，并将它们放入一个数组中。这是一种常见的做法。但是，因为我们必须在每次想要显示另一个页面时向服务器发送请求，所以我们可以直接从数据库中提取下一组记录。这对于较小的信息表很有效。

```php
// Now display the total number of records/members.                                    #6
$q = "SELECT COUNT(userid) FROM users";
$result = mysqli_query ($dbcon, $q);
$row = mysqli_fetch_array ($result, MYSQLI_NUM);
$members = htmlspecialchars($row[0], ENT_QUOTES);
mysqli_close($dbcon); // Close the database connection.
$echostring = "<p class='text-center'>Total membership: $members </p>";
$echostring .= "<p class='text-center'>";

```

如前所述，这段代码计算表中的总行数。返回值将被放入`$row[0]`中。该值被清理并放入$members 中，它将显示在页面上。

```php
if ($pages > 1) {   //                                                                 #7
       //What number is the current page?
       $current_page = ($start/$pagerows) + 1;
       //If the page is not the first page then create a Previous link
       if ($current_page != 1) {
               $echostring .= '<a href="admin_view_users.php?s=' .
                      ($start - $pagerows) .
                      '&p=' . $pages . '">Previous</a> ';
       }

```

创建名为 Previous 的链接，该链接调用 admin_view_users.php 程序。如前所述，s(起始位置)将包含要在页面上显示的第一条记录(如记录 0 或记录 4)。这是通过从上一个开始位置($start)减去一页中要显示的总行数($pagerow)来计算的。例如，如果当前开始位置是 20，我们从这个位置减去 4，新的开始位置(放在 s 中)现在是 16。$pages 包含之前计算的所需页数。如果$current_page 为 1，则不会显示上一个链接。

```php
       //Create a Next link                                                           #8
       if ($current_page != $pages) {
               $echostring .=
       ' <a href="admin_view_users.php?s=' . ($start + $pagerows) .
                      '&p=' . $pages . '">Next</a> ';
       }
       $echostring .= '</p>';
echo $echostring;
}

```

下一个链接的创建方式与上一个链接类似。唯一不同的是计算方式。起始位置($start)被添加到要在页面上显示的行数($pagerow)中，以确定 s 的值(起始位置)。如果当前起始位置为零，并且页面上显示的行数为 4，则下一个起始位置为 4。单击该链接时，页面将显示记录 4–7。如果当前页面是最后一页($current_page == $pages)，则不会显示下一个链接。完成的字符串现在显示在页面上。

启动 XAMPP 或 easyPHP，然后以管理员身份登录查看分页。调整$pagerows 的值，看看它如何改变页面的行为。

虽然这是一个很好的练习，但更常见的是我们只想搜索一条记录，而不是显示所有记录(尤其是当有数百条记录时)。让我们决定如何搜索一个特定的记录，然后显示它。

您可能已经注意到, *admin_view_users.php* 页面的标题已经更改，因此查看成员按钮是到 *admin_view_users.php* 页面的链接。此外，一个新的按钮链接到搜索页面【search.php T4】。清单 [4-3b](#PC22) 展示了这些变化。

```php
<div class="col-sm-2">
         <img class="img-fluid float-left" src="logo.jpg" alt="Logo">
</div>
<div class="col-sm-8">
        <h1 class="blue-text mb-4 font-bold">Header Goes Here</h1>
 </div>
<nav class="col-sm-2">
<div class="btn-group-vertical btn-group-sm" role="group"
        aria-label="Button Group">
        <button type="button" class="btn btn-secondary"
               onclick="location.href = 'logout.php'" >Logout</button>
        <button type="button" class="btn btn-secondary"
               onclick="location.href = 'admin_view_users.php'">View Members</button>
        <button type="button" class="btn btn-secondary"
               onclick="location.href = 'search.php'">Search</button>
        <button type="button" class="btn btn-secondary"
               onclick="location.href = 'register-password.php'">New Password</button>
</div>
</nav>

Listing 4-3bCreating the Revised Administration Header

(header-admin.php)

```

## 规划搜索标准

管理员需要一个搜索工具，不需要滚动浏览大量记录来编辑或删除一个记录。前瞻性规划的重要性怎么强调都不过分；决定如何组织搜索工具需要仔细考虑。

管理员可以编辑和删除记录。那么，什么活动需要他们使用这些设施呢？对于编辑，该事件通常是由成员请求管理员更改电子邮件地址或名称引起的。如果成员辞职或死亡，就会发生删除。

有些名字很常见，例如，我们有五个人叫詹姆斯·史密斯。在我们的例子中，我们需要显示这五个人，然后使用他们的电子邮件地址来区分他们，这样我们就不会删除错误的詹姆斯·史密斯。

### 注意

通常还会创建一个唯一的键来标识受影响的记录。在我们的例子中，电子邮件可以用来完成这一点。更常见的情况是，创建一个唯一的成员 ID。美国的一些组织使用社会安全号码。然而，这不是一个好的选择，因为这个数字与许多个人财务记录(如退休、医疗和支票账户)相关联。

下一个教程描述了显示搜索结果的页面的创建。为此，您需要注册四个名为詹姆斯·史密斯的成员。表 [4-5](#Tab5) 提供了一些建议。

表 4-5

一些相同的常用名

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

西方人名的第一个字

 | 

姓

 | 

电子邮件

 | 

密码

 |
| --- | --- | --- | --- |
| 詹姆斯 | 锻工 | jimsmith@myisp.org.uk | Ch@vr0n1 |
| 詹姆斯 | 锻工 | James.smith@myisp.com | 包括 1n3d |
| 詹姆斯 | 锻工 | Jimmy.smith@myisp.co.uk | P@d@stal |
| 詹姆斯 | 锻工 | jims@myisp.net | 钨@n |

当你注册后，总共会有五个叫詹姆斯·史密斯的成员，我们数据库中的记录总数将是 22。

## 用于显示指定成员的临时搜索页面

我们最终将创建一个搜索工具，但首先我们必须创建一个页面，将产生一个名为詹姆斯·史密斯的成员表。搜索*詹姆斯·史密斯*的目标或最终结果将是一个表格，如图 [4-5](#Fig5) 所示。

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig5_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig5_HTML.jpg)

图 4-5

詹姆斯·史密斯的五件作品已经找到，现在正在展出

为了确保我们能够显示如图 [4-5](#Fig5) 所示的表格，我们需要创建一个名为*temp _ view _ found _ record . PHP*的页面。因为我们还没有创建搜索页面，所以作为临时的权宜之计，我们将在代码中将姓名**詹姆斯**和**史密斯**直接输入到 SQL 查询中。PHP 代码在文件*process _ temp _ view _ found _ record . PHP*中，如清单 [4-4](#PC23) 所示。

### 注意

这些是页面的临时版本。在制作最终版本之前，这是一个有用的阶段。它展示了一个重要的原则，并且是证明将显示一个表的一个有用的练习。本章的可下载文件中包含的临时版本为*temp _ view _ found _ record . PHP*和*process _ temp _ view _ found _ record . PHP*。

```php
<?php
try
{

        // This script retrieves records from the users table.                      #1
        require ('mysqli_connect.php'); // Connect to the db.
        echo '<p class="text-center">If no record is shown, ';
        echo 'this is because you had an incorrect ';
        echo ' or missing entry in the search form.';
        echo '<br>Click the back button on the browser and try again</p>';
        $query = "SELECT last_name, first_name, email, ";
        $query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
        $query .=" AS regdat, userid FROM users WHERE ";
        $query .= "last_name='Smith' AND first_name="James" ";
        $query .="ORDER BY registration_date ASC ";
        // Prepared statement not needed because string is hard coded
        $result = mysqli_query ($dbcon, $query); // Run the query.
        if ($result) { // If it ran, display the records.
               // Table header.
               echo '<table class="table table-striped">
               <tr>
               <th scope="col">Edit</th>
               <th scope="col">Delete</th>
               <th scope="col">Last Name</th>
               <th scope="col">First Name</th>
               <th scope="col">Email</th>
               <th scope="col">Date Registered</th>
               </tr>';
               // Fetch and display the records:
               while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {
               // Remove special characters that might already be in table to
                       // reduce the chance of XSS exploits
                       $user_id = htmlspecialchars($row['userid'], ENT_QUOTES);
                       $last_name =
                              htmlspecialchars($row['last_name'], ENT_QUOTES);
                       $first_name =
                              htmlspecialchars($row['first_name'], ENT_QUOTES);
                       $email = htmlspecialchars($row['email'], ENT_QUOTES);
                       $registration_date =
                              htmlspecialchars($row['regdat'], ENT_QUOTES);
                       echo '<tr>
                              <td><a href="edit_user.php?id=' . $user_id .
                               '">Edit</a></td>
                              <td><a href="delete_user.php?id=' . $user_id .
                               '">Delete</a></td>
                              <td>' . $last_name . '</td>
                              <td>' . $first_name . '</td>
                              <td>' . $email . '</td>
                              <td>' . $registration_date . '</td>
                              </tr>';
               }
               echo '</table>'; // Close the table.
               mysqli_free_result ($result); // Free up the resources.
        } else { // If it did not run OK.
               // Public message:
        echo '<p class="error">The current users could not be retrieved.';
               echo 'We apologize for any inconvenience.</p>';
               // Debugging message:
        //echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $q . '</p>';
               //Show $q is debug mode only
        }
// End of if ($result). Now display the total number of records/members.
        mysqli_close($dbcon); // Close the database connection.
}
catch(Exception $e)
{
        print "The system is currently busy. Please try later.";
        //print "An Exception occurred.Message: " . $e->getMessage();
}
catch(Error $e)
{
        print "The system us busy. Please try later.";
        //print "An Error occurred. Message: " . $e->getMessage();
}
?>

Listing 4-4Creating a Temporary Page for Displaying the Results of a Search (process_temp_view_found_record.php)

```

### 代码的解释

本节解释代码。

```php
// This script retrieves records from the users table.                                 #1
require ('mysqli_connect.php'); // Connect to the db.
echo '<p class="text-center">If no record is shown, ';
echo 'this is because you had an incorrect ';
echo ' or missing entry in the search form.';
echo '<br>Click the back button on the browser and try again</p>';
$query = "SELECT last_name, first_name, email, ";
$query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
$query .=" AS regdat, userid FROM users WHERE ";
$query .= "last_name='Smith' AND first_name="James" ";
$query .="ORDER BY registration_date ASC ";

```

这个 select 语句将从 users 表中提取所有詹姆斯·史密斯记录，并按照注册日期将它们按升序排列。

这个 SQL 查询与*process _ admin _ view _ users . PHP*中的查询几乎相同，只是取消了对行数的限制，并引入了一个新的关键字 WHERE。取消对行数的限制可以确保无论有多少条詹姆斯·史密斯记录都会显示出来。WHERE 子句确切指定要显示哪些记录。我们输入名称是一种临时的权宜之计，这样我们就可以测试页面并确保它按预期工作。这是一种常见的技术，被称为*硬编码*。结果表格显示如图 [4-5](#Fig5) 所示。

请记住，这是搜索页面的临时版本。在常规搜索中，我们不会在 select 语句中编码实际的名字和姓氏。

要查看此表，请启动您的服务器并以管理员身份登录。在浏览器的地址栏中输入**http://localhost/admin table/temp _ view _ found _ record . PHP**。

### 注意

现在我们正在使用会话，如果不作为管理员登录，您将无法访问任何管理页面。

我们现在有了一个页面，它将显示指定记录的表格。工作正常后，下一步是提供一个搜索表单，以便管理员可以请求一个显示任何指定成员而不仅仅是詹姆斯·史密斯的表。

这个例子很适合测试，但是不太实用。让我们调整我们的逻辑，使它更有用。

## 搜索表单

当管理员点击标题菜单上的搜索按钮时，将出现*search.php*页面。该页面有一个包含两个字段的表单，可以在其中输入搜索条件。需要计划来决定搜索标准应该是什么。虽然电子邮件地址将为管理员提供用于查找成员的唯一标识符，但它可能是未知的。成员的注册日期不是查找成员的好选择，因为成员不可避免地会忘记他们注册的确切日期。管理员需要知道一些独特但显而易见的信息来显示成员的记录。显而易见的标准是成员的名和姓；因此，这就是我们将使用的。名字和姓氏可能不是唯一的，但正如我们对詹姆斯·史密斯所做的那样，我们可以显示所有名字和姓氏相同的用户，然后决定哪个是要修改的正确成员信息。

注意:提供多种方式来搜索成员记录是有益的。您可以改进这个示例，允许管理员根据电子邮件地址或者名字和姓氏进行搜索。通过提供这两者，您只允许在已知电子邮件的情况下获取唯一记录。否则，可以在姓氏和名字相同的所有成员中搜索正确的记录。

图 [4-6](#Fig6) 显示了搜索表单。

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig6_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig6_HTML.jpg)

图 4-6

搜索表单

搜索表单使管理员能够搜索特定记录。如果搜索成功，表单将调用 *view_found_record.php* 页面。该页面将显示用户(或多个用户)。如果几个人有相同的名字和姓氏，表格将显示所有人。

暂时不要尝试输入搜索。我们将需要调整我们的视图发现页面，目前总是显示詹姆斯·史密斯的记录。这个临时页面将被更改，以接受清单 [4-5a](#PC25) 中描述的搜索表单中的值。

```php
<?php
         session_start();                                                             // #1
         if (!isset($_SESSION['user_level']) or ($_SESSION['user_level'] != 1))
         {
                 header("Location: login.php");
                 exit();
         }
?>
<!DOCTYPE html>
<html lang="en">
<head>
<title>Search Page</title>
<meta charset="utf-8">
<meta name="viewport" content=
        "width=device-width, initial-scale=1, shrink-to-fit=no">
 <!-- Bootstrap CSS File -->
 <link rel="stylesheet"
         href=
"https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
         integrity=
"sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
        crossorigin="anonymous">
</head>
<body>
<div class="container" style="margin-top:30px">
<!-- Header Section -->
<header class="jumbotron text-center row col-sm-14"
        style=
"margin-bottom:2px; background:linear-gradient(white, #0073e6);padding:20px;">
        <?php include('header-admin.php'); ?>
</header>
<!-- Body Section -->
 <div class="row" style="padding-left: 0px;">
<!-- Left-side Column Menu Section -->
<nav class="col-sm-2">
      <ul class="nav nav-pills flex-column">
                <?php include('nav.php'); ?>
      </ul>
 </nav>
<div class="col-sm-8">
<h2 class="h2 text-center">Search for a record</h2>
<h6 class="text-center">Both names are required items</h6>
<form action="view_found_record.php" method="post">
<div class="form-group row">                                                    <!-- #2 -->
   <label for="first_name" class="col-sm-4 col-form-label">First Name:</label>
   <div class="col-sm-8">
   <input type="text" class="form-control" id="first_name" name="first_name"
          placeholder="First Name" maxlength="30" required
          value=
                "<?php if (isset($_POST['first_name']))
                echo htmlspecialchars($_POST['first_name'], ENT_QUOTES); ?>" >
  </div>
  </div>
  <div class="form-group row">
  <label for="last_name" class="col-sm-4 col-form-label">Last Name:</label>
  <div class="col-sm-8">
  <input type="text" class="form-control" id="last_name" name="last_name"
          placeholder="Last Name" maxlength="40" required
          value=
                "<?php if (isset($_POST['last_name']))
                echo htmlspecialchars($_POST['last_name'], ENT_QUOTES); ?>">
 </div>
 </div>
<div class="form-group row">
<label for="" class="col-sm-4 col-form-label"></label>
<div class="col-sm-8">
        <input id="submit" class="btn btn-primary" type="submit"
                name="submit" value="Search">
</div>
</div>
</form>
</div>
<!-- Right-side Column Content Section -->
<?php
 if(!isset($errorstring)) {
        echo '<aside class="col-sm-2">';
        include('info-col.php');
        echo '</aside>';
        echo '</div>';
        echo '<footer class="jumbotron text-center row col-sm-14"
               style="padding-bottom:1px; padding-top:8px;">';
 }
else
 {
        echo '<footer class="jumbotron text-center col-sm-12"
        style="padding-bottom:1px; padding-top:8px;">';
 }
  include('footer.php');
 ?>
</footer>
</div>
</body>
</html>

Listing 4-5aCreating the Search Form (search.php)

```

### 代码的解释

本节解释代码。

```php
<?php
        session_start();                                                               // #1
        if (!isset($_SESSION['user_level']) or ($_SESSION['user_level'] != 1))
        {
               header("Location: login.php");
               exit();
        }
?>

```

我们所有的管理 HTML 页面都包含这段代码。会话是我们的安全卫士；未经授权的人(任何不是管理员的人)将被重定向到登录页面。

```php
<div class="form-group row">                                                     <!-- #2 -->
   <label for="first_name" class="col-sm-4 col-form-label">First Name:</label>
   <div class="col-sm-8">
   <input type="text" class="form-control" id="first_name" name="first_name"
          placeholder="First Name" maxlength="30" required
          value=
                "<?php if (isset($_POST['first_name']))
                echo htmlspecialchars($_POST['first_name'], ENT_QUOTES); ?>" >
  </div>
  </div>

```

代码提供了一个*粘性表单*。粘性表单是在标记错误时保留用户输入的表单。如果用户每次需要纠正错误(如没有填写某个字段)时都必须填写整个表单，他们会感到很恼火。粘性组件是值后面的 PHP 代码，例如:

```php
  value=
        "<?php if (isset($_POST['first_name']))
        echo htmlspecialchars($_POST['first_name'], ENT_QUOTES); ?>" >

```

该表单将使用 POST 提交所有表单数据。我们希望表单数据不会被外力修改。然而，这些数据有可能被修改以攻击我们的系统、数据库或网络。因此，我们使用 htmlspecialchars 函数来整理数据。如上所述，所有可能包含在可执行代码中的符号现在都被转义("--> \ ")。这确保了信息是不可执行的。它不会清除数据，但至少不太可能有害。

我们稍后将添加一些人类检测能力，这将降低程序使用我们的表单的能力。

我们现在将使表单处理程序*temp _ view _ found _ record . PHP*更加通用。

## 接收搜索表单输入的最终表单处理程序

下面的代码(process _*view _ found _ record . php*)展示了 PHP 代码中添加或修改的内容。这些项目使文件能够接收从【search.php】页面发送的名字和姓氏。名和姓被分配给变量，这些变量用于搜索数据库，以便可以对它们进行验证。这些变量随后用于显示记录。

清单 [4-5b](#PC29) 显示了消除硬编码并允许搜索任何注册成员记录的代码。

```php
<?php
try
{
    // This script retrieves records from the users table.
    require ('./mysqli_connect.php'); // Connect to the db.
    echo '<p class="text-center">If no record is shown, ';
    echo 'this is because you had an incorrect ';
    echo ' or missing entry in the search form.';
    echo '<br>Click the back button on the browser and try again</p>';
    //                                                                           #1
    $first_name = htmlspecialchars($_POST['first_name'], ENT_QUOTES);
    $last_name = htmlspecialchars($_POST['last_name'], ENT_QUOTES);
    // Since it's a prepared statement below this sanitizing is not needed
    // However, to consistently retrieve than sanitize is a good habit
    //                                                                           #2
    $query = "SELECT last_name, first_name, email, ";
    $query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
    $query .=" AS regdat, userid FROM users WHERE ";
    $query .= "last_name=? AND first_name=? ";
    $query .="ORDER BY registration_date ASC ";
    $q = mysqli_stmt_init($dbcon);
    mysqli_stmt_prepare($q, $query);

    // bind values to SQL Statement
    mysqli_stmt_bind_param($q, 'ss', $last_name, $first_name);

    // execute query
    mysqli_stmt_execute($q);

    $result = mysqli_stmt_get_result($q);

    if ($result) { // If it ran, display the records.
    // Table header.
             echo '<table class="table table-striped">
             <tr>
             <th scope="col">Edit</th>
             <th scope="col">Delete</th>
             <th scope="col">Last Name</th>
             <th scope="col">First Name</th>
             <th scope="col">Email</th>
             <th scope="col">Date Registered</th>
             </tr>';
             // Fetch and display the records:
             while ($row = mysqli_fetch_array($result, MYSQLI_ASSOC)) {
             // Remove special characters that might already be in table to
                       // reduce the chance of XSS exploits
                       $user_id = htmlspecialchars($row['userid'], ENT_QUOTES);
                       $last_name =
                               htmlspecialchars($row['last_name'], ENT_QUOTES);
                       $first_name =
                               htmlspecialchars($row['first_name'], ENT_QUOTES);
                       $email =
                               htmlspecialchars($row['email'], ENT_QUOTES);
                       $registration_date =
                               htmlspecialchars($row['regdat'], ENT_QUOTES);
                       echo '<tr>
                       <td><a href="edit_user.php?id=' . $user_id .
                       '">Edit</a></td>
                       <td><a href="delete_user.php?id=' . $user_id .
                               '">Delete</a></td>
                       <td>' . $last_name . '</td>
                       <td>' . $first_name . '</td>
                       <td>' . $email . '</td>
                       <td>' . $registration_date . '</td>
                       </tr>';
               }
               echo '</table>'; // Close the table.
               //
               mysqli_free_result ($result); // Free up the resources.
   } else { // If it did not run OK.
               // Public message:
echo '<p class="text-center">The current users could not be retrieved.';
               echo 'We apologize for any inconvenience.</p>';
               // Debugging message:
       //echo '<p>' . mysqli_error($dbcon) . '<br><br>Query: ' . $q . '</p>';
               //Show $q is debug mode only
    }
// End of if ($result). Now display the total number of records/members.
          mysqli_close($dbcon); // Close the database connection.
    }
    catch(Exception $e)
    {
        print "The system is currently busy. Please try later.";
        //print "An Exception occurred. Message: " . $e->getMessage();
    }
    catch(Error $e)
    {
        print "The system us busy. Please try later.";
        //print "An Error occurred. Message: " . $e->getMessage();
    }
?>

Listing 4-5bThe Code for Displaying the Search Results (process_view_found_record.php)

```

### 代码的解释

本节解释代码。

```php
//                                                                            #1
$first_name = htmlspecialchars($_POST['first_name'], ENT_QUOTES);
$last_name = htmlspecialchars($_POST['last_name'], ENT_QUOTES);
// Since it's a prepared statement below this sanitizing is not needed
// However, to consistently retrieve than sanitize is a good habit

```

我们应该始终保持对从当前程序之外接收的数据进行净化的流程。可以删除前面的两个语句，但数据仍然不会执行，因为语句已经准备好了。但是如果我们总是记住“输入然后净化”，我们正在创建一个更安全的程序。

```php
//                                                                            #2
$query = "SELECT last_name, first_name, email, ";
$query .= "DATE_FORMAT(registration_date, '%M %d, %Y')";
$query .=" AS regdat, userid FROM users WHERE ";
$query .= "last_name=? AND first_name=? ";
$query .="ORDER BY registration_date ASC ";
$q = mysqli_stmt_init($dbcon);
mysqli_stmt_prepare($q, $query);

// bind values to SQL Statement
mysqli_stmt_bind_param($q, 'ss', $last_name, $first_name);

// execute query
mysqli_stmt_execute($q);

$result = mysqli_stmt_get_result($q);
if ($result) { // If it ran, display the records.

```

该查询已被调整为接受姓氏和名字来搜索匹配记录。由于该信息是从用户处接收的，因此已经创建了一个*准备好的语句*。使用这种格式，用户输入的任何值都无法执行。用户不能试图使用 *SQL 注入*访问不应该访问的信息。

SQL 语句包括两个问号。第一个问号绑定到$last_name 中的值。第二个问号绑定到$first_name。该语句要求每个都是一个字符串(ss)。然后执行查询，结果放在$result 中。

最后，您可以测试搜索工具。运行 XAMPP 或 easyPHP，并在浏览器的地址栏中键入以下内容:

**http://localhost/admin table/log in . PHP**

使用管理员的电子邮件地址和密码登录。电子邮件是 jsmith@outlook.com，密码是 d0gsb0dy。然后单击标题菜单上的搜索按钮。在搜索表单中，尝试输入**杰克·史密斯**来查看显示的单个记录。

结果应该是如图 [4-7](#Fig7) 所示的记录。

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig7_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig7_HTML.jpg)

图 4-7

显示使用搜索页面选择的单个记录

尝试输入**詹姆斯·史密斯**来查看一组具有相同姓氏和名字的记录。

现在我们已经到了可以演示管理员如何删除和编辑记录的阶段。

## 编辑记录

当管理员单击显示的记录上的编辑链接时，将显示 *edit_user.php* 页面。该页面显示数据库表中当前保存的字段和数据。如图 [4-8](#Fig8) 所示。

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig8_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig8_HTML.jpg)

图 4-8

显示现有数据的编辑用户屏幕

管理员可以修改详细信息，然后单击“编辑”按钮完成编辑过程。

清单 [4-6](#PC32) 显示了 *process_edit_record.php* 的 PHP 代码。 *edit_user.php* 文件包含与前面所示相同的 HTML 格式。您可以从下载的文件中查看这段代码。

```php
<?php
    try
    {
         // After clicking the Edit link in the found_record.php page. // This code is executed                                                      #1
         // The code looks for a valid user ID, either through GET or POST:
         if ( (isset($_GET['id'])) && (is_numeric($_GET['id'])) ) {
         // From view_users.php
                  $id = htmlspecialchars($_GET['id'], ENT_QUOTES);
         } elseif ( (isset($_POST['id'])) && (is_numeric($_POST['id'])) ) {
         // Form submission.
                 $id = htmlspecialchars($_POST['id'], ENT_QUOTES);
         } else { // No valid ID, kill the script.
      echo '<p class="text-center">This page has been accessed in error.</p>';
                 include ('footer.php');
                 exit();
         }
     require ('./mysqli_connect.php');
     // Has the form been submitted?
     if ($_SERVER['REQUEST_METHOD'] == 'POST') {
           $errors = array();
           // Look for the first name:                                                  #2
           $first_name =
                    filter_var( $_POST['first_name'], FILTER_SANITIZE_STRING);
           if (empty($first_name)) {
                    $errors[] = 'You forgot to enter your first name.';
           }
           // Look for the last name:
           $last_name = filter_var( $_POST['last_name'], FILTER_SANITIZE_STRING);
           if (empty($last_name)) {
                     $errors[] = 'You forgot to enter your last name.';
           }
           // Look for the email address:
           $email = filter_var( $_POST['email'], FILTER_SANITIZE_EMAIL);
           if  ((empty($email)) || (!filter_var($email, FILTER_VALIDATE_EMAIL))) {
                     $errors[] = 'You forgot to enter your email address';
                     $errors[] = ' or the e-mail format is incorrect.';
           }
           if (empty($errors)) { // If everything's OK.                                 #3
                   $q = mysqli_stmt_init($dbcon);
                   $query = 'SELECT userid FROM users WHERE email=? AND userid !=?';
                   mysqli_stmt_prepare($q, $query);
                   // bind $id to SQL Statement
                   mysqli_stmt_bind_param($q, 'si', $email, $id);
                   // execute query
                   mysqli_stmt_execute($q);
                   $result = mysqli_stmt_get_result($q);

                   if (mysqli_num_rows($result) == 0) {
                   // e-mail does not exist in another record                           #4
                   $query = 'UPDATE users SET first_name=?, last_name=?, email=?';
                           $query .= ' WHERE userid=? LIMIT 1';
                           $q = mysqli_stmt_init($dbcon);
                           mysqli_stmt_prepare($q, $query);
                           // bind values to SQL Statement
mysqli_stmt_bind_param($q, 'sssi', $first_name, $last_name, $email, $id);
                           // execute query
                           mysqli_stmt_execute($q);
                           if (mysqli_stmt_affected_rows($q) == 1) { // Update OK
                                     // Echo a message if the edit was satisfactory:
                   echo '<h3 class="text-center">The user has been edited.</h3>';
                           } else { // Echo a message if the query failed.
           echo '<p class="text-center">The user could not be edited due ';
           echo 'to a system error.';
           echo ' We apologize for any inconvenience.</p>'; // Public message.
           //echo '<p>' . mysqli_error($dbcon) . '<br />Query: ' . $q . '</p>';
           // Debugging message.
           // Message above is only for debug and should not display SQL in live //mode
                           }
                  } else { // Already registered.
                  echo '<p class="text-center">The email address has ';
                  echo 'already been registered.</p>';
                  }
           } else { // Display the errors.
           echo '<p class="text-center">The following error(s) occurred:<br />';
                    foreach ($errors as $msg) { // Echo each error.
                             echo " - $msg<br />\n";
                  }
                  echo '</p><p>Please try again.</p>';
           } // End of if (empty($errors))section.
      } // End of the conditionals
      // Select the user's information to display in textboxes:                         #5
      $q = mysqli_stmt_init($dbcon);
      $query = "SELECT first_name, last_name, email FROM users WHERE userid=?";
      mysqli_stmt_prepare($q, $query);
      // bind $id to SQL Statement
      mysqli_stmt_bind_param($q, 'i', $id);
      // execute query
      mysqli_stmt_execute($q);
      $result = mysqli_stmt_get_result($q);
      $row = mysqli_fetch_array($result, MYSQLI_NUM);

      if (mysqli_num_rows($result) == 1) { // Valid user ID, display the form.
           // Get the user's information:
           // Create the form:
?>
<h2 class="h2 text-center">Edit Record</h2>
<form action="edit_record.php" method="post"
        name="editform" id="editform">
<div class="form-group row">
        <label for="first_name" class="col-sm-4 col-form-label">
                 First Name:</label>
<div class="col-sm-8">
     <input type="text" class="form-control" id="first_name" name="first_name"
         placeholder="First Name" maxlength="30" required
         value="<?php echo htmlspecialchars($row[0], ENT_QUOTES); ?>" >
</div>
</div>
<div class="form-group row">
         <label for="last_name" class="col-sm-4 col-form-label">
                   Last Name:</label>
<div class="col-sm-8">
     <input type="text" class="form-control" id="last_name" name="last_name"
         placeholder="Last Name" maxlength="40" required
         value="<?php echo htmlspecialchars($row[1], ENT_QUOTES); ?>">
</div>
</div>
<div class="form-group row">
         <label for="email" class="col-sm-4 col-form-label">E-mail:</label>
<div class="col-sm-8">
    <input type="email" class="form-control" id="email" name="email"
         placeholder="E-mail" maxlength="60" required
         value="<?php echo htmlspecialchars($row[2], ENT_QUOTES); ?>">
</div>
</div>
    <input type="hidden" name="id" value=" <?php echo $id  ?>" />               <!-- #6 -->
<div class="form-group row">
          <label for="" class="col-sm-4 col-form-label"></label>
<div class="col-sm-8">
          <input id="submit" class="btn btn-primary" type="submit" name="submit" value="Register">
</div>
</div>
</form>
<?php
    } else { // The user could not be validated
echo '<p class="text-center">This page has been accessed in error.</p>';
    }
    mysqli_stmt_free_result($q);
    mysqli_close($dbcon);
    }
    catch(Exception $e)
    {
      print "The system is busy. Please try later";
        //print "An Exception occurred. Message: " . $e->getMessage();
    }
    catch(Error $e)
    {
        print "The system is currently buys. Please try later";
        //print "An Error occurred. Message: " . $e->getMessage();
    }
?>

Listing 4-6Creating the Editing Interface

(process_edit_record.php)

```

### 代码的解释

大部分代码已经被解释了，但是我们现在将检查一些本章中新的代码。

```php
// After clicking the Edit link in the found_record.php page.
//This code is executed                                                            #1
// The code looks for a valid user ID, either through GET or POST:

if ( (isset($_GET['id'])) && (is_numeric($_GET['id'])) ) {
// From view_users.php

         $id = htmlspecialchars($_GET['id'], ENT_QUOTES);

} elseif ( (isset($_POST['id'])) && (is_numeric($_POST['id'])) ) {
// Form submission.

         $id = htmlspecialchars($_POST['id'], ENT_QUOTES);

} else { // No valid ID, kill the script.

echo '<p class="text-center">This page has been accessed in error.</p>';
         include ('footer.php');
         exit();

}

```

我们必须确保我们正在编辑正确的记录，这是通过检查所选用户的 ID 来实现的。如果用户的详细信息输入不正确，或者数据库表中不存在该用户，则会显示一条错误消息。请注意 is_numeric()函数，它确保 ID 是一个数字而不是一个字符串。如果 ID 是数字，它将被清理并赋给变量$id，为下一步做好准备。消毒是不需要的，因为我们将使用一个准备好的声明。然而，我们希望保持一致并净化所有输入。

注意:收到的号码可能仍然无效；例如，有人可能试图跳过搜索表单，向程序传递一个数字。但是，一旦搜索完成，如果没有找到该号码，将显示一条错误消息。

```php
// Look for the first name:                                                            #2
    $first_name = filter_var( $_POST['first_name'], FILTER_SANITIZE_STRING);
    if (empty($first_name)) {
              $errors[] = 'You forgot to enter your first name.';
    }

```

表单中的每个条目都经过了清理。如果用户没有为名字输入值，错误消息将存储在错误数组中。这与我们在注册程序中使用的代码相同。

```php
if (empty($errors)) { // If everything's OK.                                            #3
             $q = mysqli_stmt_init($dbcon);
             $query = 'SELECT userid FROM users WHERE email=? AND userid !=?';
             mysqli_stmt_prepare($q, $query);
             // bind $id to SQL Statement
             mysqli_stmt_bind_param($q, 'si', $email, $id);
             // execute query
              mysqli_stmt_execute($q);
             $result = mysqli_stmt_get_result($q);

             if (mysqli_num_rows($result) == 0) {
// e-mail does not exist in another record

```

如果没有验证错误，请确定新电子邮件是否在数据库中，以及是否与不同的用户 ID 相关。如果它与不同的 ID 无关，我们就可以更新记录。

```php
// e-mail does not exist in another record                                             #4
       $query = 'UPDATE users SET first_name=?, last_name=?, email=?';
                $query .= ' WHERE userid=? LIMIT 1';

                $q = mysqli_stmt_init($dbcon);
                mysqli_stmt_prepare($q, $query);

                // bind values to SQL Statement
mysqli_stmt_bind_param($q, 'sssi', $first_name, $last_name, $email, $id);

                // execute query
                mysqli_stmt_execute($q);

                if (mysqli_stmt_affected_rows($q) == 1) { // Update OK
                // Echo a message if the edit was satisfactory:
                echo '<h3 class="text-center">The user has been edited.</h3>';

```

如果错误数组不包含错误消息，并且电子邮件与另一条记录没有关联，则查询将运行。使用关键字 UPDATE，该查询更新 users 表中具有正确用户 ID 的记录。将关键字 LIMIT 与 1 一起使用可以确保只更新一条记录。成功完成后，会向用户显示一条消息。

```php
    // Select the user's information to display in textboxes:                          #5
    $q = mysqli_stmt_init($dbcon);

    $query = "SELECT first_name, last_name, email FROM users WHERE userid=?";

    mysqli_stmt_prepare($q, $query);

    // bind $id to SQL Statement
    mysqli_stmt_bind_param($q, 'i', $id);

    // execute query
    mysqli_stmt_execute($q);
    $result = mysqli_stmt_get_result($q);
    $row = mysqli_fetch_array($result, MYSQLI_NUM);

    if (mysqli_num_rows($result) == 1) { // Valid user ID, display the form.
         // Get the user's information:
         // Create the form:
?>
<h2 class="h2 text-center">Edit Record</h2>
<form action="edit_record.php" method="post"
        name="editform" id="editform">
<div class="form-group row">
        <label for="first_name" class="col-sm-4 col-form-label">First Name:</label>
<div class="col-sm-8">
     <input type="text" class="form-control" id="first_name" name="first_name"
         placeholder="First Name" maxlength="30" required
         value="<?php echo htmlspecialchars($row[0], ENT_QUOTES); ?>" >
</div>
</div>

```

从 *admin_view_users.php* 页面传递的用户 ID 用于从 users 表中提取用户信息以显示在表单中。将显示包含所选用户数据的表单。然后，用户可以编辑表单上显示的任何信息，并单击 submit 按钮将更改返回到数据库的表中。

```php
<input type="hidden" name="id" value=" <?php echo $id  ?>" />                <!-- #6 -->

```

隐藏的输入值(id)确保表单中不显示用户 ID 的字段，除非已经从 *admin_view_users.php* 页面(通过 GET)或从 *edit_user.php* (通过 POST)传递了 ID。

### 删除记录

如果管理员删除了错误的记录，则删除无法撤消；因此，程序将向管理员确认是否应该删除该记录。当管理员在显示的记录上单击删除链接时，会显示 *delete_user.php* 页面。删除记录屏幕显示管理员要删除的人员的姓名。然后管理员可以点击是按钮或否按钮，如图 [4-9](#Fig9) 所示。

![../images/314857_2_En_4_Chapter/314857_2_En_4_Fig9_HTML.jpg](../images/314857_2_En_4_Chapter/314857_2_En_4_Fig9_HTML.jpg)

图 4-9

删除记录的屏幕

该页面显示要删除的成员的名称，并让管理员有机会验证是否删除了正确的记录。在我们描述删除页面的列表之前，表 [4-6](#Tab6) 中建议了几个名字。注册它们，以便您可以尝试删除它们。

表 4-6

有些名字你可以注册，然后尝试删除

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

西方人名的第一个字

 | 

姓

 | 

电子邮件

 | 

密码

 |
| --- | --- | --- | --- |
| 菲利斯 | 齿 | ptine@myisp.co.uk | vug @ R1 @ n |
| 是吗 | 斜面 | dcant@myisp.com | P0lyph0n1c# |
| 账单 | 板 | bboard@myisp.net | -= ytet-伊甸园字幕组=-翻译:粒粒粒尘紫月猫姐 scenery 校对:阿衡时间轴:邦德猪 |
| 伊娃 | 腾讯 | enescent @ myisp.de | Fl@@t1ng |

在下一步中，我们将为管理员创建一个页面，以便可以安全地删除记录。HTML 代码类似于前面的代码。可以从下载的文件中查看。清单 [4-7](#PC39) 显示了 PHP 代码。

```php
<?php
try {
// Check for a valid user ID, through GET or POST:                                #1
if ( (isset($_GET['id'])) && (is_numeric($_GET['id'])) ) {
// From view_users.php
     $id = htmlspecialchars($_GET['id'], ENT_QUOTES);
} else
     if ( (isset($_POST['id'])) && (is_numeric($_POST['id'])) ) {
     // Form submission.
             $id = htmlspecialchars($_POST['id'], ENT_QUOTES);
     } else { // No valid ID, kill the script.
              // return to login page
              header("Location: login.php");
              exit();
              }
     require ('./mysqli_connect.php');
     // Check if the form has been submitted:                                           #2
     if ($_SERVER['REQUEST_METHOD'] == 'POST') {
              $sure = htmlspecialchars($_POST['sure'], ENT_QUOTES);
              if ($sure == 'Yes') { // Delete the record.
              // Make the query:
              // Use prepare statement to remove security problems
              $q = mysqli_stmt_init($dbcon);
     mysqli_stmt_prepare($q, 'DELETE FROM users WHERE userid=? LIMIT 1');

              // bind $id to SQL Statement
              mysqli_stmt_bind_param($q, "s", $id);

              // execute query
              mysqli_stmt_execute($q);

              if (mysqli_stmt_affected_rows($q) == 1) { // It ran OK
              // Print a message:
              echo '<h3 class="text-center">The record has been deleted.</h3>';
              } else { // If the query did not run OK display public message

              echo '<p class="text-center">The record could not be deleted.';
       echo '<br>Either it does not exist or due to a system error.</p>';
       // echo '<p>' . mysqli_error($dbcon ) . '<br />Query: ' . $q . '</p>';
       // Debugging message. When live comment out because this displays SQL

              }
       } else { // User did not confirm deletion.
     echo '<h3 class="text-center">The user has NOT been deleted as ';
     echo 'you requested</h3>';
       }
  } else { // Show the form.                                                            #3
       $q = mysqli_stmt_init($dbcon);
       $query = "SELECT CONCAT(first_name, ' ', last_name) FROM ";
       $query .= "users WHERE userid=?";
       mysqli_stmt_prepare($q, $query);

       // bind $id to SQL Statement
       mysqli_stmt_bind_param($q, "s", $id);

       // execute query
       mysqli_stmt_execute($q);

       $result = mysqli_stmt_get_result($q);

       $row = mysqli_fetch_array($result, MYSQLI_NUM); // get user info

       if (mysqli_num_rows($result) == 1) {
       // Valid user ID, display the form.

       // Display the record being deleted:                                             #4
                $user = htmlspecialchars($row[0], ENT_QUOTES);
?>
<h2 class="h2 text-center">
Are you sure you want to permanently delete

<?php echo $user; ?>?</h2>
<form action="delete_user.php" method="post"
        name="deleteform" id="deleteform">
<div class="form-group row">
        <label for="" class="col-sm-4 col-form-label"></label>
<div class="col-sm-8" style="padding-left: 70px;">
        <input type="hidden" name="id" value="<?php echo $id; ?>">
        <input id="submit-yes" class="btn btn-primary" type="submit" name="sure" value="Yes"> -
        <input id="submit-no" class="btn btn-primary" type="submit" name="sure" value="No">
</div>
</div>
</form>
<?php
    } else { // Not a valid user ID.
    echo '<p class="text-center">This page has been accessed in error.</p>';
       }
    } // End of the main submission conditional.
         mysqli_stmt_close($q);
         mysqli_close($dbcon );
    }
    catch(Exception $e)
    {
        print "The system is busy. Please try again.";
        //print "An Exception occurred. Message: " . $e->getMessage();
    }
    catch(Error $e)
    {
        print "The system is currently busy. Please try again soon.";
        //print "An Error occurred. Message: " . $e->getMessage();
    }
?>

Listing 4-7Creating a Page

for Deleting Records (process_delete_record.php)

```

### 代码的解释

本节解释代码。

```php
// Check for a valid user ID, through GET or POST:                                    #1
if ( (isset($_GET['id'])) && (is_numeric($_GET['id'])) ) {
// From view_users.php

    $id = htmlspecialchars($_GET['id'], ENT_QUOTES);

} else
    if ( (isset($_POST['id'])) && (is_numeric($_POST['id'])) ) {
    // Form submission.

            $id = htmlspecialchars($_POST['id'], ENT_QUOTES);

    } else { // No valid ID, kill the script.
             // return to login page

             header("Location: login.php");
             exit();

             }

```

如果 ID 没有通过，就不要继续；转到登录页面。

```php
// Check if the form has been submitted:                                              #2
if ($_SERVER['REQUEST_METHOD'] == 'POST') {

         $sure = htmlspecialchars($_POST['sure'], ENT_QUOTES);

         if ($sure == 'Yes') { // Delete the record.
         // Make the query:
         // Use prepare statement to remove security problems

         $q = mysqli_stmt_init($dbcon);
mysqli_stmt_prepare($q, 'DELETE FROM users WHERE userid=? LIMIT 1');

// bind $id to SQL Statement
mysqli_stmt_bind_param($q, "s", $id);

// execute query
         mysqli_stmt_execute($q);

         if (mysqli_stmt_affected_rows($q) == 1) { // It ran OK
         // Print a message:

         echo '<h3 class="text-center">The record has been deleted.</h3>';

```

进行检查以查看是否已经点击了“是”按钮。如果有，则运行删除记录的 SQL 代码；如果成功，将显示一条消息。

```php
} else { // Show the form.                                                             #3
        $q = mysqli_stmt_init($dbcon);
        $query =
"SELECT CONCAT(first_name, ' ', last_name) FROM users WHERE userid=?";

    mysqli_stmt_prepare($q, $query);

    // bind $id to SQL Statement
    mysqli_stmt_bind_param($q, "s", $id);

    // execute query
    mysqli_stmt_execute($q);

    $result = mysqli_stmt_get_result($q);

    $row = mysqli_fetch_array($result, MYSQLI_NUM); // get user info

    if (mysqli_num_rows($result) == 1) {
    // Valid user ID, display the form.

```

此代码格式化要显示的选定名称:

```php
// Display the record being deleted:                                                   #4
           $user = htmlspecialchars($row[0], ENT_QUOTES);
?>
<h2 class="h2 text-center">
Are you sure you want to permanently delete <?php echo $user; ?>?</h2>

<form action="delete_user.php" method="post"
        name="deleteform" id="deleteform">
<div class="form-group row">
        <label for="" class="col-sm-4 col-form-label"></label>
<div class="col-sm-8" style="padding-left: 70px;">

        <input type="hidden" name="id" value="<?php echo $id; ?>">

        <input id="submit-yes" class="btn btn-primary" type="submit" name="sure" value="Yes">

        <input id="submit-no" class="btn btn-primary" type="submit" name="sure" value="No">
</div>
</div>
</form>';

```

将显示用户名以及“是”和“否”按钮。单击其中一个按钮的结果是将值 Yes 或 No 发送到前面编号为#2 的代码块。

### 注意

为了节省空间，只描述了需要修改的文件。本章的许多 PHP 文件没有被提及，因为它们与第 [3](03.html) 章中的文件相同。如果你还没有这样做，请从[下载第四章](http://apress.com)的完整文件。com 网站。使用 XAMPP 或 easyPHP 完成本章的例子，理解显示、编辑和删除成员的逻辑。

## 摘要

在本章中，您了解了如何创建一种用户友好的方法，允许管理员修改数据库的内容。这包括对整个成员表进行分页的能力。描述了一个搜索表单，该表单可用于选择特定成员，以便修改或删除他们的记录。提供了允许管理员编辑和删除记录的代码。通过净化所有输入(无论来源如何)以确保值不包含可执行代码，安全性得到了提高。我们将在接下来的几章中继续添加更多的安全特性。

在下一章中，我们将探索一个具有一些额外特性的数据库。例如，我们将包括用户的头衔和用户的邮政地址和电话号码。还将引入额外的验证和安全设备。