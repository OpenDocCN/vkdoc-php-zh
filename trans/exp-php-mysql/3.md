第三章

![image](images/frontdot.jpg)

平台和工具

如果你建造了空中楼阁，你的工作不一定会失败；那是他们应该在的地方。现在把地基放在它们下面。

—亨利·大卫·梭罗

如果城堡是需求，那么它们下面的基础就是实现它们的平台。该平台有四个主要部分:操作系统、web 服务器、数据库(MySQL)和语言编译器/解释器(PHP)。那在服务器上。因为这些是 web 应用程序，所以它们是从另一个平台访问的，客户端有两个主要部分:操作系统和浏览器。您在运行您的开发工具的第三方平台上进行开发。

在本章中，我将介绍所有三个平台，并讨论每个组件的各种选择。我还谈到了开发人员工具和将正在运行的应用程序更新到新版本的棘手工作。这构成了本书其余部分的基础，其余部分是关于开发应用程序本身的。

如您所见，我喜欢主流技术，平台和工具也是如此。它们要么已经安装，要么很容易安装，并得到书籍和网站的良好支持，几乎所有的错误都在咬我之前被压扁了。

客户端-服务器架构

图 3-1 显示了一个典型的 PHP/MySQL 客户端-服务器架构，以及用于构建和测试它的开发平台。

![9781430260073_Fig03-01.jpg](images/9781430260073_Fig03-01.jpg)

[图 3-1](#_Fig1) 。客户端-服务器-开发架构

服务器上涉及两个进程(或任务):数据库(对我们来说是 MySQL)和 web 服务器(通常是 Apache 或 Microsoft IIS)。PHP 处理器在 web 服务器的控制下运行，并执行组成应用程序的 PHP 文件。服务器框中的四个标签对应着所谓 LAMP 栈的元素:操作系统(Linux)、web 服务器(Apache)、数据库(MySQL)和语言(PHP)。正如我将要解释的，第一个不一定是 Linux，第二个不一定是 Apache。一般来说，最后两个不一定是 MySQL 和 PHP，但它们在本书中，因为这是我们的重点。

通常有许多应用程序在客户端运行，但是我们只关心连接到运行 PHP 应用程序的 web 服务器的浏览器。

因为您是开发人员，所以您也关心开发平台，它至少由两个基本的应用程序组成:一个可以创建和修改 PHP 文件的编辑器和一个可以将这些文件复制到 web 服务器的传输实用程序，通常是 FTP(文件传输协议)或 SFTP(安全文件传输协议)实用程序，有时内置于编辑器中。

在开发系统上复制整个服务器平台是很方便的，这样 PHP 文件就可以被编辑器直接访问，这样你就可以在本地运行应用程序。为此，有必要在开发计算机上安装一个服务器平台，然后在该计算机上打开一个浏览器与应用程序进行交互。[图 3-2](#Fig2) 说明了这一过程。当应用程序准备好部署时，一个 FTP 实用程序将 PHP 文件复制到远程服务器，如图[图 3-1](#Fig1) 所示。

![9781430260073_Fig03-02.jpg](images/9781430260073_Fig03-02.jpg)

[图 3-2](#_Fig2) 。具有本地服务器的开发系统

这是对正在发生的事情的高度概括。本章的其余部分是关于细节的。

服务器平台

当然，服务器平台运行在操作系统上，而在操作系统上运行着 web 服务器和数据库系统 MySQL。对我们来说，web 服务器是用 PHP 编程的，我将给出为什么这几乎总是我的选择，以及许多其他人的选择的原因。

灯组

“LAMP”是 Linux-Apache-MySQL-PHP 栈的一个聪明的术语，但严格来说它不是一个栈，因为，虽然 web 服务器肯定运行在操作系统下，PHP 运行在 web 服务器上，但数据库直接运行在操作系统上，独立于 web 服务器。(另外两种流行的语言也是以字母 P 开头的:PERL 和 Python，所以有时候 LAMP 中的 P 就是指其中的一种。)

我对术语“LAMP”还有另一个挑剔之处:在实践中，操作系统(OS)是什么形式的 UNIX 并没有太大的区别——就我作为应用程序开发人员而言，BSD 和 Solaris 的行为类似于 Linux，尽管在如何管理、购买和部署这些系统方面存在显著差异。Windows 也是一个常用的服务器操作系统，尽管这个选择会对你的应用程序有所影响。

最后，根据`w3techs.com`的数据，虽然 Apache 运行着超过 60%的网站，但剩下的 40%大部分被微软的 IIS 和 Nginx 瓜分。与操作系统一样，您的编码不会受到太大影响，但是与应用程序如何设置相关的一些问题会受到影响，我将对此进行解释。

我所有的例子都是针对类 UNIX 操作系统和 Apache 的，我会确保在关键的时候我清楚这一点。

所以，本质上，我们关心的是 LAMP 的 MP 部分，P 代表 PHP。本书中 99%的内容适用于任何运行 PHP/MySQL 的平台。

服务器操作系统

根据到`w3techs.com`的数据，65%的网站运行在某种形式的 UNIX 上，另外 35%运行在 Windows 上。外面真的没有别的东西了。(他们单独列出了 Mac OS，但就 PHP/MySQL 开发而言是 UNIX。)

我将各种 UNIX 变体称为 **nix* 系统。购买、支付、安装和管理操作系统是不同的，这取决于它实际上是何种形式的*nix。Linux、BSD、Solaris 和其他版本是不同的，甚至各种 Linux 发行版(Red Hat、Ubuntu、Debian 等)之间也有差异。).但是，从 PHP 程序来看，所有的*nix 系统都是一样的。你所要担心的是你是在其中一个上还是在 Windows 上。

*nix/Windows 在 PHP 级别上有四个不同之处。

1.  路径和文件名的差异。
2.  文本文件中不同的行尾。
3.  影响一些 PHP 函数的 API(应用程序接口)差异。它们在 PHP 文档中有明确的说明。
4.  从 PHP 程序或直接从 shell 或命令处理器执行的命令行。

主要路径和文件名的区别如下:

*   Windows 总是不区分大小写，但*nix 通常不是。为了确保你的程序在任一个上运行，总是要区分大小写。如果文件名是`login.php`，就不要用`Login.PHP`来指代。
*   在绝对路径中，您可能必须在 Windows 上使用驱动器号(例如，`D:/site/login.php`)。
*   在大多数 PHP 函数中，Windows 接受路径中的正斜杠，但是在用户交互提供的路径中或者当您从文件中读取路径时，您可能会得到一个反斜杠。每当我在 Windows 上输入路径时，我通常会将反斜杠转换成正斜杠。

原生 Windows 文本文件使用回车/换行符(`\r\n`)作为行尾，其中*nix 只使用一个换行符。然而，这两种格式在两种系统上都是通用的，所以这实际上不是一个*nix/Windows 问题；这是一个你需要一直关注的问题。

我在运行于 Mac OS (a *nix 系统)和 Windows 系统上的本地应用程序中处理了很多 Mac OS 和 Windows 系统的差异，但从未在我的 PHP/MySQL 应用程序中处理过，因为我设法避免在 Windows 服务器上运行。然而，你的生活可能没那么简单。

如果你从众多商业共享主机公司中的一家获得商业虚拟主机，他们几乎总是会使用 Linux 或 BSD，有时 Windows 是额外收费的选择。坚持使用更便宜的 Linux 或 BSD 主机。

网络服务器

尽管 Apache 也可以在 Windows 上运行，但在*nix 系统上，您几乎总是将 Apache 用作 web 服务器，在 Windows 系统上，您总是将 IIS 用作 web 服务器。

Apache 配置很难学，但是对 PHP/MySQL 程序员来说有两个好处。

*   除了偶尔编辑一个`.htaccess`文件来为一个目录建立选项之外，很少需要直接使用 Apache。
*   Apache 的应用如此广泛，以至于如果你在谷歌上搜索你正在处理的任何问题，你通常都会找到答案。你不会一个人受苦。

撇开可用性问题不谈，Apache 高效、可靠、廉价、文档完善且无处不在，因此它是我的首选 web 服务器，优势非常明显。

Apache 的主要接口是它所使用的文件系统。每个网站在服务器上都有一个*文档根目录*，你的 PHP 文件需要放在这个根目录下，或者它的子目录中。例如，在我的主网站`basepath.com`上，文档根目录是

```
/home/rochkind/public_html
```

如果我用 FTP 实用程序将文件`login.php`复制到那个目录，我可以通过请求 URL 从浏览器运行那个 PHP 程序。

```
http://basepath.com/login.php
```

我通常在我的网站上运行许多应用程序，所以我把它们放在文档根目录下的子目录中，然后通过域名后面的路径将用户定向到一个 URL。例如，我的站点 Classic Cameras 位于`/home/rochkind/public_html/ClassicCameras`，因此 URL 是`http://basepath.com/ClassicCameras`。(试试吧——这是一个真实的网站。)

我可以将 Apache 配置为将 URL `http://ClassicCameras.basepath.com`指向站点`/home/rochkind/public_html/ClassicCameras`，但是我通常不会这么做，因为链接总是出现在某个网页或电子邮件中，我的客户并不真正关心 URL 的外观。

如我所说，*nix 系统通常使用区分大小写的文件名，因此，虽然 URL 的域部分总是不区分大小写，但路径部分却不区分。所以，`http://basepath.com/classiccameras`是行不通的。如果这是一个问题，您也可以创建那个目录，这样您的网站上就有了大写和全小写的目录，然后用一个名为 index.php 的 PHP 文件将小写的目录重定向到真实的目录，如下所示:

```
<?php header('Location: http://basepath.com/ClassicCameras/ '); ?>
```

将`classiccameras`重定向到`ClassicCameras`的一种更优雅的方式是将 Apache 配置为在根目录下名为`.htaccess`的文件中放置一个重写规则，其中包含以下内容:

```
RewriteEngine on
RewriteRule ^classiccameras/?$ ClassicCameras/
```

这意味着，如果域名(`basepath.com`)后面的 URL 匹配`classiccameras`(可选地后跟一个斜杠)，它应该被替换为`ClassicCameras/`，这是一个区分大小写的名称。(在正则表达式符号中，`^`和`$`在开头和结尾锚定匹配，以防止只匹配用户键入的部分内容。)

总结这一节:有时您必须在某种程度上处理 Apache(或您的 web 服务器),但在大多数情况下，您可以不去管它，完全用 PHP 做您需要做的一切。

数据库系统

有许多用于 web 应用程序的 SQL 数据库系统，我使用过所有主要的系统，包括 Microsoft SQL Server、Oracle、IBM DB2、PostgreSQL，当然还有 MySQL。前三个是优秀的商业系统。PostgreSQL 是一个开源系统，其起源比 MySQL 早得多，但它的使用不如 MySQL 广泛，尽管许多托管公司提供它作为一个选项。

在过去，MySQL 支持如此有限的 SQL 形式，以至于对于被 Oracle 或 PostgreSQL 等更完整的系统宠坏的数据库专业人员来说，使用它很烦人。但是最近的版本改变了这一点，我现在发现它拥有我想要的一切，除了检查条件。我在第 4 章中对此进行了更深入的探讨。

我更喜欢 MySQL 的原因很简单，如果我只使用一套平台技术，我会觉得生活更容易，而且因为 MySQL 总是在那里，并且工作得非常好，它总是我的第一选择。我在这本书里说的关于数据库的很多内容也适用于其他书，但是我认为如果这本书只讨论一个数据库系统，它会更容易阅读，也更有用。我在前两章中提到过几次的 Rgrade 应用程序使用了 Oracle，这是一个很好的工具。它很贵，但是在我到那里之前，理查森学区已经标准化了。对理查森来说是好事。

Sun Microsystems 在 2008 年收购了 MySQL，大约两年后甲骨文收购了 Sun，所以现在，有点讽刺的是，甲骨文拥有 MySQL。尽管有人担心 Oracle 可能会忽视 MySQL 的开发和/或支持，以免影响 Oracle 的销售，但它并没有这样做，MySQL 仍然一如既往地可行。尽管如此，这种情况还是让人有些不安，所以 MySQL 的原始作者们采用了开源的 MySQL 代码，并开发了一个名为 MariaDB 的兼容系统，旨在与它实现二进制兼容。由于 MySQL 仍然是托管公司和云服务器最广泛支持的版本，所以我用的是这个版本。

尽你所能确保你使用的至少是 MySQL 5.5 版本，因为这是我在本书中假设你拥有的版本。这是 MySQL 在 2013 年年中撰写本文时的状态。当然很快就要上 5.6 了，以此类推。如果您的应用程序是新的，从最新的稳定版本开始。

非常高性能的网站不会向数据库发送 SQL 查询，因为这需要太多的处理时间，并且很难缓存结果以供其他查询重用。他们使用所谓的 NoSQL 数据库，如 MongoDB 或 CouchDB。使用它们超出了本书的范围，所以我不会深入讨论它们。对于普通的 web 应用程序，您希望使用 SQL。MySQL 的性能将绰绰有余。

服务器编程语言

几年前，在一次联邦法庭诉讼中，我作为一名技术专家被免职，当时有人问我使用过什么编程语言。我想我一定有超过 30 个名字，因为我从 1967 年就开始编程了。我已经使用了所有主要的工具，以及许多外来的工具，比如 APL、Algol、B(C 的前身)、LISP、Lua、PL/I、Scratch 和 SNOBOL4。我用大多数流行的网站语言编程，比如 Java、PERL 和 Python。

那么，为什么是 PHP 呢？毫无疑问，它远不如 Java、Python 或 Ruby 优雅。在每个变量名前使用一个`$`是荒谬的。函数名乱七八糟。我想自从我开始使用这种语言以来，他们已经改变了推荐的 MySQL 函数至少三四次。(我将在本书中使用 PDO。)语言本身还可以，但是做同样事情的方式太多，显得臃肿。

好吧，这就是不好的地方。这是好东西。

*   PHP 一直都在。我从来没有发现一个托管公司不提供它。Java 有时是额外付费的选择，如果它可用的话，而 Python 和 Ruby 通常是不可用的。PERL 和 PHP 一样普遍，但它是一种更糟糕的语言。
*   它很快。它被广泛使用，因此有很多优化，尤其是在与 Apache 一起使用时。
*   它有一个非凡的扩展集合，允许它处理几乎任何 web 应用程序。
*   每个网络服务(亚马逊、脸书、Flickr 等。)有一个 PHP 接口。如果不支持 PHP，他们知道他们的支持是不完整的。相比之下，他们可以忽略 Python 和 Ruby。
*   PHP 社区是所有编程语言中最大的，这意味着有书(像这本！)、培训课程、论坛，以及像`stackoverflow.com`(我的最爱)这样的支持网站上的无数帖子。

基于这些原因，`w3techs.com`报告称，PHP 在几乎 80%的网站上使用。(.NET 是 20%，Java 是 4%；有些网站使用多种语言。)

所以，既然我可以并且已经使用了几乎所有存在过的语言，那么 PHP 的答案是，它使用起来足够愉快，总是可用，非常好的支持，并且几乎总是有一个函数来做需要做的事情。我喜欢把事情做完。

你还将使用另外三种语言，因为 web 应用程序开发人员总是使用至少四种语言。另外三个是

*   HTML(包括 CSS)，
*   JavaScript，以及
*   SQL，与数据库对话。

HTML 和 JavaScript 在浏览器中运行；从不在服务器上。SQL 从你的 PHP 程序传递到数据库，或者有时直接在数据库上使用，所以它是一种服务器语言。

客户端平台

您对服务器有一定的控制权，甚至可能是完全的控制权，但对客户端却没有。也许对于内部网站来说是这样，但是，即使这样，员工还是会在家或在路上访问您的应用程序。IT(信息技术)力量可以让它成为他们所希望的 Windows 商店，但他们不可能将 iPhones 和 iPads 拒之门外。您可能希望通过只支持有限数量的客户端平台来使事情变得简单，但是您不能。

客户端操作系统

幸运的是，作为应用程序开发人员，您并不关心客户端操作系统。自然，它对大多数用户来说都很重要，至少在他们选择电脑的时候是如此:Mac、Android 或 iOS 手机或平板电脑、Windows 电脑、ChromeBook 等等。但是，除了客户端路径名看起来像什么之外，实际上没有任何操作系统特定的东西影响浏览器与 PHP 应用程序的交互，甚至那些路径名也很少传递给 web 应用程序，因为 web 应用程序对它们无能为力。

因此，所有的客户端兼容性问题都将与浏览器相关。

浏览器

真是一团糟！有五种广泛使用的浏览器:Chrome、Internet Explorer、Firefox、Safari 和 Opera，按受欢迎程度排列。这仍将约 10%的市场留给了其他公司。此外，还有多个版本在使用。当浏览器已经安装在操作系统上时，如 Internet Explorer (Windows)或 Safari (Mac OS)，使用的版本很可能与计算机一样旧，因为许多用户从未升级他们的操作系统，甚至不知道浏览器是一个独立的应用程序。不厌其烦地安装浏览器(Chrome、Firefox 或 Opera)的人更有可能不时地更新它。

Opera 的使用份额只有 2%,所以如果你想的话，你可以只支持四种浏览器。

处理浏览器变体

因为浏览器中使用的 HTML 和 JavaScript 在最近几年发展如此之快，浏览器即使是一两个旧版本的行为也可能与新版本大相径庭。考虑到广泛使用的大多数浏览器可能有三到四个版本，如果你想确保你的应用程序为 90%的用户工作，你将有大约 20 种浏览器变体要处理。

有几种方法可以解决这个头疼的问题。

1.  坚持使用简单的 HTML 而不是 JavaScript。多年来，我在书桌旁放了一本非常旧的 HTML 3.2 参考书，并把自己局限于此。这在一段时间内是可以的，但是现在用户期望更复杂的网站，所以你必须使用最新的 HTML，否则你的网站会看起来很笨重。
2.  见鬼的 90%。限制您支持的浏览器和/或版本的数量。这对于您组织内部使用的内部应用程序或者用户很少的应用程序来说可能是可以的。
3.  忽略问题。当用户抱怨时，尝试修复 bug。如果你不能解决它，假装你从未听说过它。
4.  使用一种可以解决浏览器不兼容问题的技术，比如 jQuery。

第三种选择是最常见的，除非网站是真正的一流网站(例如，亚马逊、脸书和雅虎)。第四个是迄今为止最好的；这正是 jQuery 要解决的问题，而且它做得很好。

jQuery 的大部分使用将独立于 PHP 代码，因为它将用于没有混合 PHP 代码的页面的静态部分。尽管如此，它是应用程序的一部分，所以你有责任把它做好。

即使您使用 jQuery，也要小心声称支持您没有测试过的任何浏览器/版本组合。大多数网站和应用程序对此保持沉默，这可能就是原因。建立所有的测试环境并在网站发生变化时运行测试需要做大量的工作。(参见“获取用于测试的浏览器”一节)

一个简单的想法是，如果你的团队有几个成员，让每个人在开发过程中使用不同的浏览器，因为这是大多数错误被发现的时候。理想情况下，一个或多个用户正在使用 Windows，并且可以使用 Internet Explorer。Windows 也运行所有其他流行的浏览器，包括 Safari。除了 Internet Explorer，MAC 电脑运行所有的浏览器，而在流行的浏览器中，Linux 只运行 Chrome、Firefox 和 Opera。如果只是你，你可以试着在不同的日子运行不同的浏览器。

Chrome、Safari 和 Opera 使用相同的渲染引擎(HTML/JavaScript 处理器)WebKit，因此它们比任何一个都更兼容 Firefox 或 Internet Explorer，后者使用自己的渲染引擎。但是，即使共享渲染引擎的浏览器在其他方面也有所不同，所以您仍然必须在浏览器本身上进行测试。此外，Chrome 和 Opera 正在转向一个新的渲染引擎，Blink，这是从 WebKit 中分出来的，所以事情将开始出现更大的分歧。

如果您的测试资源有限，但您的应用程序是供公众使用的，因此必须在所有流行的浏览器上运行，您可能会像我一样，因为我通常处于这种情况:我使用运行在 Mac 上的 Chrome 进行开发，并经常使用 Safari 进行测试，Safari 也在那里。我在附近放了一台 Windows 电脑，这样我就可以用 Internet Explorer 进行测试，我把它保存在版本 8 中，假设微软会保持版本 9 和 10 与版本 8 的大部分兼容，它已经做到了。我从来不用 Firefox 或 Opera，或者其他版本的 Chrome、Safari 或 Windows 进行测试。这对我有用，因为我的网站在开发 HTML 和 JavaScript 的程度上相当谨慎，尽管我使用 CSS。但不要只是模仿我。您的应用程序是不同的，您的浏览器需求也是不同的。

在[第 2 章](2.html)中，我解释了在需求中限制浏览器选择的好处。现在你知道为什么了:需求中的任何东西都可能是客户验收测试的一部分，这意味着你也必须对它进行测试。最好少点，多点。

浏览器扩展

我在这里有这个部分，所以我可以说:不！！！没有 Flash，没有 SilverLight，没有 Air，没有 ActiveX，没有 Java。原因如下。

*   他们并不总是可用的。比如:iPads 和 iPhones 不运行 Flash。没有非 Windows 计算机运行 ActiveX。(不管怎么说，也不是没有很大的麻烦。)
*   用户将不会安装正确的扩展或版本，他们不会知道他们没有，你的应用程序将会失败。
*   它们使得用浏览器测试驱动程序(如 Selenium)进行测试变得非常复杂。
*   大多数扩展都存在安全问题。其他客户端技术也是如此，但是你处理的越少，你就越有可能堵住漏洞。
*   你不需要任何扩展。现代的 HTML 可以做过去只有通过扩展才能完成的事情，比如播放视频。

JavaScript 不是一个扩展；这是 HTML 的标准部分。(以防你不知道，JavaScript 和 Java 是完全不同的语言，在浏览器中扮演着完全不同的角色。)

请注意，我只是针对运行在浏览器中的客户端 Java 发出警告。客户端应用程序，如 NetBeans，我将在本章后面讨论，有时是用 Java 编写的，这完全没问题，与浏览器中的 Java 无关。服务器上的 Java 也无关，也 OK。只是作为浏览器插件，Java 是有问题的。

获取用于测试的浏览器

验证你的应用程序在特定的浏览器版本上工作的唯一可靠的方法是在那个版本上测试它。正如我提到的，这可能有很多版本，20 个或更多。因为大多数浏览器一次只允许安装一个版本，而且让大量的计算机在周围是不切实际的，所以有三种选择。

1.  打破常规，运行多个版本，即使供应商不支持它们。稍微在网上搜索一下，你会发现很多这样做的窍门。
2.  以正确的方式运行虚拟机。您可以在同一个虚拟机上运行不同的浏览器，只是不能运行同一个浏览器的不同版本(除非您执行#1)，因此您不需要为每个浏览器和版本运行单独的虚拟机。微软在`modern.ie`提供随时可用的虚拟机映像。(那是一个使用爱尔兰顶级域名的网址。聪明吧。)
3.  使用为您运行浏览器版本的浏览器测试服务。例如，`saucelabs.com`在 iOS、Android、Windows、Mac OS、Linux for Chrome、Internet Explorer、Firefox、Safari 和 Opera 上提供了超过 160 种设备/浏览器/版本组合。酱油实验室有一项免费服务，每月给你大约 200 分钟的测试时间。酱油实验室不是唯一的选择；这一行有很多行头。

如果你运行自己的虚拟机，你可以从`oldapps.com`获得所有旧版本的浏览器，或者，对于 Windows，从`modern.ie`获得。

另一种选择是使用内置于最新版本的 Internet Explorer 中的兼容模式，这种选择不如用实际的浏览器进行测试好。例如，版本 10 允许您使用模拟版本 7、8 和 9 的模式进行测试，在较小的程度上还可以模拟版本 5。(因为某些原因没有 6 版。)

客户端编程语言

您希望在从 PHP 应用程序发送到浏览器的代码中使用的语言是 HTML、CSS 和 JavaScript，它们是现代网站的标准。一些 JavaScript 将采取调用 jQuery 函数的形式，但那仍然是 JavaScript，而不是新语言。不要使用任何其他客户端语言。无论如何，如果你不使用任何浏览器扩展，你就做不到，我已经尽力让你远离了。

(我在前一章中使用了一点 Markdown，但那是在服务器上。在那个例子中，进入浏览器的是纯 HTML。)

如果你很小心并且做了大量的测试，你可以使用最新的 CSS 特性，同时仍然允许你的网站在旧的浏览器上正常运行。例如，我的网站`basepath.com`使用了圆角矩形和虚线，但是它们在一些浏览器上显示为普通矩形和实线。这仍然适用于我的设计，只是没那么漂亮了。CSS 通常都是这样，这也是为什么所有的样式都应该用 CSS 而不是 HTML 来完成的原因之一。

开发平台和工具

正如我所说的，最小的开发平台是一台运行文本编辑器、FTP 实用程序和浏览器的计算机。几乎任何一台计算机都足够了，因为这三种工具都是内置的。但是你不想要最小的。你整天都在你的开发平台上，所以你希望它比这好得多。

开发操作系统

如果你的开发操作系统就像你的生产服务器操作系统——或者都是*nix 或者都是 Windows——你最好能够在开发过程中找到操作系统的依赖关系(如果有的话)。此外，如果您的生产 web 服务器是 IIS，您将无法在您的开发系统上运行它，除非它是 Windows。(记住 Mac OS 是*nix 系统。)

然而，即使您的生产系统是*nix，让您的开发系统成为 Windows 也有一个好处:您可以使用 Internet Explorer 作为您的主要开发浏览器，这是我前面提到的优点，您也可以安装所有其他流行的浏览器。这可能比保持开发和生产操作系统不变更重要。

如果您的开发团队中有几个人，并且生产系统是*nix，那么让团队中的一些人使用 Windows 作为开发系统，而其他人使用*nix 是有意义的。如果生产系统是 Windows，每个人都可以使用 Windows，因为所有主要的浏览器都在 Windows 上运行。

这里有一个更简洁的建议:至少有一个开发者应该使用 Windows。如果生产 OS 是*nix，有些开发者应该也会用*nix。

如果只有你们一个人，那就更简单了:使用 Windows 进行开发。

当然，我非常清楚，如果你可以自由选择，如果你是为自己工作，你就会完全无视我的建议，选择你最喜欢的系统。我从未遇到过对此没有强烈意见的开发人员。我只是想说出利弊。我也不希望看到随着越来越多的开发者被 MAC 所吸引，Internet Explorer 被忽视，就像过去几年发生的那样。

对我来说，我做的不是很好:我在 Mac 上开发，只是打开 Windows 进行测试。

无论您选择什么，我在本节中讨论的所有开发工具都可以在 Windows、Mac OS 和 Linux 上运行，Apache 也是如此，所以这不会成为您决策的一个因素。

安装 Web 服务器、MySQL 和 PHP

正如我稍后详述的， 您可以选择一个已经安装了 web 服务器、MySQL 和 PHP 的生产托管服务，但是，对于开发，您可能必须自己安装它们。

Apache 和 PHP 是 MAC 自带的，但是，据我所知，PHP 已经过时了。你得自己下载安装 MySQL。(以前是 MAC 自带的，现在没有了。)你可以从`mamp.info`网站免费下载一个软件，然后把这三个软件安装在一起。(XAMPP 是另一个选择。)启动并运行之后，确保默认的 PHP 路径(`/usr/bin/php`)链接到 MAMP 路径，在终端中键入类似以下的命令(您的 MAMP 路径可能不同):

```
sudo mv /usr/bin/php /usr/bin/php-old
sudo ln /Applications/MAMP/bin/php/php5.4.10/bin/php /usr/bin/php
```

每次更新 Mac OS 时，不要忘记再次执行此操作。

Windows 自带 IIS，但没有 Apache、PHP 或 MySQL。我还没有找到一个相当于 MAMP 的 Windows 和 IIS 版本；我找到的那个有过期的部件。所以，这就是我们要做的。

1.  从控制面板上程序和功能小程序的“打开或关闭 Windows 功能”部分安装 IIS。
2.  按照 PHP 网站`php.net/manual/en/install.windows.php`上的说明安装 PHP for IIS。棘手的部分是让它与 IIS 一起工作，但这样做的说明是存在的。
3.  从`dev.mysql.com`安装 MySQL。MySQL 不用配置 IIS 或者 PHP 一旦安装并启动，您就可以连接到它。

如果你想在 Windows 上运行 Apache，你很幸运:在`wampserver.com`有一个比上面描述的 MAMP 更容易使用的 WAMP。它自动设置 Apache、PHP 和 MySQL，并提供一个任务栏通知图标来管理它们。(XAMPP 也有空。)

如果你的开发系统是 Linux，你就无所畏惧了，对吧？所以，你可以自己安装栈的 AMP 部分。谷歌“在 Linux 上安装 LAMP”获取说明。如果您愿意，可以用您的发行版替换“Linux”，如“在 Red Hat 上安装灯”

您可以验证 PHP 和 MySQL 正在使用清单 3-1 中显示的程序。

***[清单 3-1](#_list1)*** 。验证安装工作的程序

```
define('DB_HOST', 'localhost');
define('DB_PORT', '3306');
define('DB_USERNAME', 'root');
define('DB_PASSWORD', '...');
try {
    $dsn = 'mysql:host=' . DB_HOST . ';port=' . DB_PORT;
    new PDO($dsn, DB_USERNAME, DB_PASSWORD);
}
catch (PDOException $e) {
    die($e->getMessage());
}
echo "<p>PHP/MySQL is working!";
phpinfo();
```

这个程序实例化了一个新的连接到 MySQL 的 PDO 对象。如果程序运行，你有 PHP。如果创建了对象，您就拥有了 MySQL 并可以连接到它。如果实例化失败，PDO 类将抛出异常。

如果一切顺利，当你从浏览器访问这个 PHP 程序时，你将得到类似于图 3-3 的东西。

![9781430260073_Fig03-03.jpg](images/9781430260073_Fig03-03.jpg)

[图 3-3](#_Fig3) 。验证的输出

如果一切都不顺利，脚本将无法正确执行，这意味着以下情况之一是错误的:

*   web 服务器没有运行。
*   URL 是错误的，很可能是因为 PHP 文件没有正确地位于 web 服务器的文档根目录中。
*   PHP 没有安装在 web 服务器上。在这种情况下，您可能会看到您的 PHP 代码显示在浏览器中，就好像它是一个坏的 HTML。
*   您将看到一条 PHP 错误消息，因为脚本中有一个错误。
*   您将看到一条错误消息，因为您未能连接到 MySQL。

最后两个问题是值得考虑的，因为它们意味着至少 web 服务器和 PHP 是可以的。然后你只要追查一下为什么连不上 MySQL，大概是以下原因之一:

*   MySQL 服务器没有运行。
*   它不允许来自`localhost`的连接。这是不寻常的，但值得检查。
*   用户名和/或密码错误。安装过程中可能会要求您输入默认用户名 root 的密码。否则，密码可能为空(即根本不需要密码)。

随着开发栈的安装和运行——LAMP、MAMP、WAMP、WIMP、XAMPP 等等——你已经准备好设置你的开发工具了。

编辑器和 ide

多年来，我一直使用 IDE(集成开发环境)为 Windows 或 Mac OS (Visual Studio 或 Xcode)开发本地应用程序，但对于 PHP 开发来说只是一个文本编辑器，通常是 Mac OS 的 BBEdit。BBEdit 提供了 IDE 的许多功能，例如基于项目的组织(多个文件收集在一起)和语法突出显示，以及功能强大和设计良好的文本编辑。它没有代码完成(根据您输入的片段建议替代方案)、弹出文档、调试或单元测试。

所有这些缺失的特性和更多的特性都由 PHP 可用的 ide 提供，包括免费的和商业的。好像有两大:Eclipse 和 NetBeans。两者都是最初为 Java 开发的 ide，但是它们的架构足够灵活，可以适应 PHP(和其他语言)。

我发现 NetBeans 更容易设置，因为它提供了您需要的大部分东西，而使用 Eclipse，您必须安装一些插件才能开始。我还发现 NetBeans 更容易使用，尽管我确信一旦您了解 Eclipse，它也会变得容易。因此，虽然我将使用 NetBeans 来说明用 IDE 开发 PHP，但我并不推荐它胜过 Eclipse。我*是*说这比较容易上手。也有一些 PHP 的商业 ide 看起来很受欢迎，但是我还没有尝试过。您可以从`netbeans.org/features/php`下载已经为 PHP 配置的 NetBeans。

[图 3-4](#Fig4) 显示了在 NetBeans 中正在开发的[清单 3-1](#list1) 中的测试程序。

![9781430260073_Fig03-04.jpg](images/9781430260073_Fig03-04.jpg)

[图 3-4](#_Fig4) 。NetBeans 窗口

在本书中，我不打算详细解释如何使用 NetBeans 或任何其他 IDE，因为这类信息在网上很容易找到。

传输文件

你不必把 PHP 文件转移到任何地方，在开发平台上测试它们，这就是为什么你想在那里有一个 PHP/MySQL 栈。我在 web 服务器的文档根目录下开发。您永远不会在生产服务器上这样做，但是从任何地方都无法访问我的开发系统，甚至从我的本地网络也无法访问，所以我用最方便的方式使用它。

但是，您必须将文件传输到生产服务器，在那里对它们进行测试，并最终将它们提供给任何用户，也许是全世界的用户。为此，你通常会使用 FTP，这种文件传输协议甚至比网络还要古老，或者它更安全的替代品，SFTP。如果可以的话使用 SFTP，但是有些服务器不支持，所以对他们来说是 FTP。

如果您正在使用版本控制(参见“版本控制”一节)，请确保在上传到服务器之前提交更改，这样您就知道您正在使用应用程序的受控版本进行测试。

所有主要的操作系统都内置了 FTP。或者你可以使用一个免费的 FTP 工具，比如 FileZilla。如果你的文本编辑器有 FTP，你可以使用它。但是，如果您使用的是 NetBeans，它内置了 FTP 和 SFTP，这是一个不错的选择。(Eclipse 也有，但是，正如 Eclipse 经常出现的情况一样，您必须找到并安装一个插件。)

您可以从设置您的服务器的任何人那里获得您需要的 FTP 或 SFTP 参数—服务器名称、用户名、密码。(参见[图 3-5](#Fig5) 。)然后，在您使用的任何 FTP/SFTP 客户端(对我来说是 NetBeans)上将它们输入到远程连接设置中。

![9781430260073_Fig03-05.jpg](images/9781430260073_Fig03-05.jpg)

[图 3-5](#_Fig5) 。从主机提供商处收到的显示 FTP 凭据的电子邮件摘录

无论如何，要确保 FTP/SFTP 客户端足够智能，只传输发生变化的文件。有时这种聪明取决于文件修改时间，如果本地和远程时钟不同步，这可能会导致问题。使用内置 FTP/SFTP 的 IDE(如 NetBeans)的一个优点是，它知道文件是否发生了更改，而不必查询服务器来猜测。

当你需要更新一个新版本的网站时，你不希望在现有的基础上复制文件。我将在“安装新版本”一节中告诉您该怎么做

调试工具

如果您将 Xdebug 扩展安装到 PHP 中，您可以从 NetBeans 内部执行交互式调试，使用您所熟悉的所有功能，比如断点、单步执行、变量值显示等等。WampServer 是我用来在 Windows 上安装开发栈的，它附带了已经安装的 Xdebug。

测试工具

您肯定希望使用像 PHPUnit 这样的单元测试工具。它是几个可用的 PHP 单元测试工具之一，但它是我使用的工具，因为 NetBeans 直接支持它，这使得创建和运行单元测试非常容易。

另一个值得研究的工具是 Selenium，它可以运行驱动 web 浏览器的测试。这是针对整个系统的测试，因为它可以驱动整个应用程序。

版本控制

这里有一个有趣的事实:我发明了第一个源代码控制系统。我没开玩笑！20 世纪 70 年代初，在贝尔实验室的时候，我开发了源代码控制系统(SCCS)，，所有后续系统的先驱，包括 RCS、CVS、SourceSafe、Subversion、Git。你可以从`basepath.com/site/docs.php`下载我 1975 年在第一届 IEEE 软件工程会议上发表的论文。

当然，没人再用 SCCS 了。或者，几乎没有人——IBM 将它作为其 CMVC 系统的关键组件，也许在内部仍然如此。(当我在 2000 年代中期作为专家证人检查 IBM 源代码时，IBM 就是这样做的。)

今天流行的系统，至少在开源社区，似乎是 Subversion、Mercurial 和 Git。我相信它们都是不错的选择，这并不是说你不会在网上找到关于哪个更好的激烈争论。所有这些都由 NetBeans 直接支持，不需要插件，尽管您必须自己安装系统。

Mercurial 和 Git 是分布式系统，这意味着每个开发人员都有自己的存储库，当开发人员准备好这样做时，存储库就会与中央存储库同步。它们适合由几十个开发人员进行广泛分布的开发，对于像 Linux 这样的大型开源项目也是如此。(Git 是由 Linux 创建者 Linus Torvalds 创建的。)当您同步时，如果其他人已经更新了您尝试更新的存储库部分，您可能会发现不一致，在这种情况下，您必须在同步完成之前解决问题。

Subversion 有一个中央存储库，当您需要一个新文件或者需要签入您正在处理的文件的变更时，您可以随时访问它。对于小团队来说，这是一个很好的方法，因为每个人都知道最新的变化在哪里。对于大型团队来说，分布式系统可能更好。(我敢肯定，颠覆拥护者不会同意。)

比较版本控制系统让我头疼，所以在我真正开始之前我会停下来。使用你工作的地方已经存在的，或者，如果你是一个人，开始新的(或者准备抛弃你一直在使用的东西)，就使用 Mercurial。

或者 Git。

或者颠覆。

问题跟踪器

我在第一章的[中谈到了](1.html)问题跟踪器。你想要一个支持问题和客户支持(例如，跟踪电子邮件)，负担得起的(免费的肯定是)，并且有一个可以从 PHP 访问的数据库，我在第二章第的[清单 2-3](#list3) 中展示了一个例子。

NetBeans 提供了对 Bugzilla 和 JIRA 的内置支持，这两个我都没用过。

托管替代方案

到目前为止，我唯一深入讨论过的虚拟主机是你的开发系统。但是生产服务器才是真正重要的。

最重要的规则是，你不应该在自己的设备上托管自己的网站，除非你的名字是亚马逊、谷歌、苹果、脸书或其他同样大而富有的人。托管是一项专业的、高要求的、技术先进的活动，应该总是留给全职(在这种情况下意味着 24/7)的专业人员。您不想应对全天候的人员配备、不间断的电力、物理安全性、不间断可用性、异地备份和网络安全。所以你不用托管一个网站，你选择一个托管服务。

在许多情况下，您不会是选择的人，因为您正在构建的应用程序将在现有的托管平台上运行。我为理查森学区建立的成绩单系统 Rgrade 就是这种情况。该学区有自己的 IT 人员和自己的服务器机房，并且为我的应用程序添加了一些盒子。我从来没有见过那些电脑，我甚至不确定我见过它们所在的服务器机房。我可以通过 FTP 和终端访问它们，这正是我所需要的。尽管它们是由我的客户拥有和运营的，但就我而言，它们是在网络空间的某个地方，具体在哪里，我不知道也不关心。我为科罗拉多大学世界事务会议建立的系统也是如此。我很确定服务器就在校园的某个地方。

将托管服务分成几类是有帮助的。

*   真实机器上的内部托管，就像我刚刚提到的两个。有时这些会在不同的网站上为不同的用户共享(比如 CWA 系统)，有时则不会(比如 Rgrade)。
*   真实机器上的商业共享主机服务，从免费到每月 100 美元或更多，包括中间的几乎所有金额。我每个月为`basepath.com`支付大约 9 美元，包括无限存储和无限带宽。
*   云服务器上的虚拟机。例如亚马逊网络服务、微软 Azure 和 Rackspace Cloud。(IBM、谷歌和许多其他公司也这么做。)这被称为基础设施即服务(IaaS)。
*   云服务器上运行您定义的应用程序的应用程序平台，称为平台即服务(PaaS)。例子有亚马逊弹性豆茎和谷歌应用引擎。

在某些情况下，所有四个类别的主机服务为你设置了 PHP 和 MySQL。否则，您需要自己安装和设置 web 服务器、MySQL 和 PHP，就像您有自己的真实机器一样，这是您在获得虚拟机时通常要做的事情。这并不太坏，一旦你掌握了它，你就会有很大的灵活性。你永远不会因为获得最新版本的软件、添加用户或任何你想要的东西而受到你的主机服务的摆布。这是你的(虚拟)机器。

我将稍微讨论一下商业共享托管服务，然后报告我在一些云服务器上的体验，包括 IaaS 和 PaaS。

商业共享托管服务

你已经看过超级碗比赛期间那些令人发指的广告了。他们是最大的商业共享主机提供商，或者接近它。但 Go Daddy 只是数百家甚至数千家此类供应商中的一家。它们都提供一些计划，从免费到每月不到 5 美元甚至更多，取决于你有权期待的服务和容量。

我尝试的免费服务，只是为了好玩，是`freewebhostingarea.com`。反应似乎真的很慢，即使是我的玩具网站。出于某种原因，NetBeans 内部的 FTP 速度甚至更慢。一些 PHP 工具似乎受到了审查，比如`phpinfo`函数，它什么也不做。从我关于`phpinfo`不工作的电子邮件没有得到回复来看，客户支持似乎不存在。事情是这样的:即使是免费的，我也得到了 PHP 和 MySQL。你总是会得到 PHP 和 MySQL，这就是为什么它们是实现 web 应用程序的绝佳选择的一个原因。(然而，您并不总能获得您需要的特定特性；稍后会详细介绍。)

A2 主机，我已经用了`basepath.com`，是一个更严肃的服务，不像免费的网络主机。(如果你付钱给他们，他们也可能是认真的；我没有尝试去发现。)我的网站处理不了多少流量，但对于我所需要的，响应能力非常好，正常运行时间和客户支持也是如此。没有抱怨。我每月只付 9 美元！

我在 A2 主持工作了大约七年。之前，我曾被另一家公司托管，但我离开了那家公司，因为没有人会回复我的支持邮件。这是一个问题，当你做得很便宜的时候。

我用这些低价得到的服务叫做共享托管。我在一台有未知数量的其他客户的计算机上，当流量进来时，我们争夺资源。电脑就是电脑。无法扩展，没有负载平衡器，根本没有可扩展性。如果你自己的网站流量很大，这通常是你想要的，或者同一台电脑上的其他人的网站流量很大，事情就完了。对于`basepath.com`，无所谓。对于您的应用程序，可能是这样的。

共享主机总是限制你能做什么，这可能会阻止你的应用程序运行。例如，在[第 4 章](4.html)中，我将解释为什么数据库触发器是验证数据的好方法，但是，由于 MySQL 的设计方式，您需要“超级”权限来创建触发器，而这在共享主机中有时是不允许的。这是一个严重的限制。

A2 主机和大多数其他公司提供更高价格的计划，提供更多的资源。例如，每月大约 90 美元，你可以获得 16 个虚拟 CPU(中央处理器)和 SSD(固态硬盘)存储，保证容量远远超过我花区区 9 美元所能获得的。

托管可扩展性

有了 A2 托管或任何类似的提供商，即使每月 90 美元，你仍然有可用资源的上限。您想要的是从小规模开始并根据需要增长的服务。

扩展主机容量有两种方式: *up* 或 *out* 。向上扩展意味着获得更大的计算机，以更高的带宽连接到互联网。这就是当你告诉 A2 主机将你的网站转移到更高成本的服务时会发生的事情。你需要一段时间来决定你想这么做，A2 也需要几天时间来把你转移过去。与此同时，你的网站将会很慢，如果它能工作的话。然后，如果需求下降，你就要为超出需求的产能买单。

横向扩展意味着计算机的大小保持不变，但是您拥有更多的计算机。这对于 web 应用程序非常有用，因为除了连接到公共数据库之外，每个会话都是相互独立的。即使对于 Rgrade，该学区也购买了一台 Cisco 负载平衡器，它接收 HTTP 请求，并根据哪台应用服务器负载较轻，将请求分配给其中一台应用服务器。负载平衡器足够聪明，能够理解 PHP 会话，确保包含大量 HTTP 请求的给定会话保持在同一台服务器上。(重要的是，因为我将 PHP 设置为将会话数据存储在一个不在计算机之间共享的临时文件中。)负载平衡器不限于两台，因此我们可以通过添加应用服务器轻松扩展容量。几个月后，我们发现我们高估了所需的容量，It 人员将一台应用服务器转移到别处使用。这就是负载平衡器提供的灵活性。

数据库不容易在计算机之间分配。如果有必要的话，我们可以这样做，因为这是当时 Oracle 的一个特性，我们也在使用它。然而，这远没有添加负载平衡器那么简单。MySQL 根本不能很好地扩展到多台服务器，所以你必须自己考虑分割数据库，并在设计访问时考虑这种分割。

用户、组和权限

在开始设置虚拟服务器之前，我需要解释一下如何处理用户、组和权限。这适用于运行在*nix 系统上的 Apache 即 LA in LAMP。在这一节的最后，我会对 Apache 或 IIS 在 Windows 上的运行做一些评论。

首先，简要介绍一下*nix 上的用户、组和权限，以防您不熟悉。T2】

*   一个用户对应一个登录名。用户也被组织成组，通常只由一个用户组成，但也可能由几个用户组成。
*   每个进程都作为一个用户(通常是启动它的登录用户)和一个组(通常是该用户的组)运行。正是这个用户和组决定了进程是否有权限读取、写入或执行目录(文件夹)或文件。
*   执行文件意味着将它作为程序运行。执行目录意味着在路径中使用它。
*   每个目录和文件都有一个所有者用户和组。这些最初与创建目录或文件的过程相同，但是它们可以被改变。
*   每个目录和文件都有三种权限:用户、组和其他人。总共有九个权限。
*   八进制(以 8 为基数)数字用于表示目录或文件的权限。例如，权限 754 等于 9 位 111101100。一次考虑他们三个，所有者有 111，意思是读+写+执行，组有 101，意思是读+执行，其他人有 100，意思是读。
*   确定进程是否可以对目录或文件执行操作(读、写或执行)的算法如下:如果进程用户和目录/文件用户匹配，则使用用户位。如果它们不匹配，但组匹配，则使用组位。如果用户和组都不匹配，则使用其他位。

最初，当您第一次在一个*nix 系统上直接安装 Apache 时(例如，不是用 MAMP 这样的系统)，您可能会发现设置如下:

*   网站所在的文档根被设置为`/var/www`，并包含一个示例文件`index.html`。该目录和文件的用户和组被设置为 root 用户，只有 root 用户拥有对它们的写权限。(文档根和用户根是不相关的。)
*   Apache 和 PHP 使用设置为用户 www-data 的用户和组运行。Apache 和 PHP 不能写入文档根目录，但是它们可以读取它，所以如果作为 root 用户，您在那里建立一个网站，并授予其他人对目录和文件的读取权限，以及对目录的执行权限，Apache 和 PHP 就可以运行该网站。
*   当您使用 SFTP 登录以更新网站时，SFTP 进程的用户和组将被设置为您的登录名。对于 Ubuntu Linux 服务器，初始用户登录是 Ubuntu，这是一个不能写入文档根目录的用户和组，这使得 SFTP 无法使用。

因此，必须改变初始设置。有各种方法可以改变它，但是最简单的方法是更改 Apache 配置，将文档根目录设置为您登录的子目录，可能是一个名为`www`的目录，您应该在登录时创建它，如下所示:

```
mkdir www
```

这个文档根目录的完整路径类似于`/home/ubuntu/www`。它将拥有权限 775，这意味着您和您的组(最初只有您)可以读取、写入或执行它，而其他人只能读取和执行它。网站中的文件(HTML、PHP、CSS 或其他文件)应该具有权限 664，因为它们不需要被执行。(PHP 文件不是由*nix 系统执行的；它们只是被 PHP 处理器读取。)

现在，Apache 和 PHP 仍然作为 www-data 运行，但这没关系，因为你已经允许其他人访问网站，只是不写入它。因为你的登录(ubuntu 或者其他什么)拥有所有的目录和文件，SFTP 会工作得很好。

现在一切都很好，直到 PHP 需要写入一个目录，例如，当它想要创建一个 PDF 文件供下载时，它可能会这样做，正如我在[第 7 章](7.html)中演示的那样。由于 PHP 是作为组 www-data 运行的，允许它写入目录的最简单方法是将目录的组改为 www-data。例如，如果目录`installation`是由登录为 ubuntu 的 SFTP 创建的，那么它的用户和组就是 ubuntu，正如您从`ls`命令的输出中看到的。

```
drwxrwxr-x 5 ubuntu ubuntu 4096 Apr 26 14:17 installation
```

您可以使用以下命令更改该组:

```
sudo chgrp www-data installation
```

并且`ls`命令输出变为

```
drwxrwxr-x 5 ubuntu www-data 4096 Apr 26 14:17 installation
```

SFTP 现在可以写入目录，因为用户是 ubuntu，PHP 也可以，因为它的组是 www-data。

还有一个问题:在“安装新版本”一节中，PHP 将把文件复制到一个目录中，然后这些文件将拥有一个用户和一组 www-data，权限为 664，这意味着作为 ubuntu 运行的 SFTP 将无法更新它们。当然，您可以使用 SSH 终端登录并更改文件的用户和组，但是这太麻烦了。Web 应用程序应该自己运行，不需要终端人员的干预。

这个问题有几种解决方法。

*   对于许多共享主机服务，比如我在`basepath.com`中使用的那个，使用了一种叫做虚拟主机的东西，这样 Apache 和 PHP 就像作为我的用户和组(rochkind)运行一样。所有的目录和文件都归我所有，Apache 和 PHP 以我的身份运行，SFTP 以我的身份运行，所以一切都很好。
*   如果你控制了服务器，不管是真实的计算机还是虚拟的计算机，你都可以设置虚拟主机，或者使用一个名为“suEXEC”的 Apache 工具来安排 PHP 以你的身份运行，类似于共享主机服务。然而，这很难做到，尤其是如果你是新手的话，我不打算在本书中深入探讨。
*   如果你有一个虚拟服务器，它存在的唯一目的是运行你的网站，除了你没有其他用户，除了 Apache、SFTP 和 SSH 没有其他应用程序，除了你没有人可以登录。因此，你可以很容易地在共享系统上做一些会带来安全问题的事情:只需改变 Apache 的配置，让它真正像你一样运行，跳过虚拟主机或 suEXEC 的复杂性。(MAMP 也是这样设置的。)

要让 Apache 像你一样运行——比如 Ubuntu——有三个简单的步骤。首先，作为 root 用户，编辑配置文件以更改用户和组。对于 Ubuntu 来说，这个文件是`/etc/apache2/envvars`，你要换行

```
export APACHE_RUN_USER=www-data
export APACHE_RUN_GROUP=www-data
```

到

```
export APACHE_RUN_USER=ubuntu
export APACHE_RUN_GROUP=ubuntu
```

第二，改变文件的所有者`/var/lock/apache2`

```
sudo chown ubuntu /var/lock/apache2
```

第三，重启 Apache

```
sudo /etc/init.d/apache2 restart
```

再说一遍，这样我就不会收到讨厌的邮件了，这在一个有多个用户的服务器上运行不止一个用户的网站不是一个好主意，但是对于一个单一用途的虚拟服务器，或者对于一个没有外部访问的开发系统来说，这是完全安全的。

总之，不管怎样，如果 PHP 和 SFTP 能够编写相同的目录和文件，最好让它们以相同的用户身份运行。

Windows 没有组，对于 Apache 来说，没有像 suEXEC 这样的东西。你的选择是

*   以网站所有者的相同用户身份运行 web 服务器，Apache 或 IIS，或者
*   使用*身份模拟*，对于 IIS，大致相当于*nix 上的 suEXEC。

云服务器

云服务器分为两大类:你想做什么就做什么的虚拟机(IaaS)，以及提供你需要的设施(例如 PHP 和 MySQL)并随着负载增加而扩展的应用平台(PaaS)。一般来说(也有例外)，IaaS 系统提供了更多的灵活性，而 PaaS 系统更容易设置并提供自动扩展，而且它们有时是免费的。

对于 IaaS，您可以说，“我想要一台虚拟机。”使用 PaaS，您可以说，“这是我的应用程序—帮我运行它。”

正如您将在接下来的三个部分中看到的，我让 LAMP stacks 在 Amazon、Microsoft 和 Rackspace 的 IaaS 云上相当容易地运行，尽管这涉及到下载和安装软件、使用 SFTP 和 SSH 终端会话登录、查找和更改配置文件以及发现 IP(互联网协议)地址。我不确定这对一个专业程序员来说有多难(这本书的所有读者都是这样，对吧？)谁是 Linux 新手，因为我不典型。我从 1972 年就开始使用类 UNIX 系统，甚至还写过几本高级 UNIX 书籍(查看我的*高级 UNIX 编程*)。不过，如果你非常仔细地阅读说明，自由地使用谷歌搜索细节，并不断尝试，你一定会成功。我听说过 Rackspace 的技术支持，所以，如果你是这方面的新手，你可以先试试 Rackspace。亚马逊和微软可能不太愿意帮忙，因为他们没那么饥渴。

这里讨论的所有云服务器都允许轻松地向上扩展(更大的计算机)和向外扩展(更多的计算机，带有负载平衡器)。例如，一旦您得到了想要的 Amazon EC2 实例，管理控制台上一个名为“Launch More Like This”的菜单项允许您生成一个或多个额外的服务器，可能运行在更大的虚拟计算机上。你可以从亚马逊所说的微型开始，相当于一个内核和 613 MB 的内存，一直到 16 个内核和 117 GB 的内存。这是在扩大规模。要向外扩展，您需要生成额外的、可能更小的服务器，并添加一个负载平衡器来在它们之间分配负载。

我将介绍一个 PaaS、Amazon Elastic Beanstalk 和三个 IaaS 系统、Amazon EC2、Microsoft Azure 和 Rackspace Cloud Server 的入门知识。然后我会说几句关于 Google App Engine 的话，这是一个 PaaS，在本书即将出版时才开始支持 PHP。

亚马逊弹性豆茎

明白吗？你爬上豆茎到达云端。

我认为 A2 托管的任何运行`basepath.com`的计算机都是虚拟的，因为我永远不会看到它，也不知道它在哪个城市，但它不是虚拟的:它是一台真实的计算机，有固定的限制，他们永远不会让我超过，除非我注册一个更昂贵的计划。更糟糕的是，我把它分享给其他网站，没有人知道他们会做什么来攫取资源。我能做的也很有限。例如，如果我想允许 URL 作为文件名(比如说在`file_get_contents`中)，我不能——A2 主机不允许。正如我提到，还有 MySQL 触发器的限制。

亚马逊弹性计算云(更广为人知的名称是 EC2)并非如此。你得到了一台看似真实的计算机，名为*实例*、，你可以以 root 用户身份登录，并以任何你想要的方式进行配置。但是，它是一台虚拟计算机，运行在亚马逊数据中心的某个服务器上。你可以根据需要扩展它，但它不能超越亚马逊拥有的最大服务器，即大约 16 个内核和 117 GB 的内存。相当大，但仍有限制。

您可以添加另一个服务来提供负载平衡，以便在 EC2 实例之间分配会话。对于数据库，您可以在 EC2 实例上运行 MySQL，因为您拥有(虚拟)机器，所以您可以使用虚拟 MySQL 数据库，Amazon 称之为关系数据库服务(RDS)。(RDS 还支持 Oracle 和 Microsoft SQL Server。)

其结果是，随着流量的增加，web 服务器几乎无止境地、完全自动地扩展。如果流量减少，它就会缩小。您只需为您使用的东西付费。

问题在于，尽管亚马逊在基于网络的管理界面上做得相当不错，但设置起来还是需要很多工作。几年前，亚马逊用弹性豆茎让这变得简单多了。现在建立一个弹性服务真的很容易，有了所有的东西:负载平衡、Apache、MySQL 和 PHP。用云的行话来说，这一切都是为您完成的，它是 PaaS，而不是 IaaS。

为了演示使用 Elastic Beanstalk 是多么容易，我将展示如何从头开始设置它。(在下一节中，我将对一个普通的 EC2 IaaS 实例做同样的事情，没有结霜。)

首先，你需要一个亚马逊网络服务账户，你可以在`aws.amazon.com`获得。(如果您是新客户，您可以免费构建和使用一个弹性 Beanstalk 服务器一年。)一旦你有了这些，你进入 AWS 管理控制台，点击 Elastic Beanstalk 链接，然后你被要求选择你的平台，如图 3-6 所示。

![9781430260073_Fig03-06.jpg](images/9781430260073_Fig03-06.jpg)

[图 3-6](#_Fig6) 。选择弹性豆茎平台

我选择了 PHP 5.4，它将我带到了 Elastic Beanstalk 控制面板，在那里我花了几分钟时间观察了创建环境的进度，包括各种组件(EC2、负载平衡器等。)得到了配置和启动。当一切都准备好时，我看到了图 3-7 中的内容。

![9781430260073_Fig03-07.jpg](images/9781430260073_Fig03-07.jpg)

[图 3-7](#_Fig7) 。弹性豆茎应用示例

示例应用程序只显示一个样板网页。我想要自己的应用程序。所以，我点击了你在[图 3-7](#Fig7) 顶部看到的上传新版本按钮，上传了一个包含来自[清单 3-1](#list1) 的 PHP 文件的压缩文件，但是修改后使用了 Elastic Beanstalk 放入环境中的数据库参数，而不是在 PHP 文件本身中对它们进行硬编码。[清单 3-2](#list2) 展示了这些修改。(你可以上传压缩的源文件或者直接从 Git 上传。)

***[清单 3-2](#_list2)*** 。为弹性豆茎修改的测试程序

```
define('DB_HOST', $_SERVER['RDS_HOSTNAME']);
define('DB_PORT', $_SERVER['RDS_PORT']);
define('DB_USERNAME', $_SERVER['RDS_USERNAME']);
define('DB_PASSWORD', $_SERVER['RDS_PASSWORD']);
try {
    $dsn = 'mysql:host=' . DB_HOST . ';port=' . DB_PORT;
    new PDO($dsn, DB_USERNAME, DB_PASSWORD);
}
catch (PDOException $e) {
    die($e->getMessage());
}
echo "<p>PHP/MySQL is working!";
phpinfo();
```

我点击上传新版本按钮时得到的上传面板如我填写的[图 3-8](#Fig8) 所示。

![9781430260073_Fig03-08.jpg](images/9781430260073_Fig03-08.jpg)

[图 3-8](#_Fig8) 。弹性豆茎版上传面板

安装新版本花了几分钟时间。当我在浏览器中测试 PHP 文件时，它失败了，屏幕上显示如下内容:

```
SQLSTATE[HY000] [2002] No such file or directory
```

问题是我没有请求 RDS 数据库——默认情况下不会有。因此，我点击了你在[图 3-7](#Fig7) 底部看到的编辑配置链接，这将我带到配置编辑器，在那里我点击了数据库选项卡，如图[图 3-9](#Fig9) 所示，并创建了一个 MySQL 数据库。

![9781430260073_Fig03-09.jpg](images/9781430260073_Fig03-09.jpg)

[图 3-9](#_Fig9) 。弹性豆茎配置编辑器

这次它成功了，给出了图 3-10 中的输出，除了 PHP 版本之外，它看起来就像[图 3-3](#Fig3) 。

![9781430260073_Fig03-10.jpg](images/9781430260073_Fig03-10.jpg)

[图 3-10](#_Fig10) 。在弹性豆茎上运行的测试程序

Elastic Beanstalk 及其负载均衡器比只使用 EC2 机器更昂贵。对于最小的 EC2 机器，假设最小的带宽和存储，带 RDS 的 Elastic Beanstalk 大约是每月 54 美元。EC2 机器如果没有使其具有弹性的服务，价格大约为 15 美元，所以您需要为负载平衡器和 RDS 支付很多费用。只有一台服务器的负载均衡没有任何意义(没什么好平衡的)，所以这些价格意义不大。随着 EC2 服务器越来越多、越来越大，负载平衡在总成本中所占的比重并不是很大，因为它的成本是相当固定的，不依赖于它所处理的服务器数量。您也不必使用 RDS，因为您可以在 EC2 机器上免费安装 MySQL。简而言之，弹性豆茎没有经济意义，除非你有一个快速增长的大型网站。您所支付的是应对这种增长的能力。如果你不期望快速成长，你就不需要有弹性的豆茎。

因为您可以单独获取其组件，所以 Elastic Beanstalk 是一种 PaaS，它仍然提供 IaaS 的灵活性。其他 PaaS 产品，如谷歌的应用引擎，要封闭得多。

亚马逊 EC2

为了了解如何将 EC2 实例(没有所有弹性 Beanstalk extras 的 IaaS)配置为 LAMP 堆栈，我从 AWS 管理控制台启动了一个 EC2 实例，从可用类型菜单中选择 Ubuntu。

使用 EC2，您必须在启动映像时指定一个 SSL 密钥对文件，因为仅用密码通过 SSH 或 SFTP 访问它是不够的。从 AWS 管理控制台的 EC2 部分创建一个密钥对，然后将其下载到开发计算机上。将它放在您喜欢的任何地方，这样您就可以从您的 SSH 终端和 SFTP 应用程序中引用它。为了使用它，您必须确保它是不可写的，因为客户端将拒绝使用一个密钥对文件，除非它是受保护的。当我使用 Elastic Beanstalk 实例时，我已经建立了一个密钥对文件，所以我只使用那个文件。(一个就够了。)如果您在没有指定您下载的密钥对文件的情况下启动映像，您将不得不终止它并重新开始。

接下来，您必须确保启动 EC2 实例的安全组允许 HTTP (web)访问。

下载了密钥对并设置了安全组后，就可以启动实例了。在它启动后，您可以通过在终端中键入的`ssh`命令从*nix 开发系统连接到它，如下所示:

```
ssh -i /Users/marc/.ssh/keypair1.pem \
ubuntu@ec2-54-242-132-25.compute-1.amazonaws.com
```

它显示为分布在两行上，但它是一个命令行；反斜杠是外壳延续字符。如果您的开发系统是 Windows，您可以使用免费的 PuTTY 应用程序进行 SSH 访问。

一旦我进入 shell，我就输入命令

```
sudo apt-get update
```

更新可用软件的目录，然后使用命令

```
sudo tasksel
```

给我一个简单的交互式安装灯堆的方法，如图[图 3-11](#Fig11) 所示。请注意我对第四个选项“灯服务器”的选择其他星号已经在那里；如果我删除了任何组件，该组件将被卸载。

![9781430260073_Fig03-11.jpg](images/9781430260073_Fig03-11.jpg)

[图 3-11](#_Fig11) 。运行 tasksel 的 EC2 实例

LAMP 安装后，网站就可以运行了，这是我通过浏览器验证的。然后从 SSH 会话中，我编辑 Apache 配置将文档根目录改为我登录目录的子目录，上传[清单 3-1](#list1) 所示的测试程序，得到我想要的，如图[图 3-12](#Fig12) 所示。

![9781430260073_Fig03-12.jpg](images/9781430260073_Fig03-12.jpg)

[图 3-12](#_Fig12) 。在 EC2 实例上运行的测试程序

Microsoft Azure

Azure 是微软的云服务。微软称之为 Windows Azure，但你可以用它来设置 Linux 虚拟机，以及 Windows。(亚马逊和 Rackspace 也支持 Windows。)

为了试用 Azure，我设置了一个运行 Ubuntu Linux 的小型虚拟机(IaaS)。我享受了 90 天的免费试用，但如果我不得不为这台机器付费，每月大约需要 15 美元，与亚马逊最小的 EC2 机器一样。

只需点击几下就可以得到我的 Ubuntu 服务器，除了 L 部分，没有安装 LAMP 堆栈的任何部分。我能够轻松地连接 SFTP(运行的服务器)并登录到 SSH shell，而不需要使用密钥对文件，这是 Amazon EC2 要求我做的。在 shell 中，我可以用`sudo`命令得到一个超级用户(root)提示符。

微软有一个很好的帮助页面，解释了如何安装 LAMP 堆栈的其余部分，基本上是通过 SSH shell 执行一个命令。

```
apt-get install apache2 mysql-server php5 php5-mysql \
libapache2-mod-auth-mysql libapache2-mod-php5 php5-xsl php5-gd php-pear
```

事实证明，这和使用可视化安装工具`tasksel`一样简单。然后我启动了 Apache 服务器。

```
sudo /etc/init.d/apache2 restart
```

但是 Azure 分配的 URL，`rochkind.cloudapp.net`，没用。搜索了一下，我发现我忘了为端口 80(web 服务器的默认端口)创建一个端点，所以我从 Azure 管理门户创建了这个端点。然后网站工作了。(这类似于我在 EC2 中遇到的问题，当时我忘记将 HTTP 添加到安全组中。)

然后，由于 Apache 文档根对于我的用户登录来说是不可写的，我不得不像对 EC2 一样更改文档根。然后我上传了测试程序([清单 3-1](#list1) )，一切正常，如图[图 3-13](#Fig13) 所示。

![9781430260073_Fig03-13.jpg](images/9781430260073_Fig03-13.jpg)

[图 3-13](#_Fig13) 。在 Azure Ubuntu 服务器上运行的测试程序

你通常不会认为微软是 Linux 服务器领域的大腕，但它恰恰表明了云计算的竞争力，以及它对主要参与者的重要性。

我用微软的 PaaS 产品做了一点试验，微软称之为网站，它包括 PHP 和 MySQL。如果你有一个小网站，它们是免费的，但是它们有共享主机的限制，这使得它们不适合我在这本书里关注的那种应用。我会选择虚拟机。

机架空间

接下来是 Rackspace，它提供了许多与亚马逊和微软相同的云功能。正如我在 Azure 上做的那样，我注册了最小的 Ubuntu 服务器，这将花费我大约 16 美元一个月，与亚马逊 EC2 和微软 Azure 差不多。

一旦我的虚拟机设置好了，Rackspace 就给了我需要的 SSH 命令，这是我必须为亚马逊和微软自己解决的问题。事实上，点击他们网页上的链接，我就直接进入了 Mac OS 终端应用程序。当然，不能上网，因为这是一台全新的机器。

我执行了用于 Azure 服务器的相同的`apt-get`命令，它工作了。这一次，端口 80 已经处于活动状态，所以对 Apache 的 web 访问马上就可以工作了。

与 SFTP 的接触也奏效了。测试程序也是如此，表明 PHP 和 MySQL 都在运行。我的浏览器显示的内容类似于[图 3-12](#Fig12) ，因为灯组是相同的。所以，再一次，成功！

谷歌应用引擎

Google App Engine，一个 PaaS，已经出来一段时间了，但是只支持 Java、Python 和 Go(一种 Google 发明的语言)。就在我完成这一章的时候，它宣布了对 PHP 的支持，所以我可以稍微了解一下。关于谷歌应用引擎的一些值得注意的事情:

*   与其他供应商不同，它为您提供了一个完整的开发平台，包括一个运行 PHP 和 MySQL 的 web 服务器，因此您可以在本地进行测试。
*   小应用程序是免费的，而且，在典型的谷歌时尚中，免费层相当慷慨，所以对于小网站你不必付费。然而，这不包括 MySQL，谷歌称之为云 SQL 谷歌为此收费。
*   与亚马逊 Elastic Beanstalk 不同，App Engine 是一个封闭的系统。我需要在 PHP 中添加 cURL 扩展，这样我就可以运行第三方库(Twilio，我在第 6 章的[中讨论过)，但是它不被支持，也没有办法添加。相比之下，Amazon EC2 只需要一个命令:`sudo apt-get install php5-curl`。](6.html)

就在谷歌宣布 PHP 应用引擎的同一周，谷歌推出了计算引擎产品。这是一个运行 Linux(仅)虚拟机的 IaaS。我没有玩过它，但是我确信它的设置和其他云供应商的设置是相似的。因为它是 IaaS，而不是 PaaS，所以不会有任何功能限制。

云服务器总结

以下是我在尝试将灯堆栈放在云服务器上时学到的东西:

*   Amazon Elastic Beanstalk 很容易安装，因为灯堆已经为您安装好了，并提供了很大的弹性，但如果您不需要这种弹性，它会很贵。
*   我研究的其他 PaaS 系统，Azure 网站和 Google App Engine，都像 Elastic Beanstalk 一样容易设置，但是它们有一些你无法回避的限制。然而，对于小网站来说，它们是免费的。
*   EC2、Azure、Rackspace 和 Google 都提供了虚拟机(IaaS ),在容量和操作系统选择方面有很多选项。如果您升级到多台服务器，它们也都具有负载平衡功能。
*   所有虚拟服务器的成本都差不多，至少对于我的适度需求来说是这样。您可能会发现它们之间的细微差别，这取决于您如何设置它们以及您使用什么资源。
*   用 Ubuntu 下载和安装 LAMP 栈并不太难，但是您可能不得不摆弄安全组、端点和密钥对文件。您还需要知道如何编辑 Apache 配置文件，但无论如何这是一项有用的技能。
*   Rackspace 比 EC2 或 Azure 更容易设置，据说它有很好的支持，所以如果你是新手，它可能是最好的选择。Azure 提供 90 天免费，亚马逊提供一年。

云服务器不像商业共享主机服务那样容易上手，商业共享主机服务已经为你设置好了，但是云服务器提供了对服务器的完全控制，如果你有技能利用它，或者如果你想发展这些技能，这将带来巨大的好处。

底线:如果你有一个重要的应用程序，使用虚拟机(IaaS)。封闭的 PaaS 系统最终会阻止你让你的应用程序按照你想要的方式工作。

安装新版本

假设您已经开发了您的 PHP/MySQL 应用程序，将它上传到生产服务器，在那里进行测试，并向乐于使用它的用户开放。您已经在您的开发系统上开发了一个新版本，现在是时候上传该版本进行测试和发布了。你是怎么做到的？有几种错误的方式，和往常一样，至少有一种正确的方式。首先，错误的方式。

做错了

安装新版本的一种方法是关闭服务，用一个只输出 HTML 页面的文件替换主`index.php`文件，说明服务不可用，上传新版本，主页面暂时命名为`index-new.php`，然后，一旦它被签出，将其重命名为`index.php`，使应用程序再次可用。这是可行的，但是在你准备好新版本的时候，让应用程序退出服务可能是不可接受的。这不是 1970 年的大型机应用程序，而是万维网！

另一个想法是把新版本上传到正在运行的版本上，而不是先在服务器上测试。这有两个问题。

*   你不能跳过服务器上的测试。它和你当地的开发体系有太多的不同。很多事情都可能出错。
*   由于上传文件至少需要 10 秒或更长时间，任何运行该应用程序的人都会看到新旧文件的混杂。他们得到什么系统是不确定的。你更希望他们运行你设计的东西。

您可以通过上传到一个不同的顶级目录来解决第一个问题，比如说一个名为`stage`的目录。假设生产目录名为`prod`。在`stage`测试完新版本后，你把`prod`改名为`prod-old`，把`stage`改名为`prod`。听起来相当不错，它解决了无法在生产服务器上测试新版本的问题，但仍然有两个问题，一个明显，一个不明显。

*   虽然重命名几乎是瞬间完成的，但是仍然有可能有人在`prod`已重命名而`stage`尚未重命名的情况下访问应用程序，这会给他们一个 404(“未找到”)错误。
*   尽管你已经在应用程序中不厌其烦地只使用相对文件引用，但它们仍然会得到新旧页面的混杂。

下面是对第二个问题的解释:在 PHP 中，一个类似

```
require_once 'file.php'
```

被视为相对于封闭脚本的目录，或者，如果在那里找不到，则被视为相对于当前目录。(通常在*nix 系统中，比如从 shell 中，相对路径总是相对于当前目录。)但是对于 HTML 来说就不是这样了，如果你有类似

```
<a href='file.php'>link</a>
```

HTML 是在浏览器中处理的，在客户端，而不是在服务器上，没有文件或当前目录的概念。(客户端操作系统可能有一个当前目录，但浏览器会忽略它。)在浏览器中，相对路径是相对于浏览器在请求中使用的 URL，该请求产生它正在处理的 HTML。此 URL 通常显示在浏览器窗口顶部的 URL 字段中。

例如，假设浏览器正在显示 URL

```
http://basepath.com/ClassicCameras/login.php
```

该页面包含以下 HTML 片段:

```
<a href='signup.php'>Sign up for new account</a>
```

浏览器不会在`login.php`的父目录中寻找`signup.php`。它对`login.php`一无所知，也不知道它在哪个目录下。它只知道它请求了显示在其 URL 字段中的 URL，并且有一些 HTML 通过网络传输过来。因此，它所能做的就是字符串操作:获取那个 URL，用`signup.php`替换最后一个组件，并发出另一个请求，这次是

```
http://basepath.com/ClassicCameras/signup.php
```

我知道这看起来很迂腐，因为看起来发生的事情和在父目录中查找是一样的，但真正发生的是一个全新的绝对 URL 导致了对另一个 HTML 页面的请求。

那么，我的观点是什么？只是如果你在一个会话还在页面间导航的时候把目录`prod`改成了`prod-old`，那么这个会话将不会停留在它之前所在的那个树中，这个树现在被命名为`prod-old`。它将切换并开始从新目录`prod`获取页面，因为`prod`位于它用来形成 URL 请求的 URL 中。

为了证明这一点，我在我的网站上放了两个目录，`dir1`和`dir2`。每个都包含`file1.php`和`file2.php`两个文件，但四个文件的内容不同，如图[图 3-14](#Fig14) 所示。

![9781430260073_Fig03-14.jpg](images/9781430260073_Fig03-14.jpg)

[图 3-14](#_Fig14) 。两个目录，每个目录包含两个文件

现在，如果我在我的浏览器中输入 URL `http://localhost/dir1/file1.php`，我会得到图 3-15 左侧窗口中显示的内容，这就是你所期望的图 3-14 中显示的内容。

![9781430260073_Fig03-15.jpg](images/9781430260073_Fig03-15.jpg)

[图 3-15](#_Fig15) 。浏览器中显示的两个 HTML 页面

然后，如果我点击链接，我会看到图 3-15 中右边显示的内容。现在我点击返回按钮回到第一个窗口，再次显示在[图 3-16](#Fig16) 左侧。

![9781430260073_Fig03-16.jpg](images/9781430260073_Fig03-16.jpg)

[图 3-16](#_Fig16) 。浏览器中显示的另外两个 HTML 页面

假设这是应用程序的版本 1，放在目录`dir1`中。我现在准备在目录`dir2`中安装版本 2，我一直在测试它。我巧妙地通过重命名目录来安装新版本，而不是通过复制文件这种愚蠢的方式。

```
mv dir1 dir1-old
mv dir2 dir1
```

我的用户从版本 1 开始，看着图 3-16 中左边显示的窗口，点击链接，得到右边显示的内容。这是第二版页面！上面写着`dir2`，2 版也是这么写的。(再次查看[图 3-14](#Fig14) 。)为什么？因为当浏览器看到指向`file2.php`的链接时，它会产生一个包含`dir1`的 URL，并将其发送给服务器。这时我已经更改了目录名，并且`dir1`包含了`dir2`曾经包含的内容。关键是浏览器没有停留在原来的目录内，现在改名为`dir1-old`。它有效地切换到了新的目录，从而切换到了新的版本。

如果你再看看[图 3-15](#Fig15) 和[图 3-16](#Fig16) ，尤其是显示在小窗口顶部的网址，看起来没什么奇怪的。两次都是从`dir1`的`file1.php`到`dir1`的`file2.php`的链接。错误在于认为它会神奇地留在同一个目录中。但是，当所有的浏览器都必须处理组成它所请求的 URL 的字符串时，这怎么可能呢？

因此，重命名目录并不比在运行的版本上复制好多少。别忘了，在重命名期间，一些不幸的用户可能会得到 404 错误。

哎呀！您不能关闭应用程序，不能复制文件，也不能重命名生产目录。你到底是怎么安装第二版的？继续读。

做正确的事

下面是如何安装新版本:当你上传第一个版本到服务器进行测试时，它会进入一个名为`stage`的目录，即暂存目录。当你准备好部署它的时候，你给`stage`一个新的唯一的名字，比如说`v1366988331`。那是你给用户的网址。(其实送给用户太诡异了，但是忍着点；我会尽快解决这个问题。)用户可以永远和以前的`v1366988331`呆在一起，因为你永远不会把它拿走。好吧，如果你关心它占用的空间，也许一周之后，但是这个想法是用户可以完全在`v1366988331`完成他或她的会话。

一旦你将`stage`重命名为`v1366988331`，你就将`v1366988331`的内容复制回`stage`，它已经不存在了，因为你重命名了它。这只是为了让您有一个临时目录可以使用。因为除了开发人员没有人使用`stage`，所以复制需要多长时间或者它是否是原子的并不重要。如果需要一两分钟，你不在乎。

你开发下一个版本，把它全部或部分上传到`stage`上，你认为合适的话，测试它，最终决定是时候部署它了。你制定了另一个独特的名字，这一次，说，`v1366988366`。请注意，这是一个更大的数字，意味着更新的版本。这很重要，你必须确保这些数字是这样生成的。这次您将`stage`重命名为`v1366988366`，然后像以前一样，将`v1366988366`复制回`stage`。

现在，在某种程度上，我将很快解释，启动会话的用户将获得最新版本。任何仍在旧版本中处理页面的人仍然可以不受干扰地这样做，因为您从未接触过那个目录。

与我之前展示的混乱命名相比，它的不同之处在于，您没有重命名生产目录，因此您可以重用生产名称。您不断生成新名称，唯一被重命名的目录是`stage`。

好的，明白了吗？现在我将把它合并到一些简单的 PHP 文件中，让它自动工作。顶层文件命名为`index.php`；和往常一样，这是任何使用公共 URL 的人默认都可以访问的。这就是为什么那些`v…`的名字并不重要。它会计算出将用户传递到哪个版本。因为应用程序中的所有链接都是相对的，用户将停留在他或她开始时的版本中。文件`index.php`不在一个版本中，但也不必在，因为它的内容永远不需要改变。[图 3-17](#Fig17) 显示了目录布局，可以看到`index.php`在任何版本之外。(我将很快解释类似定位的`install.php`文件。)

![9781430260073_Fig03-17.jpg](images/9781430260073_Fig03-17.jpg)

[图 3-17](#_Fig17) 。暂存和版本目录

清单 3-3 显示了所有应用程序的顶层 PHP 文件`index.php`。

***[清单 3-3](#_list3)*** 。通用顶级 PHP 文件

```
$code_dir = 'stage';
if (empty($_REQUEST['stage'])) {
    foreach (scandir('.', 1) as $f)
        if (preg_match('/^v[0-9]{10}$/', $f)) {
            $code_dir = $f;
            break;
        }
}
require_once "$code_dir/login.php";
```

变量`$code_dir`将保存版本目录，或者是`stage`，如果参数`stage=1`出现在 URL 上，这将在测试期间出现，或者是最新的`v...`目录。为了找到最新版本，它会扫描`index.php`所在的目录，以找到编号最高的目录。然后在循环之后，它引入一些 PHP 代码，这样就可以向用户呈现一个正确的初始页面。注意,`login.php`的内容在一个版本或暂存目录中，这是我们想要的，因为它很可能必须从一个版本改变到另一个版本。由于`index.php`中没有 HTML，它可以保持不变。

你必须编写`login.php`,这样它就可以嵌入到`index.php`中或者独立运行，在它自己的 URL 中。在第一种情况下，浏览器显示的是应用程序目录，这里是`MyApp`。在第二种情况下，浏览器位于版本或暂存目录中。HTML 中的相对引用必须双向工作。我稍后将展示您如何做到这一点的细节。

为什么我使用`require_once`引入`login.php`而不是改变头，这是将一个 PHP 文件传递到另一个文件的更常见的方式？即，如下所示:

```
header("Location: $code_dir/login.php");
```

如果我这样做了，用户在浏览器 URL 字段中输入的类似于`http://basepath.com/MyApp`的 URL 将被替换为指向`login.php`的 URL，因为位置头是由浏览器处理的，而不是服务器。键入的 URL 会立即被替换为类似

```
http://basepath.com/MyApp/v1366988366/login.php
```

并且用户永远不会有机会将公共 URL 拖动到书签。当用户进入应用程序时，带有`v1366988366`的内部 URL 仍然会出现在浏览器中，但这没关系——用户已经习惯了复杂的 URL 出现在浏览器中。(看看亚马逊产生的怪物。)它只是我们希望保持干净的初始公共 URL。

用户保存其中一个内部 URL 以备后用并没有太大的危险，因为，正如我在本书后面所展示的，除了那些可被注销用户使用的文件之外，所有 PHP 文件都要求它们在一个 PHP 会话中，而获得一个会话的唯一方法是以`login.php`开始。用户仍然可以保存内部书签，但它们是不可操作的，所以他们会学会不去打扰。

继续这个例子，[清单 3-4](#list4) 显示了一个`login.php`存根文件。

***[清单 3-4](#_list4)*** 。登录存根

```
<!DOCTYPE html>
<html>
<head>
<title>Login Page</title>
</head>
<body>
<h1>Login Page Stub</h1>
<p>[login form goes here]
<p>
<?php
    $dir = empty($code_dir) ? '' : "$code_dir/";
    echo "<a href='{$dir}start.php'>Login</a>";
?>
</body>
</html>
```

通常，在允许执行到`start.php`之前，会有一个登录表单和检查用户名和密码的处理，但是在这个存根中，表单丢失了，用户所要做的就是单击`Login`链接。如果该文件嵌入在[清单 3-3](#list3) 所示的`index.php`文件中，则`$code_dir`被定义并用于形成链接的相对引用中，因为解析该相对引用的浏览器位于应用程序目录中(图 3-17 中的`MyApp`)。但是，如果从应用程序内部直接调用`login.php`，浏览器的 URL 位于版本或暂存目录，因此相对引用是普通的`start.php`。正如我所说的，`login.php`是唯一需要这种处理的文件。文件`start.php`和所有其他应用程序文件都不会。

如果您的应用程序不需要登录，或者您有一些第一个屏幕而不是登录页面，该怎么办？好的，没问题。把`login.php`换成你喜欢的。重点是，第一页必须嵌入到`index.php`中，并且可以直接访问。

为了验证应用程序中的页面确实在它们的目录中，[清单 3-5](#list5) 和 [3-6](#list6) 显示了另外两个页面:一个起始页(`start.php`，链接到 from `login.php`，另一个页面，链接到 from `start.php`。

***[清单 3-5](#_list5)*** 。起始页存根

```
<h1>Start Page Stub</h1>
<?php
echo "<p>PHP_SELF: {$_SERVER['PHP_SELF']}<p>";
echo "<p><a href='another.php'>Another</a>";
?>
```

***[清单 3-6](#_list6)*** 。另一页存根

```
<h1>Another Page Stub</h1>
<?php
echo "<p>PHP_SELF: {$_SERVER['PHP_SELF']}";
echo "<p><a href='start.php'>Start</a>";
?>
```

现在，这是 MyApp 在我的开发系统上的应用。应用 URL 调出登录页面，如图[图 3-18](#Fig18) 所示。请注意浏览器访问的 URL，这是 NetBeans 在开发过程中使用的 URL。

![9781430260073_Fig03-18.jpg](images/9781430260073_Fig03-18.jpg)

[图 3-18](#_Fig18) 。登录页面存根运行

正如我所说的，有了这个存根，你所要做的就是点击`Login`链接登录，这将带你到起始页，如图 3-19 所示。现在来看看 URL，它表明应用程序在临时版本中。

![9781430260073_Fig03-19.jpg](images/9781430260073_Fig03-19.jpg)

[图 3-19](#_Fig19) 。开始运行页面存根

点击`Another`链接进入另一个页面，仍然是暂存版本，如图[图 3-20](#Fig20) 所示。

![9781430260073_Fig03-20.jpg](images/9781430260073_Fig03-20.jpg)

[图 3-20](#_Fig20) 。另一个页面存根正在运行

假设 MyApp 已经过测试，可以部署了。目录`stage`被重命名为版本目录，因此`index.php`将转到那里，除非指定了参数`stage=1`，就像在开发期间一样。`install.php`程序位于应用程序目录中，如图[图 3-17](#Fig17) 所示，在[清单 3-7](#list7) 中。

***[清单 3-7](#_list7)*** 。版本安装程序

```
echo "<p>Installing production version";
$dir = 'v' . str_pad(time(), 10, '0', STR_PAD_LEFT);
if (!rename('stage', $dir))
    die('<p>Rename failed');
copy_dir($dir, 'stage');
echo "<p>Production version installed ($dir)";

function copy_dir($from, $to) {
    @mkdir($to);
    $d = dir($from);
    while (($f = $d->read()) !== false)
        if ($f[0] != '.') {
            $from_path = "$from/$f";
            $to_path = "$to/$f";
            if (is_dir($from_path))
                copy_dir($from_path, $to_path);
            else if (!copy($from_path, $to_path))
                die('<p>Copy failed');
        }
}
```

版本目录由“v”构成，后跟自 1970 年 1 月 1 日以来的时间(以秒为单位),在 2286 年之前一直是十位数，因此按词汇顺序排列版本目录名称也将按版本号顺序排列，这有助于查找最新版本。这就是`index.php`程序所做的([清单 3-3](#list3) )。

确定版本目录名称后，程序接下来会重命名登台目录。这一个操作就完成了安装，新版本就可以使用了。任何通过`index.php`访问应用程序的用户都将获得该版本。重命名是原子性的，所以用户不可能得到格式错误的目录名。

为了方便开发人员，程序接下来会将新版本复制回一个新的`stage`目录，这就是`copy_dir`函数的作用。我会让你自己算出这个函数。(提示:当前目录和父目录以句点开头，需要跳过。)

[图 3-21](#Fig21) 显示`install.php`正在运行(注意网址)。

![9781430260073_Fig03-21.jpg](images/9781430260073_Fig03-21.jpg)

[图 3-21](#_Fig21) 。安装新版本

安装了生产版本后，引用应用程序目录`MyApp`执行`index.php`，它选择最新版本，在本例中为`v1367077979`。添加`stage=1`运行 staging 版本。每当暂存目录中的新版本准备好用于生产时，`install.php`安装它，并且`index.php`开始引用它。因为版本一直存在，所以没有用户会从一个版本切换到另一个版本。因为安装是通过重命名而不是复制来完成的，所以用户不会得到部分更新的版本。正是我们想要的！

然而，有两个小问题需要解决。首先，我们不希望任何人都运行 staging 版本，如果他们发现世界上每个 PHP 开发人员都读过这本书，并采用我的方法安装新版本，他们就会运行 staging 版本。解决这个问题的简单方法是将`stage`参数的值设为某个随机数，而不是 1，然后在`index.php`中检查这个数。因此，要运行暂存版本，您必须使用如下 URL

```
http://basepath.com/MyApp?stage=459810329
```

第二个问题类似，但是对于`install.php`。你不希望任何人都能安装新版本。同样，一个简单的解决方案是需要一个密码作为参数，或者更简单，只需将文件命名为类似于`install-83950471.php`的名称，这样就没有人能猜出它的名称。(Apache 应该总是被设置为禁止目录列表，所以名字是不可发现的。)

章节总结

*   三个平台很重要:服务器、客户机和开发。为了方便开发，该平台包含了其他两个平台。
*   服务器操作系统可以是 UNIX 版本(*nix)或 Windows。如果是*nix，web 服务器一般会是 Apache。如果是 Windows，可以是 Apache，也可以是 IIS，但通常会是 IIS。
*   在本书中，唯一关心的数据库是 MySQL，主要编程语言是 PHP，尽管您还必须处理 HTML、JavaScript 和 SQL。
*   在大多数情况下，支持的重要浏览器是 Chrome、Internet Explorer、Firefox、Safari 和 Opera。
*   由于 Internet Explorer 只能在 Windows 上运行，所以选择 Windows 作为您的开发系统是有意义的，至少对于您团队中的一名成员来说是如此。
*   要处理浏览器和版本变体，使用 jQuery 来掩盖差异，并确保使用所有相关的浏览器和版本进行测试。
*   使用 IDE 进行开发很方便。NetBeans 和 Eclipse 是两个不错的选择，都是免费的，NetBeans 更容易上手。
*   安装 Xdebug 进行调试，安装 PHPUnit 进行单元测试。(也有其他选择。)两者都受 NetBeans 和 Eclipse 支持。
*   使用 Subversion、Git 或 Mercurial 进行版本控制。(也有其他选择。)NetBeans 和 Eclipse 都支持这三者。
*   最简单的生产主机是商业共享主机服务，但是基于云的虚拟机提供了更多的灵活性和性能保证。对于后者，你很可能必须自己安装灯组的放大器部分。
*   要在生产服务器上安装 PHP 应用程序的新版本，请在一个临时目录中进行测试，然后在准备好部署它时将该目录重命名为一个惟一的版本名。安排应用程序自动运行最新版本。