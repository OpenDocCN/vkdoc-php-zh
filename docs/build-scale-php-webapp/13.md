# 13.Linux 安全基础知识

本章并不是云安全的完整指南，而仅仅是为您指明正确的方向。安全与其说是一系列步骤，不如说是一个过程和一种思考方式，因此本章将重点介绍您需要如何思考来保护服务器的完整性和数据的完整性。

## 13.1 基本考虑因素

对于系统管理员来说，最重要的安全注意事项如下:

*   我如何降低连接到互联网的风险？

*   我可以在我的系统上运行并保持其功能的最小服务集是多少？

*   如何限制不是每个人都需要的服务对服务器的访问？

*   我所有的软件都安装了最新的安全补丁吗？

*   有人可以通过哪些方式滥用部署在服务器上的服务，我该如何缓解这种情况？

安全性的关键是确定服务器的用途，然后删除与该功能没有直接关系的任何内容，以防止不必要的后果。你运行的每一项服务都是一个潜在的安全漏洞——总有一天有人会发现如何利用它。因此，您不希望暴露在对功能没有直接贡献的点上。

## 13.2 检查您当前的服务器

检查服务器上当前正在运行和监听的服务的最佳工具是`ss`(套接字统计)。要查找正在侦听连接的每个 TCP 服务，请以 root 用户身份运行以下命令:

```php
ss -plnt

```

写有`LISTEN`的每一行都是一个正在监听 IP 连接的服务。如果“本地地址”是`127.0.0.1`、`::1`(对于 IPv6 地址)或节点的私有 IP 地址，这意味着服务是受保护的——只有机器本身上的应用程序*可以看到服务(在私有 IP 地址的情况下，在私有网络上)。然而，如果本地地址是`*`、`0.0.0.0`或`::`(对于 IPv6 地址)，这意味着它可供任何人连接。*

同样，对于 UDP 连接，您可以:

```php
ss -plnu

```

对于每个可连接的服务(TCP 或 UDP ),您应该确保它不被您的防火墙允许，除非您完全确定您希望人们连接。要获取防火墙允许的服务列表，请发出以下命令:

```php
firewall-cmd –list-all

```

“服务”和“端口”下列出的项目是防火墙允许通过的项目。您应该允许的服务有`dhcpv6-client`(由云用来配置网络)、`ssh`(以便您可以登录)、`http`(用于非 SSL HTTP 连接)和`https`(用于启用 SSL 的 HTTP 连接)。

尽管防火墙会阻止与未列出的任何内容的连接，但如果您有任何正在运行的服务正在侦听您并不特别需要运行的连接，您应该禁用该服务。此外，您应该定期检查您的防火墙，以确保其配置正确。

此外，您应该清点所有正在运行的进程，即使它们没有侦听连接。在 Linux 上最好的方法是使用命令`ps -afxww`。注意，每个人都有自己喜欢的`ps`称呼方式，但这是我的。

我不能给你一个应该/不应该运行的列表。但是，最好是了解每一块是做什么的，把不需要的那块关掉。运行的服务越少越好。

您也可以使用命令`rpm -qa`列出您已经安装的所有软件包。随着你越来越有经验，你应该能够卸载你不需要的程序。

## 13.3 根用户

Linux 安装中最危险的部分是根用户。这是危险的，原因有二。首先，它是超级用户，因此它对其他一切都有权力。第二，每个人都知道它的用户名，这使得自动黑客工具更容易攻破。

有几种方法可以减轻根用户的问题。它们包括

1.  根密码应该是安全的(即，即使计算机也很难猜到)。事实上，每个用户的密码应该是安全的。

2.  服务器不应允许远程直接 root 登录。为了防止通过`ssh`的直接根登录，修改`/etc/ssh/sshd_config`。如果已经有一行写着`PermitRootLogin`，将值从`yes`改为`no`。如果那里没有一行，添加一行表示`PermitRootLogin no`。保存文件后，执行`systemctl restart sshd`，更改将生效。之后，您需要以普通用户的身份登录，并使用`su`命令将用户切换到`root`。

3.  服务应该很少作为根用户运行，除非有压倒性的理由这样做。如果一个服务必须以根用户的身份做一些事情，那么直接与远程计算机对话的那部分服务就不应该是根用户。

4.  用户不应该花太多时间作为根用户。在这本书里，我们大部分时间都是作为 root 用户度过的。相反，用户应该在自己的帐户下登录，然后使用`su`或`sudo`切换到 root 用户，获得临时 root 权限。

5.  你应该安装某种类型的服务拒绝程序，比如`fail2ban`，它会在一定次数的失败尝试后禁止来自特定 IP 地址的登录。

通过防止人们成为 root 用户，运行不以 root 用户身份运行的服务，以及保护 root 帐户免受外部访问，入侵者造成损害的能力大大降低。

大多数管理员使用`sudo`来管理对根用户的访问。`sudo`命令允许用户使用自己的密码临时访问根用户*，或者在登录后无需密码。它已经安装在你的机器上，允许任何属于`wheel`组的用户以根用户身份运行任何命令。要将一个用户(比如，`fred`)添加到`wheel`组，发出命令:*

```php
usermod -a -G wheel fred

```

现在，`fred`用户可以作为根用户运行任何命令，只需将`sudo`添加到命令的开头。例如，如果`fred`想要显示文件`/etc/sudoers`(`sudo`命令的配置文件)，Linux 通常不会允许他这样做。如果他做了`cat /etc/sudoers`，操作系统会给他一个错误。但是，如果`fred`在`wheel`组中，并且他发出了命令`sudo cat /etc/sudoers`，操作系统会要求他输入密码，并在重新验证他的身份后，为他运行该命令。

为了将`pssh`与`PermitRootLogin=no`一起使用，您需要使用`sudo`来切换用户。但是，`pssh`不喜欢交互，在要求用户输入密码时会出问题。因此，您需要修改`sudo`的默认配置，以便允许用户在不提供密码的情况下使用`sudo`(他们仍然需要密码才能登录)。为此，作为根用户，向`/etc/sudoers`添加下面一行:

```php
%wheel ALL=(ALL) NOPASSWD: ALL

```

现在，要使用`pssh`，您需要以`fred`和`sudo`的身份登录来执行您的系统管理命令，如下所示:

```php
pssh -A -h servers.txt --user fred sudo put_your_command_here

```

## 13.4 安装 Web 应用程序防火墙

web 应用程序防火墙是位于您的 web 应用程序和互联网之间的一个软件。web 应用程序防火墙的目的是检查传入流量中已知与恶意意图一致的模式，然后阻止这些请求。web 应用程序防火墙不能弥补 web 应用程序中糟糕的编程，但它通常会阻止自动化黑客工具找到漏洞。

Apache 为它提供了一个易于安装的 web 应用程序防火墙。要安装它，只需以 root 用户身份执行以下操作:

```php
yum install -y mod_security mod_security_crs
systemctl restart httpd

```

然而，对于我们的测试站点，web 应用程序防火墙可能会阻止使用 URL 中的 IP 地址的请求，因为这是许多黑客攻击的特征！事实上，我发现对于许多生产系统，我不得不禁用几个单独的规则来让 web 应用程序防火墙与我的应用程序一起工作。这可能是痛苦的，但总的来说这是值得做的。

web 应用防火墙将在日志文件`/var/log/httpd/error_log`中记录拒绝请求的规则。因此，您可以在日志中找到规则 ID 号，然后在配置中禁用它。只需将行`SecRuleRemoveById IDNUM`添加到文件`/etc/httpd/conf.d/mod_security.conf`中，禁用不需要的规则。

## 13.5 检查 Rootkits

一个 *rootkit* 是一个由入侵你的服务器的人安装的软件，它可以让你更容易地控制你的服务器进行邪恶的行为。如果你的服务器是安全的，就不太可能有人闯入，但是定期检查还是有好处的。

rootkit 检查的两个标准软件是`rkhunter`和`chkrootkit`。`rkhunter`目前是 EPEL 的一部分，可以安装:

```php
yum install -y rkhunter

```

要运行程序，只需做`rkhunter --check`。请注意，它可能会产生错误的警告和误报，因此请务必检查日志，以了解在查看问题时，它具体发现了什么。

## 13.6 其他安全软件

您可以安装和使用许多其他安全软件包。重要的是要知道有什么措施可用，并看看它们是否符合您的需求。

一些额外的 Linux 通用安全包包括

*   **logwatch** :该工具在记录到可疑活动时分析日志文件和电子邮件管理员。

*   这个程序寻找重复登录失败和其他可疑的行为，并将阻止看起来像他们试图闯入的 IP 地址。

*   安全增强的 Linux 是一种操作模式，在这种模式下，Linux 内核为程序提供了非常细粒度的访问控制，限制了每个程序和用户可以做的事情。SELinux 可以提供很多风险缓解，但是它的设置相当复杂，并且很容易意外地阻止您自己的应用程序做它们需要做的事情。我们在本书中禁用了 SELinux，因为它需要大量的配置问题。

*   这是本书中使用的标准防火墙管理应用程序。

*   **AuditD** :该程序查找并记录应用程序的可疑活动。

*   **远程系统日志**:这不是一个程序，但是系统日志可以配置为记录到远程服务器，这样入侵者就不能通过修改日志文件来掩盖他们的踪迹。

## 应用程序安全性

最难保护的是应用程序本身。实际上，如果不写另一本书，我无法提供很多建议。尽管如此，要记住的最重要的事情是

1.  防御性编码。

2.  验证来自用户的每一条数据。

3.  正确转义发送给用户的所有内容。

4.  在执行操作或显示数据之前，一定要仔细检查用户的权限。确保仅仅知道一个 URL 或一个参数不会自动给用户不适当的权力。

5.  对发送到外部命令或程序的任何内容都要非常小心。仔细检查你是否已经正确地转义或过滤了所有内容。

6.  想象一下，如果有人恶意操纵数据和请求，会发生什么。

7.  总是尝试使用“最佳实践”来编码(例如， [`https://phptherightway.com/`](https://phptherightway.com/) )。在编码时使用最佳实践可以避免其他人引入的安全问题，包括那些您后来在应用程序增长时不小心引入的问题，以及由于代码库中其他地方的更改而将当前安全的代码变成不安全的代码。

另外，请务必在 [`www.owasp.org`](http://www.owasp.org) 查看常见漏洞列表

为了保护您的服务器和应用程序，您可以也应该做许多其他的事情，但是希望这已经给了您一个需要考虑的事情的开始列表。PHP 有时会因为安全问题而获得不必要的坏名声。然而，其原因并不在于语言，而是因为它通常是安全经验较少的新 web 程序员学习的第一门语言。有一些资源可以帮助您开始这方面的工作，包括

1.  ****作者 Ben Edmunds** :这是一个简明扼要的 PHP 安全实践指南。**

***   Chris Snyder，Thomas Myer 和 Michael Southwell 撰写的***Pro PHP Security*****:这是一个更全面的关于 PHP 安全和安全原则的指南。这是一本较老的书，但核心安全原则没有改变。**

     *   ***掌握 Linux 安全并强化*** **作者 Donald Tevault** :如果你的服务器没有正确配置，编写安全的 PHP 代码对你没有任何帮助。

     *   ***实用信息安全管理*** **作者托尼·坎贝尔**:这本书将帮助你在更高层次上理解什么是安全的，什么是受保护的，如何管理权衡，以及安全的最终目标是什么。

     **

 **然而，最重要的事情是始终考虑您的应用程序如何被滥用，并始终学习新的方法来主动防范这些事情。**